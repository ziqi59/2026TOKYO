<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>2026æ—¥æœ¬éŠÙ©(ËŠá—œË‹*)Ùˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        /* é é¢è¼‰å…¥å‹•ç•« */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fadeIn 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        
        /* éš±è—æ²è»¸ä½†ä¿æŒæ»¾å‹•åŠŸèƒ½ */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* é«˜ç´šç´™å¼µç´‹ç†èˆ‡é»ç‹€èƒŒæ™¯ */
        .grain-overlay::before { content: ""; position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 50; opacity: 0.3; background-image: url("https://www.transparenttextures.com/patterns/natural-paper.png"); }
        .dot-grid { background-image: radial-gradient(#D6C5A0 0.5px, transparent 0.5px); background-size: 20px 20px; }
        
        * { -webkit-tap-highlight-color: transparent; outline: none; }
        
        .lucide-icon-wrapper svg { display: inline-block; vertical-align: middle; }
        
        .overlay-backdrop {
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }

        /* å…§å®¹å€å¢Šé«˜ï¼Œé¿å…è¢«åº•éƒ¨ 46px å°è¦½åˆ—é®æ“‹ */
        .content-padding { padding-bottom: 70px; }

        /* åº•éƒ¨å›ºå®šå°è¦½åˆ—æ¨£å¼ (æ¥µè‡´æ‰å¹³ 46px) */
        .fixed-nav {
            position: fixed; bottom: 0; left: 50%; transform: translateX(-50%);
            width: 100%; max-width: 390px; z-index: 100;
            background: #FFFFFF; display: flex; height: 46px; 
            border-top: 1px solid #EAE3D2; box-shadow: 0 -5px 25px rgba(0,0,0,0.05);
        }

        /* ä½¿æ»‘å‹•å€åŸŸåœ¨æ¡Œæ©Ÿå‘ˆç¾æŠ“å–æ‰‹å‹¢ */
        .cursor-grab { cursor: grab; }
        .cursor-grabbing { cursor: grabbing; }
    </style>
</head>
<body class="bg-[#DED9CE]">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        // --- 1. åŸºç¤å­çµ„ä»¶å®šç¾© ---

        const FujiIllustration = () => (
            <svg viewBox="0 0 200 100" className="w-14 h-auto opacity-20 text-[#8B5E3C]">
                <path d="M20,90 L100,20 L180,90 Z" fill="currentColor" />
                <path d="M80,37 L100,20 L120,37 Q100,45 80,37" fill="#FFFFFF" />
                <circle cx="160" cy="30" r="8" fill="#D6C5A0" />
            </svg>
        );

        const Icon = ({ name, size = 16, className = "" }) => {
            const [svgHtml, setSvgHtml] = useState("");
            useEffect(() => {
                let mounted = true;
                const renderIcon = () => {
                    if (!window.lucide || !window.lucide.icons) { setTimeout(renderIcon, 50); return; }
                    const iconMap = { 
                        "Flight": "Plane", "MapIcon": "Map", "ImageIcon": "Image", 
                        "Transport": "Train", "Sightseeing": "Star", "Food": "Utensils", 
                        "Shopping": "ShoppingBag", "Layout": "Layout", "Ticket": "Ticket", 
                        "Wallet": "Wallet", "Hotel": "Hotel", "ShoppingBag": "ShoppingBag",
                        "Tag": "Tag", "Check": "Check", "X": "X", "Link": "ExternalLink", 
                        "Navigation": "Navigation", "Zap": "Zap", "Utensils": "Utensils", 
                        "Package": "Package", "ChevronRight": "ChevronRight", 
                        "ChevronLeft": "ChevronLeft", "ChevronDown": "ChevronDown", "ChevronUp": "ChevronUp", 
                        "Info": "Info", "CreditCard": "CreditCard", "User": "User", "MapPin": "MapPin", "Map": "Map",
                        "Sparkles": "Sparkles", "ShoppingBasket": "ShoppingBasket", "Luggage": "Luggage", "Scan": "ScanFace", "QrCode": "QrCode"
                    };
                    const targetName = iconMap[name] || name;
                    const kebabName = targetName.replace(/([a-z0-9])([A-Z])/g, '$1-$2').toLowerCase();
                    const iconObj = window.lucide.icons[targetName] || window.lucide.icons[kebabName];
                    if (iconObj && typeof iconObj.toSvg === 'function' && mounted) { setSvgHtml(iconObj.toSvg({ width: size, height: size, class: className, 'stroke-width': 2 })); }
                };
                renderIcon(); return () => { mounted = false; };
            }, [name, size, className]);
            return <span className="lucide-icon-wrapper flex items-center justify-center shrink-0" dangerouslySetInnerHTML={{ __html: svgHtml }} />;
        };

        const WeatherDisplay = ({ lat, lon }) => {
            const [weather, setWeather] = useState({ temp: '--', icon: 'â˜¼' });
            
            const fetchWeather = async (retryCount = 0) => {
                try {
                    await new Promise(resolve => setTimeout(resolve, Math.random() * 1000));
                    const res = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current_weather=true`);
                    if (!res.ok) throw new Error("API Limit");
                    const data = await res.json();
                    const temp = Math.round(data.current_weather.temperature);
                    const code = data.current_weather.weathercode;
                    const isDay = data.current_weather.is_day; 
                    
                    let icon = isDay === 1 ? 'â˜¼' : 'â˜¾'; 
                    if ([1, 2, 3, 45, 48].includes(code)) icon = 'à¼„'; 
                    if ([51, 53, 55, 61, 63, 65, 80, 81, 82, 95, 96, 99].includes(code)) icon = 'â›ˆï¸'; 
                    if ([71, 73, 75, 77, 85, 86].includes(code)) icon = 'â…'; 
                    
                    setWeather({ temp: `${temp}Â°C`, icon });
                } catch (e) { 
                    if (retryCount < 3) setTimeout(() => fetchWeather(retryCount + 1), 3000);
                }
            };
            useEffect(() => { fetchWeather(); }, [lat, lon]);
            return (
                <div className="flex flex-col items-end border-l pl-3 border-[#F3EFE0] shrink-0 text-[#4A3728]">
                    <span className="text-xl font-bold leading-none mb-0.5">{weather.icon}</span>
                    <span className="text-[10px] font-bold">{weather.temp}</span>
                </div>
            );
        };

        const NavIconButton = ({ active, onClick, icon, label }) => (
            <button onClick={onClick} className={`flex-1 flex flex-col items-center justify-center transition-all duration-300 ${active ? 'bg-[#5D4037] text-[#FAF9F6]' : 'text-[#8E7D6A]'}`}>
                <Icon name={icon} size={18} className={`transition-transform duration-300 ${active ? 'scale-150' : 'scale-100 opacity-70'}`} />
                <span className="text-[8px] font-bold uppercase mt-0.5">{label}</span>
            </button>
        );

        // --- 2. å…¨åŸŸéœæ…‹è³‡æ–™å®šç¾© ---

        const travelers = [
            { id: 'goldfish', name: 'é‡‘é­š', color: '#8B5E3C', emoji: 'ğŸ ' },
            { id: 'penguin', name: 'ä¼éµ', color: '#5D4037', emoji: 'ğŸ§' },
            { id: 'zhi', name: 'é˜¿æ™º', color: '#A69076', emoji: 'ğŸ¦‰' },
            { id: 'spasm', name: 'ç—™æ”£', color: '#D6C5A0', emoji: 'âš¡' }
        ];

        const dates = [
            { date: '1/15', weekday: 'æœ¨', title: 'DAY 1 ê’° æ¢…ç”°æŠµé”:.ã€‚.â˜†', loc: { lat: 34.70, lon: 135.50, name: 'å¤§é˜ª' } },
            { date: '1/16', weekday: 'é‡‘', title: 'DAY 2 ê’° USJç’°çƒå½±åŸâ™¡ï¾', loc: { lat: 34.66, lon: 135.43, name: 'å¤§é˜ª' } },
            { date: '1/17', weekday: 'åœŸ', title: 'DAY 3 ê’° å¥ˆè‰¯äº¬éƒ½éŠğœ—ğœš ï½¡Ëš', loc: { lat: 35.01, lon: 135.76, name: 'äº¬éƒ½' } },
            { date: '1/18', weekday: 'æ—¥', title: 'DAY 4 ê’° å¤§é˜ª â³ æ–°å®¿ç§»å‹•', loc: { lat: 35.68, lon: 139.76, name: 'æ±äº¬' } },
            { date: '1/19', weekday: 'æœˆ', title: 'DAY 5 ê’° å¯Œå£«å±±æ²³å£æ¹– ê’±', loc: { lat: 35.49, lon: 138.76, name: 'å¯Œå£«' } },
            { date: '1/20', weekday: 'ç«', title: 'DAY 6 ê’° æ ‚æ± æ»‘é›ª Day-1 ê’±', loc: { lat: 36.64, lon: 138.19, name: 'é•·é‡' } },
            { date: '1/21', weekday: 'æ°´', title: 'DAY 7 ê’° æ ‚æ± æ»‘é›ª Day-2 ê’±', loc: { lat: 36.64, lon: 138.19, name: 'é•·é‡' } },
            { date: '1/22', weekday: 'æœ¨', title: 'DAY 8 ê’° æ¡ƒåœ’å¹³å®‰å›å®¶ ê’±', loc: { lat: 25.01, lon: 121.21, name: 'æ¡ƒåœ’' } },
        ];

        // åå¤§ç¥¨åˆ¸åº«
        const ticketsData = [
            { id: 'tk1', type: 'Flight', title: 'åœ‹æ³°èˆªç©º CX564 (å°åŒ—â†’å¤§é˜ª)', date: '1/15 11:15', assignments: { goldfish: { code: 'DGL2ET', seat: 'å¾…é¸' }, penguin: { code: 'DGL2ET', seat: 'å¾…é¸' }, zhi: { code: 'DH5MG7', seat: 'å¾…é¸' }, spasm: { code: 'DH5MG7', seat: 'å¾…é¸' } }, isVJW: true, vjwLink: 'https://www.vjw.digital.go.jp/' },
            { 
                id: 'tk2', 
                type: 'Pass', 
                title: 'é—œè¥¿åœ°å€éµè·¯å‘¨éŠåˆ¸', 
                date: '1/15', 
                isJR: true, 
                details: { 
                    no: '40376', 
                    card: '1668 (å¯¦é«”å¡)', 
                    authCode: 'è‡ªå‚™ 4 ç¢¼', 
                    passports: 'æ‰€æœ‰ä½¿ç”¨è€…è­·ç…§æ­£æœ¬ (4äºº)\n(å¯ä»¥æŠŠ1/18ç¥¨åˆ¸ä¸€åŒé ˜å–)', 
                    period: '1/15 - 1/17 æœ‰æ•ˆ', 
                    location: 'Kansai-airport (é—œè¥¿æ©Ÿå ´ç«™)', 
                    receiveInfo: 'è»Šç«™çª—å£æˆ–é©—ç¥¨å£å¤–å”®ç¥¨æ©Ÿ (ç¶ è‰²æ©Ÿå°å«è­·ç…§æƒæåŠŸèƒ½)',
                    receiveLink: 'https://www.westjr.co.jp/global/tc/howto/train-reservation/receive/',
                    notice: '1. å¿…é ˆåœ¨ 1/15 (å«) ä¹‹å‰é ˜å–ã€‚\n2. ä¸æ¥å—è™›æ“¬å¡ï¼Œéœ€å‡ºç¤ºçµå¸³å¯¦é«”ä¿¡ç”¨å¡ã€‚\n3. é©—ç¥¨å£å…§å”®ç¥¨æ©Ÿç„¡æ³•é ˜å–ã€‚' 
                } 
            },
            { 
                id: 'tk3', 
                type: 'Ticket', 
                title: 'USJ æ—¥æœ¬ç’°çƒå½±åŸé–€ç¥¨', 
                date: '1/16', 
                assignments: { 
                    goldfish: { img: 'https://lh3.googleusercontent.com/d/1OcyV3zuqQkXMTtOerNEoMBuXCuSxAoOK', fullTicketLink: 'https://drive.google.com/file/d/1jkOGLgJ0DdxtZUROKcBdze1v5wJGrzRx/view?usp=drive_link' }, 
                    penguin: { img: 'https://lh3.googleusercontent.com/d/1MzFWNFr9lKDFtwg902ziO4-KhLeKRPGL', fullTicketLink: 'https://drive.google.com/file/d/1kb5NzZjNu3yHEG7BcV3c8p_Pn0W15Irc/view?usp=drive_link' }, 
                    zhi: { img: 'https://lh3.googleusercontent.com/d/1ic2KFekF4jO403KVeLGMmOamFoxVcu7r', fullTicketLink: 'https://drive.google.com/file/d/1rfa4G0PfLSYoQnd2E8MHE3B80OQ47jkO/view?usp=drive_link' }, 
                    spasm: { img: 'https://lh3.googleusercontent.com/d/1P82cswIIyvEtvvVFIpb6Lj0sQqKBqyhq', fullTicketLink: 'https://drive.google.com/file/d/1kfnQYPmi3W68rJpuUA7j1BfltgtW1o8Q/view?usp=drive_link' } 
                },
                isUSJ: true,
                mapLink: 'https://drive.google.com/file/d/1PmA35rbRYDdi9hc0ClNl8p4RAioCT32x/view?usp=drive_link',
                notices: {
                    entry: '1. é€²é–€é¸ã€Œå¾å·¦åˆ°å³ç¬¬2é–€ã€å·¦æ’ï¼šäººå°‘é€Ÿåº¦æœ€å¿«ã€‚\n2. é€²åœ’å¾Œã€Œå¾€å³è¡ä¸‹æ¨“æ¢¯ã€ç›´å¥”ç‘ªåˆ©æ­ã€‚',
                    shopping: 'å–®ç­†æ»¿5,500å††å¯è¾¦é€€ç¨… (æ†‘ç™¼ç¥¨+è­·ç…§)ã€‚',
                    food: 'ã€Œæ˜Ÿæ˜Ÿçˆ†ç±³èŠ±æ¡¶ã€åœ¨å¤§é–€å¤§è¡—è²·æ¯”åœ’å€å¿«ã€‚',
                    storage: 'å¼·åˆ¶å¯„ç‰©ï¼šå¥½èŠå¡¢ç¾å¤¢ã€SPYã€å“ˆåˆ©æ³¢ç‰¹ã€é£›å¤©ç¿¼é¾ã€‚'
                }
            },
            { 
                id: 'tk4', 
                type: 'Train', 
                title: 'æ–°å¹¹ç·š Nozomi 2 (æ–°å¤§é˜ªâ†’å“å·)', 
                date: '1/18 08:30', 
                assignments: { zhi: { seat: '13è™Ÿè»Š 1è™Ÿ Bä½' }, spasm: { seat: '13è™Ÿè»Š 1è™Ÿ Cä½' }, penguin: { seat: '13è™Ÿè»Š 1è™Ÿ Dä½' }, goldfish: { seat: '13è™Ÿè»Š 1è™Ÿ Eä½' } },
                isNozomi: true,
                details: { no: '49329', card: '1668 (å¯¦é«”å¡)', authCode: 'è‡ªå‚™ 4 ç¢¼', period: '1/18 æœ‰æ•ˆ', location: 'æ–°å¤§é˜ªç«™ (çª—å£æˆ–é©—ç¥¨å£å¤–å”®ç¥¨æ©Ÿ)', receiveLink: 'https://www.westjr.co.jp/global/tc/howto/train-reservation/receive/', notice: '1. é ˜å–è»Šç¥¨å¾Œæ–¹å¯ä¸Šè»Šã€‚\n2. è®Šæ›´åƒ…é™ 1 æ¬¡ã€‚' }
            },
            { id: 'tk5', type: 'Bus', title: 'é«˜é€Ÿå·´å£« å¾€ç¨‹ (1101 ç­æ¬¡)', date: '1/19 07:15', isHighwayBus: true, details: { no: '1101', busNo: '1', route: 'æ–°å®¿ç¸½ç«™ â” å¯Œå£«å±±ç«™', tickets: 'å¤§äºº 4 äºº', link: 'https://www.highwaybus.com/gp/inbound/inbWebticketPrint?3646e9862c4c4fbcfc3636dd722fb157&lang=CZ1&ticket_type=mobile#1', notice: 'è«‹é»é¸ä¸‹æ–¹é€£çµç™¼è¡Œ Web Ticketã€‚' } },
            { id: 'tk6', type: 'Bus', title: 'é«˜é€Ÿå·´å£« è¿”ç¨‹ (1124 ç­æ¬¡)', date: '1/19 16:40', isHighwayBus: true, details: { no: '1124', busNo: '1', route: 'æ²³å£æ¹–ç«™ â” æ–°å®¿ç¸½ç«™', tickets: 'å¤§äºº 4 äºº', link: 'https://www.highwaybus.com/gp/inbound/inbWebticketPrint?3646e9862c4c4fbcfc3636dd722fb157&lang=CZ1&ticket_type=mobile#2', notice: 'è«‹é»é¸ä¸‹æ–¹é€£çµç™¼è¡Œ Web Ticketã€‚' } },
            { id: 'tk7', type: 'Train', title: 'æ–°å¹¹ç·š Kagayaki 519 (æ±äº¬â†’é•·é‡)', date: '1/19 21:04', assignments: { zhi: { seat: '6è™Ÿè»Š 17è™Ÿ Dä½' }, spasm: { seat: '6è™Ÿè»Š 17è™Ÿ Eä½' }, penguin: { seat: '6è™Ÿè»Š 18è™Ÿ Dä½' }, goldfish: { seat: '6è™Ÿè»Š 18è™Ÿ Eä½' } } },
            { id: 'tk8', type: 'Train', title: 'æ–°å¹¹ç·š Kagayaki 504 (é•·é‡â†’ä¸Šé‡)', date: '1/22 09:17', assignments: { zhi: { seat: '8è™Ÿè»Š 18è™Ÿ Dä½' }, spasm: { seat: '8è™Ÿè»Š 18è™Ÿ Eä½' }, penguin: { seat: '8è™Ÿè»Š 19è™Ÿ Dä½' }, goldfish: { seat: '8è™Ÿè»Š 19è™Ÿ Eä½' } } },
            { 
                id: 'tk9', 
                type: 'Ticket', 
                title: 'Skyliner (æ©Ÿå ´å¿«ç·š)', 
                date: '1/22 11:05', 
                isSkyliner: true,
                // æ›´æ–°ï¼šä½¿ç”¨ Embed ç›´é€£æ ¼å¼ç¢ºä¿åœ–ç‰‡èƒ½é¡¯ç¤º
                currentImg: 'https://lh3.googleusercontent.com/d/1TqPXatdp3FU501uBio-4ahi6SJIRKEua',
                details: {
                    no: '91-140767261',
                    pin: '5872',
                    adults: '4 äºº',
                    validity: '2026/02/02',
                    representative: 'CHIHTZUCHI',
                    route: 'æ—¥æš®é‡Œ â” æˆç”°æ©Ÿå ´ 2/3 èˆªå»ˆ',
                    notice: '1. å‡ºç¤º QR ç¢¼æˆ–è³¼è²·è©³æƒ…é é¢å…Œæ›ã€‚\n2. è‹¥ä½¿ç”¨è‡‰éƒ¨è¾¨è­˜æœå‹™ (Go)å‰‡ç„¡éœ€æ›ç¥¨ï¼Œç›´æ¥å‰å¾€å°ˆå±¬é–˜æ©Ÿã€‚'
                }
            },
            { id: 'tk10', type: 'Flight', title: 'åœ‹æ³°èˆªç©º CX451 (å›ç¨‹)', date: '1/22 15:30', assignments: { goldfish: { code: 'CX451', seat: 'å¾…é¸' }, penguin: { code: 'CX451', seat: 'å¾…é¸' }, zhi: { code: 'CX451', seat: 'å¾…é¸' }, spasm: { code: 'CX451', seat: 'å¾…é¸' } }, note: 'å›ç¨‹ CX451' }
        ];

        // å®Œæ•´è¡Œç¨‹è³‡æ–™
        const defaultTripData = [
                // 1/15 DAY 1
                { id: '15_1', dateIndex: 0, startTime: '11:15', name: 'æ­ä¹˜åœ‹æ³°èˆªç©º', address: 'æ¡ƒåœ’æ©Ÿå ´', category: 'Flight', note: '11:15-14:55\nå°åŒ—ä¸€èˆªâ†’ å¤§é˜ªä¸€èˆª' },
                { id: '15_2', dateIndex: 0, startTime: '16:00', name: 'å‡ºæµ·é—œ', address: 'é—œè¥¿æ©Ÿå ´ç¬¬ä¸€èˆªå»ˆ', category: 'Sightseeing', note: '' },
                { id: '15_3', dateIndex: 0, startTime: '16:30', name: 'æ­ä¹˜JR HARUKAç‰¹æ€¥', address: 'é—œè¥¿æ©Ÿå ´JR HARUKAæœˆå°', category: 'Transport', note: 'ä½¿ç”¨é—œè¥¿åœ°å€éµè·¯å‘¨éŠåˆ¸ è‡ªç”±å¸­' },
                { id: '15_4', dateIndex: 0, startTime: '17:20', name: 'æ¢…ç”°è³¼ç‰©', address: 'JR æ¢…ç”°', category: 'Shopping', note: '' },
                { id: '15_5', dateIndex: 0, startTime: 'æ™šé¤', name: 'é è¨ˆç‡’è‚‰è‚‰äº”éƒ', address: 'ç‡’è‚‰ è‚‰äº”éƒ å¤©æ»¿åº—', category: 'Food', note: 'ç‡Ÿæ¥­æ™‚é–“11:00-23:00\nJRå¤§é˜ªç’°ç‹€ç·šå¤©æ»¿ç«™æ­¥è¡Œ3åˆ†é˜' },
                { id: '15_6', dateIndex: 0, startTime: 'ä½å®¿', name: 'å¤§é˜ªä½è™•', address: 'Apartment Hotel 11 Higashi Umeda', category: 'Hotel', note: '' },

                // 1/16 DAY 2
                { id: '16_1', dateIndex: 1, startTime: '06:40', name: 'é£¯åº—å‡ºç™¼', address: 'JR å¤§é˜ªç«™', category: 'Transport', note: 'æ­¥è¡Œç´„ 12 åˆ†é˜è‡³JRå¤§é˜ªç«™\nJRå¤§é˜ªç«™â†’è¥¿ä¹æ¢ç«™ æ­ä¹˜:JRå¤§é˜ªç’°ç‹€ç·š\næ—©é¤é è¨ˆåƒ711' },
                { id: '16_2', dateIndex: 1, startTime: '07:40', name: 'æŠµé”ç’°çƒ', address: 'USJç’°çƒå½±åŸ', category: 'Sightseeing', note: 'å…¥åœ’ç›´è¡é¦¬åŠ›æ­åœ’å€\n\nã€å…¥åœ’é ˆçŸ¥ã€‘\n1.ææ—©ä¸‹è¼‰å®˜æ–¹Appä¸¦è¨»å†Šã€‚\n2.å…¥åœ’å¾Œç«‹å³æŠ½å–æ•´ç†åˆ¸ã€‚\n3.å»ºè­°7:00å‰æŠµé”ç¾å ´æ’éšŠã€‚\n4.ç¦å¸¶å¤–é£Ÿã€‚' },
                { id: '16_3', dateIndex: 1, startTime: '20:00', name: 'é–‰åœ’æ™‚é–“', address: 'è¶…å¸‚', category: 'Food', note: 'æ™šé¤é è¨ˆåƒè¶…å¸‚' },
                { id: '16_4', dateIndex: 1, startTime: 'ä½å®¿', name: 'å¤§é˜ªä½è™•', address: 'Apartment Hotel 11 Higashi Umeda', category: 'Hotel', note: '' },

                // 1/17 DAY 3
                { id: '17_1', dateIndex: 2, startTime: '07:40', name: 'é£¯åº—å‡ºç™¼', address: 'JR å¤§é˜ªç«™', category: 'Transport', note: 'æ­¥è¡Œç´„ 12 åˆ†é˜è‡³JRå¤§é˜ªç«™\nå¤§é˜ªç«™â†’ å¥ˆè‰¯ç«™ æ­ä¹˜:JRå¤§å’Œè·¯å¿«é€Ÿ(50min)\næ—©é¤é è¨ˆåƒ711' },
                { id: '17_2', dateIndex: 2, startTime: '08:50', name: 'å‰å¾€å¥ˆè‰¯å…¬åœ’', address: 'JR å¥ˆè‰¯ç«™', category: 'Transport', note: 'JRå¥ˆè‰¯ç«™æ±å£â†’ã€Œå¥ˆè‰¯å…¬åœ’å‰ã€ æˆ– ã€ŒçœŒåºå‰ã€ ä¸‹è»Š' },
                { id: '17_3', dateIndex: 2, startTime: '09:00', name: 'é¤µé¹¿æ•£æ­¥', address: 'å¥ˆè‰¯å…¬åœ’', category: 'Sightseeing', note: 'é è¨ˆ10:30çµæŸ\nå¥ˆè‰¯å…¬åœ’â†’ JRå¥ˆè‰¯ç«™(èµ°20min)' },
                { id: '17_4', dateIndex: 2, startTime: '11:00', name: 'å‰å¾€äº¬éƒ½', address: 'JR å¥ˆè‰¯ç«™', category: 'Transport', note: 'JRå¥ˆè‰¯ç«™â†’ JRäº¬éƒ½ç«™ æ­ä¹˜:JR å¥ˆè‰¯ç·šå¿«é€Ÿ(45min)' },
                { id: '17_5', dateIndex: 2, startTime: '12:00', name: 'éŒ¦å¸‚å ´åƒåˆé¤', address: 'éŒ¦å¸‚å ´', category: 'Food', note: 'äº¬éƒ½ç«™â†’ å››æ¡ç«™ æ­ä¹˜:äº¬éƒ½å¸‚ç‡Ÿåœ°ä¸‹éµçƒä¸¸ç·š(4min)\nå››æ¡ç«™â†’ éŒ¦å¸‚å ´(èµ°5min)' },
                { id: '17_6', dateIndex: 2, startTime: '13:30', name: 'é€›è¡—', address: 'äºŒå¹´å‚ ä¸‰å¹´å‚', category: 'Shopping', note: 'èŠ±è¦‹å°è·¯ã€äºŒå¹´å‚ ä¸‰å¹´å‚ æ•£æ­¥\né è¨ˆ18:20é›¢é–‹' },
                { id: '17_7', dateIndex: 2, startTime: '19:00', name: 'å…­è§’ACE', address: 'å…­è§’ACE', category: 'Food', note: 'âœ§çƒä¸¸å¾¡æ± ç«™ 5è™Ÿå‡ºå£å·¦è½‰ï¼Œæ­¥è¡Œ10min â¸â¸âœ§17:00-23:00\nâœ©â€”aceã®ãƒãƒ†ã‚µãƒ© 580å†† ç³–å¿ƒè›‹é¦¬éˆ´è–¯\nâœ©â€”ãƒãƒ©ãƒŸã‚¹ãƒ†ãƒ¼ã‚­ 1180å†† è£™å­ç‰›æ’\nâœ©â€”ã¨ã†ã‚‚ã‚ã“ã—ã®å”æš 600å†† ç‚¸ç‰ç±³\nâœ©â€”ã‚­ã‚¦ã‚¤ã‚µãƒ¯ãƒ¼ 580å†† å¥‡ç•°æœæ²™ç“¦' },
                { id: '17_8', dateIndex: 2, startTime: '20:30', name: 'å›æ¢…ç”°', address: 'JR äº¬éƒ½ç«™', category: 'Transport', note: 'äº¬éƒ½ â†’ æ¢…ç”° æ­ä¹˜:JR äº¬éƒ½ç·šï¼ˆæ–°å¿«é€Ÿï¼‰(30min)' },
                { id: '17_9', dateIndex: 2, startTime: 'ä½å®¿', name: 'å¤§é˜ªä½è™•', address: 'Apartment Hotel 11 Higashi Umeda', category: 'Hotel', note: 'ä»Šå¤©è¦æ•´ç†è¡Œæå•¦' },

                // 1/18 DAY 4
                { id: '18_1', dateIndex: 3, startTime: '08:00', name: 'é£¯åº—å‡ºç™¼(å¸¶è¡Œæ)', address: 'æ–°å¤§é˜ªç«™', category: 'Transport', note: '08:30æ–°å¤§é˜ªâ†’ 10:49å“å· æ­ä¹˜:æ±æµ·é“æ–°å¹¹ç·š Nozomi 13è™Ÿè»Š\nå“å· â†’ æ–°å®¿ æ­ä¹˜:å±±æ‰‹ç·š æ–¼åŒ—è½‰ä¹˜å£ 2è™Ÿæœˆå°' },
                { id: '18_2', dateIndex: 3, startTime: '12:00', name: 'å¯„æ”¾è¡Œæ', address: 'Shinjuku sprem', category: 'Hotel', note: 'å…ˆå›é£¯åº—å¯„æ”¾è¡Œæ èµ°è·¯10min' },
                { id: '18_3', dateIndex: 3, startTime: 'åˆé¤', name: 'èˆ‡ç¾å„ªåƒé£¯', address: 'åœ°é»å°šæœªæ±ºå®š', category: 'Food', note: 'æ±ºå®šå¥½åœ¨æ‰“ä¸Šä¾†' },
                { id: '18_4', dateIndex: 3, startTime: 'æ™šé¤', name: 'å°šæœªæ±ºå®š', address: 'åœ°é»å°šæœªæ±ºå®š', category: 'Food', note: 'æ±ºå®šå¥½åœ¨æ‰“ä¸Šä¾†' },
                { id: '18_5', dateIndex: 3, startTime: 'ä½å®¿', name: 'æ–°å®¿ä½è™•', address: 'Shinjuku sprem', category: 'Hotel', note: 'æ¨“å±¤3æ¨“\nä»Šå¤©è¦æ—©ç¡+æ•´ç†è¡Œæ' },

                // 1/19 DAY 5
                { id: '19_1', dateIndex: 4, startTime: '06:50', name: 'å‡ºç™¼æ­å·´å£«', address: 'æ–°å®¿å·´å£«ç¸½ç«™', category: 'Transport', note: '07:15æ–°å®¿å·´å£«ç¸½ç«™â†’ 09:07å¯Œå£«å±±é§… æ­ä¹˜:é«˜é€Ÿå·´å£« è»Šæ¬¡ç·¨è™Ÿ1101\nå¯Œå£«å±±é§… â†’ä¸‹å‰ç”°é§… æ­ä¹˜: è¨ˆç¨‹è»Š Â¥1,200 (8åˆ†é˜)' },
                { id: '19_2', dateIndex: 4, startTime: '09:20', name: 'ä¸‹å‰ç”° æœ¬ç”ºé€š', address: 'æœ¬ç”ºé€š', category: 'Sightseeing', note: 'æ‹å¯Œå£«å±±è¡—æ™¯\nå‘æ–°å€‰å±±æ·ºé–“å…¬åœ’èµ°å»' },
                { id: '19_3', dateIndex: 4, startTime: '10:00', name: 'æ–°å€‰å±±æ·ºé–“å…¬åœ’', address: 'å¿ éˆå¡”', category: 'Sightseeing', note: 'è¦çˆ¬80å±¤æ¨“æ¢¯\næœ±å°è³‡è¨Šç¨å¾Œæ‰“ä¸Š' },
                { id: '19_4', dateIndex: 4, startTime: 'åˆé¤', name: 'æœ¬ç”ºé€šå‘¨é‚Šæ¼«æ­¥', address: 'æœ¬ç”ºé€š', category: 'Food', note: 'åˆ°è™•åƒåƒé€›é€›\næ¨è–¦ç¾é£Ÿç¨å¾Œæ‰“ä¸Š' },
                { id: '19_5', dateIndex: 4, startTime: '12:30', name: 'å‰å¾€æ²³å£æ¹–', address: 'ä¸‹å‰ç”°ç«™', category: 'Transport', note: 'ä¸‹å‰ç”° â†’æ²³å£æ¹–ç«™ æ­ä¹˜:å¯Œå£«æ€¥è¡Œç·š' },
                { id: '19_6', dateIndex: 4, startTime: '13:00', name: 'å¯Œå£«å±±å…¨æ™¯çºœè»Š', address: 'å¯Œå£«å±±å…¨æ™¯çºœè»Š', category: 'Sightseeing', note: 'ç¢ºä¿åœ¨æ—¥è½å‰èƒ½å®Œæˆçºœè»Šå’Œå±±é ‚è§€æ™¯ï¼Œé¿å…è¢«é€†å…‰é™°å½±é®æ“‹ã€‚\nç¥¨åˆ¸è³‡è¨Šç¨å¾Œè£œä¸Š' },
                { id: '19_7', dateIndex: 4, startTime: '16:20', name: 'å‰å¾€æ²³å£æ¹–å·´å£«ç«™', address: 'æ²³å£æ¹–å·´å£«ç«™', category: 'Transport', note: '16:40æ²³å£æ¹–é§… â†’18:25æ–°å®¿å·´å£«ç¸½ç«™ æ­ä¹˜:é«˜é€Ÿå·´å£« è»Šæ¬¡ç·¨è™Ÿ1124' },
                { id: '19_8', dateIndex: 4, startTime: '18:40', name: 'é ˜è¡Œæ&åƒæ™šé¤', address: 'Shinjuku sprem', category: 'Food', note: 'å›é£¯åº—é ˜è¡Œæã€åƒç°¡å–®æ™šé¤(è¶•çš„è©±è²·å»è»Šä¸Šåƒ)' },
                { id: '19_9', dateIndex: 4, startTime: '20:30', name: 'è½‰é»æ±äº¬è»Šç«™', address: 'æ–°å®¿ç«™', category: 'Transport', note: 'æ–°å®¿â†’æ±äº¬ æ­ä¹˜:JR ä¸­å¤®ç·šå¿«é€Ÿ\nèµ°åˆ°æ–°å¹¹ç·šæœˆå°ç´„ 5â€“15 åˆ†' },
                { id: '19_10', dateIndex: 4, startTime: '21:00', name: 'æ­å»é•·é‡', address: 'æ±äº¬ç«™', category: 'Transport', note: '21:04æ±äº¬Tokyoâ†’ 22:23é•·é‡Nagano æ­ä¹˜:Kagayaki 519\nèµ°åˆ°æ–°å¹¹ç·šæœˆå°ç´„ 5â€“15 åˆ†' },
                { id: '19_11', dateIndex: 4, startTime: 'ä½å®¿', name: 'é•·é‡ä½è™•', address: 'Sotetsu Fresa Inn', category: 'Hotel', note: 'å–„å…‰å¯ºå£ æ­¥è¡Œç´„ 2 åˆ†é˜' },

                // 1/20 DAY 6
                { id: '20_1', dateIndex: 5, startTime: '08:00', name: 'é£¯åº—å‡ºç™¼ç§Ÿè»Š', address: 'Toyota Rent-A-Car', category: 'Transport', note: 'èµ°è·¯15åˆ†é˜\nç§Ÿè»Šæ³¨æ„äº‹é …' },
                { id: '20_2', dateIndex: 5, startTime: '08:40', name: 'è‡ªé§•è‡³æ ‚æ± é«˜åŸæ»‘é›ªå ´', address: 'æ ‚æ± é«˜åŸæ»‘é›ªå ´', category: 'Sightseeing', note: 'æ—¥é–“æ»‘é›ª 08:00 è‡³ 17:00\næ»‘é›ªæ³¨æ„äº‹é …' },
                { id: '20_3', dateIndex: 5, startTime: 'æ™šé¤', name: 'å°šæœªæ±ºå®š', address: 'åœ°é»å°šæœªæ±ºå®š', category: 'Food', note: 'æ±ºå®šå¥½åœ¨æ‰“ä¸Šä¾†' },
                { id: '20_4', dateIndex: 5, startTime: 'ä½å®¿', name: 'é•·é‡ä½è™•', address: 'Sotetsu Fresa Inn', category: 'Hotel', note: 'å–„å…‰å¯ºå£ æ­¥è¡Œç´„ 2 åˆ†é˜' },

                // 1/21 DAY 7
                { id: '21_1', dateIndex: 6, startTime: '08:00', name: 'è‡ªé§•è‡³æ ‚æ± é«˜åŸæ»‘é›ªå ´', address: 'æ ‚æ± é«˜åŸæ»‘é›ªå ´', category: 'Sightseeing', note: 'æ—¥é–“æ»‘é›ª 08:00 è‡³ 17:00\næ»‘é›ªæ³¨æ„äº‹é …' },
                { id: '21_2', dateIndex: 6, startTime: 'åˆé¤', name: 'å°šæœªæ±ºå®š', address: 'æ ‚æ± é«˜åŸæ»‘é›ªå ´', category: 'Food', note: 'æ±ºå®šå¥½åœ¨æ‰“ä¸Šä¾†' },
                { id: '21_3', dateIndex: 6, startTime: '20:00', name: 'é‚„è»Š', address: 'Toyota Rent-A-Car', category: 'Transport', note: 'è¦è¨˜å¾—åŠ æ»¿æ²¹' },
                { id: '21_4', dateIndex: 6, startTime: 'æ™šé¤', name: 'å°šæœªæ±ºå®š', address: 'åœ°é»å°šæœªæ±ºå®š', category: 'Food', note: 'æ±ºå®šå¥½åœ¨æ‰“ä¸Šä¾†' },
                { id: '21_5', dateIndex: 6, startTime: 'ä½å®¿', name: 'é•·é‡ä½è™•', address: 'Sotetsu Fresa Inn', category: 'Hotel', note: 'å–„å…‰å¯ºå£ æ­¥è¡Œç´„ 2 åˆ†é˜\nä»Šå¤©è¦æ•´ç†è¡Œæ' },

                // 1/22 DAY 8
                { id: '22_1', dateIndex: 7, startTime: '09:00', name: 'JRé•·é‡æ­è»Š', address: 'JRé•·é‡ç«™', category: 'Transport', note: '09:17é•·é‡Naganoâ†’10:31ä¸Šé‡Ueno æ­ä¹˜:Kagayaki 504' },
                { id: '22_2', dateIndex: 7, startTime: '10:45', name: 'æ—¥æš®é‡Œè½‰ä¹˜', address: 'JRä¸Šé‡', category: 'Transport', note: '10:47 JRä¸Šé‡Uenoâ†’ 10:50 JRæ—¥æš®é‡ŒNippori' },
                { id: '22_3', dateIndex: 7, startTime: '11:05', name: 'å‰å¾€æˆç”°æ©Ÿå ´', address: 'JRæ—¥æš®é‡Œ', category: 'Transport', note: 'æ—¥æš®é‡ŒNippori â†’ æˆç”°æ©Ÿå ´ æ­ä¹˜:Skyliner\n\nã€æ³¨æ„äº‹é …ã€‘\n1.æŒQR Codeè‡³å”®ç¥¨æ©Ÿæ›å¯¦é«”ç¥¨ã€‚\n2.æ—¥æš®é‡Œè½‰ä¹˜éœ€ç¶“éå°ˆç”¨æ”¹æœ­å£ã€‚' },
                { id: '22_4', dateIndex: 7, startTime: '12:30', name: 'æˆç”°æ©Ÿå ´é€›ä¼´æ‰‹ç¦®', address: 'æˆç”°æ©Ÿå ´', category: 'Shopping', note: 'é è¨ˆ13:30éæµ·é—œ' },
                { id: '22_5', dateIndex: 7, startTime: 'ä½å®¿', name: 'é•·é‡ä½è™•', address: 'Sotetsu Fresa Inn', category: 'Hotel', note: 'å–„å…‰å¯ºå£ æ­¥è¡Œç´„ 2 åˆ†é˜\nä»Šå¤©è¦æ•´ç†è¡Œæ' },
                { id: '22_6', dateIndex: 7, startTime: '15:30', name: 'æ­ä¹˜åœ‹æ³°èˆªç©º', address: 'æ±äº¬æ©Ÿå ´', category: 'Flight', note: '15:30-18:40\næ±äº¬äºŒèˆªâ†’ å°åŒ—ä¸€èˆª\nåœ‹æ³°CX451 æ³¢éŸ³ 777-300' }
            ];

        // ä½å®¿è³‡æ–™å®šç¾©
        const staysData = [
            { name: 'Hotel Vischio Osaka', period: '1/15 - 1/18 (3æ™š)', checkIn: '15:00', checkOut: '11:00', distance: 'JR å¤§é˜ªç«™å¾’æ­¥ 5 åˆ†', note: 'æ¢…ç”°ç²¾è¯å€ï¼Œæ¨“ä¸‹æœ‰è¶…å•†ï¼Œäº¤é€šæ¥µä¾¿' },
            { name: 'Tokyo Shinjuku Hotel', period: '1/18 - 1/19 (1æ™š)', checkIn: '15:00', checkOut: '10:00', distance: 'æ–°å®¿ç«™å¾’æ­¥ 8 åˆ†', note: 'æ–¹ä¾¿éš”å¤©æ¸…æ™¨å‰å¾€æ–°å®¿å·´å£«ç¸½ç«™' },
            { name: 'Nagano Hakuba Lodge', period: '1/19 - 1/22 (3æ™š)', checkIn: '15:00', checkOut: '10:00', distance: 'æ ‚æ± æ»‘é›ªå ´æ¥é§è»Š 5 åˆ†', note: 'å«æ—©æ™šé¤ï¼Œæ»‘é›ªè£å‚™å¯å­˜æ”¾æ–¼ B1' }
        ];

        const drugstoreMasterData = [
            { id: 'p1_vitc', name: 'æ­¦ç”°è£½è—¥ ç¶­ä»–å‘½CéŒ  (300éŒ )', category: 'è—¥å¦', img: 'https://lh3.googleusercontent.com/d/1XzQ0ob4I9EvhvrmRWXz1YEbHhJqVkRBs', intro: 'è£œå……Cèˆ‡éˆ£è³ªï¼Œç·©è§£ç–²å‹', price: 'Â¥3,000', store: 'æ¾æœ¬æ¸…ã€Aeon', purchased: false, type: 'Product' },
            { id: 'p2_repair', name: 'ç¬¬ä¸€ä¸‰å…± Oivalux PZ ä¿®å¾©ä¹³è†', category: 'è—¥å¦', img: 'https://lh3.googleusercontent.com/d/1oUmOZHN_mmsOGcSyWsCntw-RjDboDuL9', intro: 'æ­¢ç™¢æŠ—ç‚ï¼Œä¿®å¾©çš®è†šç‚', price: 'Â¥2,000', store: 'æ¾æœ¬æ¸…ã€Sun Drug', purchased: false, type: 'Product' },
            { id: 'p3_patch', name: 'å°æ—é€€ç†±è²¼', category: 'è—¥å¦', img: 'https://lh3.googleusercontent.com/d/1gzHSDr1XnQV7Zl3KTDR_NGthysTnqaQI', intro: 'ç¬é–“é™æº«æ•£ç†±', price: 'Â¥500', store: 'å„å¤§è—¥å¦åº—', purchased: false, type: 'Product' },
            { id: 'bz1', name: 'TAKAMI è§’è³ªé“å°è—ç“¶ 30ml', category: 'ç¾å¦', img: 'https://lh3.googleusercontent.com/d/1iQaypfEWu7Epb15xOiL7KfuvEAYMuhdg', intro: 'æº«å’Œä»£è¬è§’è³ª', price: 'Â¥5,500', store: 'Loftã€@cosme', purchased: false, type: 'Product' },
            { id: 'bz2', name: 'TOKIO IE éŠ€ç³»åˆ— (äº¬å–šç¾½)', category: 'ç¾å¦', img: 'https://lh3.googleusercontent.com/d/1xgrQ2oGVrmyL4ILz5-LjVPJvQt3t1xA-', intro: 'ä¿®è­·å—æï¼Œè¼•ç›ˆæ°´æ½¤', price: 'Â¥5,160', store: 'å”å‰è¨¶å¾·', purchased: false, type: 'Product' },
            { id: 'bz3', name: 'KISSME èŠ±æ¼¾ç¾å§¬ ç«æ¯›ç²¾è¯æ¶² EX', category: 'ç¾å¦', img: 'https://lh3.googleusercontent.com/d/1nXqvRFGlYX4tKawzQMOgmI_v6EqmhEkT', intro: 'å¼·éŸŒç«æ¯›æ»‹é¤Š', price: 'Â¥1,300', store: 'æ¾æœ¬æ¸…', purchased: false, type: 'Product' },
            { id: 'bz4', name: 'Melano CC é…µç´ æ½”é¢ä¹³', category: 'ç¾å¦', img: 'https://lh3.googleusercontent.com/d/10BcW1FLuMXCxprOaNuCXBEURHAa39OrA', intro: 'æ¸…æ½”æ¯›å­”', price: 'Â¥700', store: 'å”å‰è¨¶å¾·', purchased: false, type: 'Product' },
            { id: 'bz5', name: 'd program æ•æ„Ÿè©±é¡Œæ½”è†šä¹³N', category: 'ç¾å¦', img: 'https://lh3.googleusercontent.com/d/1E4D8_GvX5_DJ88Q9fwKAk5CTE4-EKxLy', intro: 'æ•æ„Ÿè‚Œå°ˆç”¨', price: 'Â¥2,800', store: 'å„å¤§è—¥å¦åº—', purchased: false, type: 'Product' },
            { id: 'f1_spice', name: 'ã»ã‚Šã«ã— (Horinishi) å…¨èƒ½é¦™æ–™', category: 'é£Ÿ', img: 'https://lh3.googleusercontent.com/d/1w85IBpOkUecKW0UGKpKiolCopIcG9QHC', intro: 'è’œå‘³æ¿ƒéƒ', price: 'Â¥900', store: 'æˆåŸçŸ³äº•', purchased: false, type: 'Product' },
            { id: 'f2_soy', name: 'ç‰¡è £é«˜æ¹¯é†¬æ²¹', category: 'é£Ÿ', img: 'https://lh3.googleusercontent.com/d/1SPKVZ43kGDi8F83dloMJUpDgPUZEe-Lq', intro: 'ç”˜é®®ç‰¡è £èƒå–', price: 'Â¥450', store: 'å„å¤§è¶…å¸‚', purchased: false, type: 'Product' },
            { id: 'f3_chicken', name: 'åšå¤šè¯å‘³é³¥ æ¥µé¦™æ–™', category: 'é£Ÿ', img: 'https://lh3.googleusercontent.com/d/1ZO4g64JXWyxQ3jxQ2NVvGVgEwHjd0oWJ', intro: 'ååº—ç›£è£½', price: 'Â¥600', store: 'Lifeè¶…å¸‚', purchased: false, type: 'Product' },
            { id: 'muji1', name: 'ç„¡å°è‰¯å“ ç¡çœ å™´éœ§ (Sleeping Blend)', category: 'å…¶ä»–', img: 'https://lh3.googleusercontent.com/d/1jXMhO_l6vTbBkqObVy75ohIxERYm9Lm1', intro: 'åŠ©çœ æ”¾é¬†æ°£æ¯', price: 'Â¥1,700', store: 'æ—¥æœ¬ç„¡å°è‰¯å“', purchased: false, type: 'Product' },
            { id: 'muji2', name: 'ä¸é½é‹¼å‰Šçš®åˆ€', category: 'å…¶ä»–', img: 'https://lh3.googleusercontent.com/d/1elsHjWgujGwgUPGBsegUlm5yEWRsHM4r', intro: 'ä¸é½é‹¼è€ç£¨å¥½æ´—', price: 'Â¥900', store: 'æ—¥æœ¬ç„¡å°è‰¯å“å°ˆé–€åº—', purchased: false, type: 'Product' }
        ];

        const accIconsMap = { 'ç¾é£Ÿ': 'ğŸ¥', 'äº¤é€š': 'ğŸšƒ', 'è¶…å•†': 'ğŸ™', 'ç¥¨åˆ¸': 'ğŸŸï¸', 'å…¶ä»–': 'ğŸ€', 'åŸºé‡‘': 'ğŸ¦', 'ç½°æ¬¾': 'âš–ï¸' };

        // --- 3. App ä¸»çµ„ä»¶ ---

        const App = () => {
            const [currentTab, setCurrentTab] = useState('itinerary');
            const [activeTraveler, setActiveTraveler] = useState(travelers[0]);
            const [expandedDateIndex, setExpandedDateIndex] = useState(null);
            const [selectedOverlay, setSelectedOverlay] = useState(null);
            const [showCouponsView, setShowCouponsView] = useState(false);
            
            const STORAGE_EXP = 'japan_trip_exp_vFinal_v202';
            const STORAGE_SHOP = 'japan_trip_shop_FINAL_ULTIMATE_V5';

            const [expenses, setExpenses] = useState(() => JSON.parse(localStorage.getItem(STORAGE_EXP) || '[]'));
            const [shoppingItems, setShoppingItems] = useState(() => {
                const saved = localStorage.getItem(STORAGE_SHOP);
                if (!saved) return drugstoreMasterData;
                const items = JSON.parse(saved);
                const combined = [...items];
                drugstoreMasterData.forEach(d => { if (!combined.some(c => c.id === d.id)) combined.push(d); });
                return combined;
            });

            useEffect(() => { localStorage.setItem(STORAGE_EXP, JSON.stringify(expenses)); }, [expenses]);
            useEffect(() => { localStorage.setItem(STORAGE_SHOP, JSON.stringify(shoppingItems)); }, [shoppingItems]);

            const [selectedAccDate, setSelectedAccDate] = useState('1/15');
            const [expRawAmount, setExpRawAmount] = useState('');
            const [expDesc, setExpDesc] = useState('');
            const [expType, setExpType] = useState('expense');
            const [expCategory, setExpCategory] = useState('ç¾é£Ÿ');
            const [activeShopCategory, setActiveShopCategory] = useState('è—¥å¦');
            const [newShopItemName, setNewShopItemName] = useState('');

            const scrollRef = useRef(null);
            const [isDragging, setIsDragging] = useState(false);
            const [startX, setStartX] = useState(0);
            const [scrollLeft, setScrollLeft] = useState(0);

            const handleMouseDown = (e) => {
                if (!scrollRef.current) return;
                setIsDragging(true);
                setStartX(e.pageX - scrollRef.current.offsetLeft);
                setScrollLeft(scrollRef.current.scrollLeft);
            };
            const handleMouseLeave = () => setIsDragging(false);
            const handleMouseUp = () => setIsDragging(false);
            const handleMouseMove = (e) => {
                if (!isDragging || !scrollRef.current) return;
                e.preventDefault();
                const x = e.pageX - scrollRef.current.offsetLeft;
                const walk = (x - startX) * 2;
                scrollRef.current.scrollLeft = scrollLeft - walk;
            };

            const handleAddExpense = (e) => {
                e.preventDefault();
                if (!expDesc.trim()) return;
                const sanitized = expRawAmount.replace(/[^-+*/().0-9]/g, '');
                let amount = 0; try { amount = new Function(`return ${sanitized}`)() || 0; } catch (err) {}
                const newItem = { id: Date.now(), amount, description: expDesc, type: expType, category: expCategory, date: selectedAccDate, payer: activeTraveler.name, createdAt: new Date().toISOString() };
                setExpenses([newItem, ...expenses]);
                setExpRawAmount(''); setExpDesc('');
            };

            const deleteExpense = (id) => setExpenses(expenses.filter(e => e.id !== id));
            const deleteShopItem = (id) => setShoppingItems(shoppingItems.filter(si => si.id !== id));
            const togglePurchased = (id) => setShoppingItems(shoppingItems.map(si => si.id === id ? { ...si, purchased: !si.purchased } : si));

            const handleAddShopItem = (e) => {
                e.preventDefault();
                if (!newShopItemName.trim()) return;
                const newItem = { id: Date.now(), name: newShopItemName, category: activeShopCategory, travelerId: activeTraveler.id, purchased: false, type: 'Product', intro: 'æ‰‹å‹•æ–°å¢', price: 'å¾…å®š', store: 'åœ°é»æœªå®š', createdAt: new Date().toISOString() };
                setShoppingItems([...shoppingItems, newItem]);
                setNewShopItemName('');
            };

            const sortedDayTrips = (dayItems) => {
                return [...dayItems].sort((a, b) => {
                    const getWeight = (t) => {
                        if (t === 'åˆé¤') return '12:00';
                        if (t === 'æ™šé¤') return '18:00';
                        if (t === 'ä½å®¿') return '23:59';
                        if (t && t.includes(':')) {
                            const parts = t.split(':');
                            return `${parts[0].padStart(2, '0')}:${parts[1]}`;
                        }
                        return t || '00:00';
                    };
                    return getWeight(a.startTime).localeCompare(getWeight(b.startTime));
                });
            };

            const financeStats = (() => {
                const dayEntries = expenses.filter(e => e.date === selectedAccDate);
                const inc = dayEntries.filter(e => e.type === 'income').reduce((s, e) => s + Number(e.amount), 0);
                const exp = dayEntries.filter(e => e.type === 'expense').reduce((s, e) => s + Number(e.amount), 0);
                let cumulative = expenses.reduce((s, e) => s + (e.type === 'income' ? Number(e.amount) : -Number(e.amount)), 0);
                return { inc, exp, cumulative };
            })();

            const couponData = [
                { id: 'donki_main', name: 'å”å‰è¨¶å¾· Donki', discount: '10% å…ç¨… + 5% æŠ˜æ‰£', img: 'https://lh3.googleusercontent.com/d/1GLEnLyxPei2-k0ST3i6JX9xwnPxfvHVH', externalLink: 'https://japanportal.donki-global.com/coupon/cp001_zhtw.html', type: 'Coupon' }
            ];

            return (
                <div className="flex justify-center bg-[#DED9CE] min-h-screen font-sans selection:bg-[#5D4037]/10 text-[#4A3728]">
                    <div className="w-full max-w-[390px] min-h-screen bg-[#F5F2E9] shadow-2xl relative overflow-hidden flex flex-col grain-overlay">
                        <div className="absolute inset-0 pointer-events-none opacity-[0.02] dot-grid z-0"></div>

                        <div className="flex-1 overflow-y-auto no-scrollbar relative z-10 content-padding">
                            <header className="pt-8 pb-4 px-6 shrink-0 border-b border-[#EAE3D2]/50 text-[#4A3728]">
                                <div className="flex justify-between items-center">
                                    <h1 className="text-2xl font-bold tracking-tighter leading-none">æ—¥æœ¬æ—…è¡Œæ‰‹è¨˜</h1>
                                    <div className="flex gap-1.5">
                                        {travelers.map(t => (
                                            <button key={t.id} onClick={() => setActiveTraveler(t)} className={`w-7 h-7 rounded-full border flex items-center justify-center transition-all duration-500 ${activeTraveler.id === t.id ? 'border-[#5D4037] scale-110 shadow-md ring-2 ring-[#5D4037]/10 z-10' : 'border-white/50 opacity-40 scale-90'}`} style={{ backgroundColor: t.color }}>
                                                <span className="text-[10px] text-white">{t.emoji}</span>
                                            </button>
                                        ))}
                                    </div>
                                </div>
                                <div className="mt-3 flex justify-between items-end opacity-50">
                                    <FujiIllustration />
                                    <div className="flex items-center gap-1 bg-[#FAF9F6] px-2 py-0.5 rounded-full border border-[#EAE3D2]">
                                        <div className="w-1 h-1 rounded-full animate-pulse" style={{ backgroundColor: activeTraveler.color }}></div>
                                        <span className="text-[7px] font-bold text-[#8C7B68] uppercase tracking-widest">{activeTraveler.name} è¦–è§’</span>
                                    </div>
                                </div>
                            </header>

                            <main className="px-5 pt-2 animate-fade-in text-[#4A3728]">
                                {/* 1. è¡Œç¨‹åˆ†é  */}
                                {currentTab === 'itinerary' && (
                                    <div className="space-y-3 pt-2">
                                        {dates.map((d, i) => {
                                            const isExpanded = expandedDateIndex === i;
                                            return (
                                                <div key={i} className="bg-white border rounded-xl shadow-sm overflow-hidden border-[#EAE3D2]">
                                                    <button onClick={() => setExpandedDateIndex(isExpanded ? null : i)} className="w-full p-3.5 flex items-center gap-4 text-left active:bg-stone-50 transition-all text-[#4A3728]">
                                                        <div className={`w-11 h-11 bg-[#5D4037] flex flex-col items-center justify-center rounded-lg shadow-sm shrink-0`}>
                                                            <span className="text-[7px] font-black text-white/50 uppercase leading-none mb-1">{d.weekday}</span>
                                                            <span className="text-base font-bold text-white tracking-tighter">{d.date.split('/')[1]}</span>
                                                        </div>
                                                        <div className="flex-1 font-bold text-[13px]">{d.title}</div>
                                                        <WeatherDisplay lat={d.loc.lat} lon={d.loc.lon} />
                                                        <Icon name={isExpanded ? "ChevronUp" : "ChevronDown"} size={14} className="opacity-30" />
                                                    </button>
                                                    {isExpanded && (
                                                        <div className="px-5 pb-5 space-y-4 border-t pt-4 animate-fade-in">
                                                            {sortedDayTrips(defaultTripData.filter(t => t.dateIndex === i)).map((trip, idx) => (
                                                                <div key={idx} className="flex gap-4">
                                                                    <span className="text-[9px] font-black py-1 h-5 min-w-[38px] bg-[#FAF9F6] border border-[#EAE3D2] text-center rounded shadow-xs">{trip.startTime}</span>
                                                                    <div className="flex-1">
                                                                        <div className="flex items-center gap-2 mb-1"><Icon name={trip.category || "Star"} size={12} className="text-[#D6C5A0]" /><p className="text-[11px] font-bold">{trip.name}</p></div>
                                                                        <p className="text-[8px] opacity-40 uppercase truncate font-black tracking-tight"><Icon name="MapPin" size={7}/> {trip.address}</p>
                                                                        {trip.note && <p className="text-[10px] text-[#8E7D6A] bg-[#FAF9F6] p-2 border-l-2 border-[#D6C5A0] mt-2 whitespace-pre-wrap leading-relaxed shadow-inner font-medium">âš ï¸ {trip.note}</p>}
                                                                    </div>
                                                                </div>
                                                            ))}
                                                        </div>
                                                    )}
                                                </div>
                                            );
                                        })}
                                    </div>
                                )}

                                {/* 2. ç¥¨åˆ¸åˆ†é  */}
                                {currentTab === 'tickets' && (
                                    <div className="space-y-4 pb-10 px-1 pt-2 animate-fade-in text-[#4A3728]">
                                        {ticketsData.map((tk, i) => {
                                            const my = tk.assignments ? tk.assignments[activeTraveler.id] : null;
                                            const isFlight = tk.type === 'Flight';
                                            return (
                                                <button key={i} onClick={() => setSelectedOverlay({ ...tk, currentUserData: my })} className="w-full text-left active:scale-[0.98] transition-all text-[#4A3728]">
                                                    <div className={`bg-white border shadow-xl rounded-2xl overflow-hidden relative ${isFlight ? 'pt-0 border-[#5D4037]/20' : 'p-5 border-[#EAE3D2]'}`}>
                                                        {isFlight ? (
                                                            <>
                                                                <div className="bg-[#5D4037] p-3 text-white flex justify-between items-center text-[8px] font-bold uppercase tracking-widest">
                                                                    <div className="flex items-center gap-2"><Icon name="Plane" size={10}/> Boarding Pass</div>
                                                                    <span className="text-[10px]">Cathay Pacific</span>
                                                                </div>
                                                                <div className="p-5">
                                                                    <div className="flex justify-between items-end mb-4">
                                                                        <div><p className="text-[7px] font-black opacity-30 uppercase tracking-widest text-[#A69076]">Passenger</p><p className="text-sm font-black">{activeTraveler.name}</p></div>
                                                                        <div className="text-right"><p className="text-[7px] font-black opacity-30 text-[#A69076]">Seat</p><p className="text-sm font-black text-[#5D4037]">{my?.seat || 'å¾…å®š'} <span className="text-[#A69076] font-black ml-1 text-base leading-none text-[#5D4037]">ï¸™</span></p></div>
                                                                    </div>
                                                                    <h3 className="text-[12px] font-bold border-b pb-2 mb-2">{tk.title}</h3>
                                                                    <div className="flex justify-between items-center text-[9px] font-bold text-[#A69076]">
                                                                        <p>{tk.date}</p>
                                                                        <Icon name="QrCode" size={14} className="opacity-40" />
                                                                    </div>
                                                                </div>
                                                            </>
                                                        ) : (
                                                            <div>
                                                                <div className="flex justify-between items-start mb-2">
                                                                    <span className={`text-[7px] font-black uppercase px-2 py-0.5 rounded-sm bg-[#5D4037] text-white`}>{tk.type}</span>
                                                                    <span className="text-[9px] font-bold text-[#A69076]">{tk.date}</span>
                                                                </div>
                                                                <p className="text-[13px] font-bold mb-1 leading-tight">{tk.title}</p>
                                                                <div className="mt-4 flex justify-between items-end border-t border-dashed border-[#F3EFE0] pt-3 text-[#A69076]">
                                                                    <p className="text-[10px] font-black text-[#8B5E3C]">{activeTraveler.name} å°ˆå±¬ {my?.seat ? ` | ${my.seat}` : ''}</p>
                                                                    <span className="text-xl font-black text-[#5D4037] opacity-60">ï¸™</span>
                                                                </div>
                                                            </div>
                                                        )}
                                                    </div>
                                                </button>
                                            );
                                        })}
                                    </div>
                                )}

                                {/* 3. è¨˜å¸³åˆ†é  */}
                                {currentTab === 'expenses' && (
                                    <div className="space-y-4 pb-12 px-1 pt-2 animate-fade-in text-[#4A3728]">
                                        <div ref={scrollRef} onMouseDown={handleMouseDown} onMouseLeave={handleMouseLeave} onMouseUp={handleMouseUp} onMouseMove={handleMouseMove} className={`flex flex-nowrap gap-2 overflow-x-auto no-scrollbar pb-3 px-1 w-full text-[#4A3728] ${isDragging ? 'cursor-grabbing' : 'cursor-grab'} select-none active:cursor-grabbing`} style={{ WebkitOverflowScrolling: 'touch' }}>
                                            {dates.map(d => (
                                                <button key={d.date} onClick={() => setSelectedAccDate(d.date)} className={`shrink-0 flex flex-col items-center justify-center w-14 h-16 rounded-2xl border transition-all duration-300 ${selectedAccDate === d.date ? 'bg-[#5D4037] text-white shadow-lg scale-105 border-[#5D4037]' : 'bg-white text-[#8E7D6A] border-[#EAE3D2]'}`}>
                                                    <span className="text-[6px] font-black uppercase opacity-60">{d.weekday}</span>
                                                    <span className="text-sm font-bold tracking-tighter text-opacity-100">{d.date.split('/')[1]}</span>
                                                </button>
                                            ))}
                                        </div>
                                        <div className="bg-[#5D4037] p-6 rounded-[2.5rem] shadow-xl text-white text-center border border-white/5">
                                            <p className="text-[7px] font-black uppercase tracking-[0.4em] opacity-40 mb-1 text-center">Cumulative Balance (Â¥)</p>
                                            <h2 className="text-4xl font-bold tracking-tighter mb-6 text-opacity-95">Â¥{financeStats.cumulative.toLocaleString()}</h2>
                                            <div className="grid grid-cols-2 gap-4 border-t border-white/10 pt-4 px-2">
                                                <div className="text-left text-[#F5F2E9] text-opacity-80"><p className="text-[7px] opacity-40 uppercase mb-1 font-black text-white">Today Inc.</p><p className="text-sm font-bold text-green-300">Â¥{financeStats.inc.toLocaleString()}</p></div>
                                                <div className="text-right border-l border-white/10 pl-4 text-stone-300 text-opacity-80"><p className="text-[7px] opacity-40 uppercase mb-1 font-black text-white text-opacity-50">Today Exp.</p><p className="text-sm font-bold text-red-300">Â¥{financeStats.exp.toLocaleString()}</p></div>
                                            </div>
                                        </div>
                                        <div className="bg-white border p-5 rounded-[2rem] shadow-sm text-[#4A3728] border-[#EAE3D2]">
                                            <div className="flex gap-2 mb-4 bg-[#F3EFE0] p-1 rounded-xl">
                                                <button onClick={() => setExpType('expense')} className={`flex-1 py-1.5 text-[9px] font-black rounded-lg transition-all ${expType === 'expense' ? 'bg-[#5D4037] text-white shadow-md' : ''}`}>æ”¯å‡º</button>
                                                <button onClick={() => setExpType('income')} className={`flex-1 py-1.5 text-[9px] font-black rounded-lg transition-all ${expType === 'income' ? 'bg-[#D6C5A0] text-[#4A3728] shadow-md' : ''}`}>æ”¶å…¥</button>
                                            </div>
                                            <div className="grid grid-cols-4 gap-2 mb-5">
                                               {Object.keys(accIconsMap).filter(k => expType === 'income' ? (k === 'åŸºé‡‘' || k === 'ç½°æ¬¾') : (k !== 'åŸºé‡‘' && k !== 'ç½°æ¬¾')).map(cat => (
                                                  <button key={cat} onClick={() => setExpCategory(cat)} className={`flex flex-col items-center gap-1.5 py-2 rounded-xl border transition-all ${expCategory === cat ? 'bg-[#F5F2E9] border-[#5D4037] text-[#5D4037]' : 'bg-white border-[#EEEAE0] text-[#A69076] opacity-60'}`}>
                                                     <span className="text-lg">{accIconsMap[cat]}</span><span className="text-[8px] font-black">{cat}</span>
                                                  </button>
                                               ))}
                                            </div>
                                            <form onSubmit={handleAddExpense} className="space-y-4">
                                                <input value={expRawAmount} onChange={e => setExpRawAmount(e.target.value)} placeholder="é‡‘é¡ (æ”¯æ´ 100+50)..." className="w-full bg-[#FAF9F6] border border-[#EAE3D2] rounded-xl text-[11px] px-4 py-3 outline-none focus:border-[#5D4037] font-mono shadow-inner text-[#4A3728]" />
                                                <div className="flex gap-2">
                                                    <input value={expDesc} onChange={e => setExpDesc(e.target.value)} placeholder="å‚™è¨»..." className="flex-1 bg-[#FAF9F6] border border-[#EAE3D2] rounded-xl text-[11px] px-4 py-3 outline-none focus:border-[#5D4037] shadow-inner text-[#4A3728]" />
                                                    <button type="submit" className="bg-[#5D4037] text-white px-5 rounded-xl shadow-lg active:scale-95 transition-all text-white font-bold text-lg">âœ¢</button>
                                                </div>
                                            </form>
                                        </div>
                                        <div className="space-y-2 mt-4">
                                            {expenses.filter(e => e.date === selectedAccDate).sort((a,b) => b.id - a.id).map((exp) => (
                                                <div key={exp.id} className="flex items-center justify-between bg-white p-4 rounded-2xl shadow-xs border border-stone-100 group animate-fade-in">
                                                    <div className="flex items-center gap-3">
                                                        <div className={`w-9 h-9 rounded-full flex items-center justify-center bg-red-50 text-lg`}>ğŸ’°</div>
                                                        <div><p className="text-[12px] font-bold text-[#4A3728] text-opacity-95">{exp.description}</p><p className="text-[8px] font-bold text-[#A69076] mt-0.5 uppercase tracking-tighter">{exp.payer} â€¢ {exp.category}</p></div>
                                                    </div>
                                                    <div className="flex items-center gap-4">
                                                       <span className={`text-[13px] font-black text-[#5D4037]`}>Â¥{exp.amount.toLocaleString()}</span>
                                                       <button onClick={() => deleteExpense(exp.id)} className="p-2 text-[#8B5E3C] opacity-20 hover:opacity-100 active:scale-90 transition-all font-bold text-lg">âœ˜</button>
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                )}

                                {/* 4. ä½å®¿åˆ†é  */}
                                {currentTab === 'stay' && (
                                    <div className="space-y-4 pb-10 px-1 pt-2 animate-fade-in text-[#4A3728]">
                                        {staysData.map((h, i) => (
                                            <div key={i} className="bg-white border border-[#EAE3D2] p-5 rounded-2xl shadow-sm text-[#4A3728]">
                                                <h4 className="font-black text-[13px] flex items-center gap-2 mb-1 uppercase tracking-tight text-[#5D4037] text-opacity-90"><Icon name="Hotel" size={14} className="text-[#8B5E3C] opacity-80"/> {h.name}</h4>
                                                <p className="text-[9px] text-[#A68B6A] mb-4 font-bold tracking-widest">{h.period}</p>
                                                <div className="grid grid-cols-2 gap-3 mb-4 text-[#A69076]">
                                                    <div className="bg-[#FAF9F6] p-2 rounded-lg border border-[#EAE3D2] text-center">
                                                        <p className="text-[7px] font-black uppercase mb-1 text-[#A69076]">Check-In</p><p className="text-xs font-black text-[#5D4037] text-center">{h.checkIn}</p>
                                                    </div>
                                                    <div className="bg-[#FAF9F6] p-2 rounded-lg border border-[#EAE3D2] text-center">
                                                        <p className="text-[7px] font-black uppercase mb-1 text-[#A69076]">Check-Out</p><p className="text-xs font-black text-[#5D4037] text-center">{h.checkOut}</p>
                                                    </div>
                                                </div>
                                                <div className="space-y-2 text-[10px] font-bold">
                                                    <div className="flex items-center gap-2 opacity-70"><Icon name="Navigation" size={10} className="text-[#8B5E3C]"/> {h.distance}</div>
                                                    <p className="bg-[#F5F2E9]/50 p-2 rounded border-l-2 border-[#D6C5A0] opacity-70 italic text-[9px] leading-relaxed font-medium">âš ï¸ {h.note}</p>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                )}

                                {/* 5. è³¼ç‰©åˆ†é  */}
                                {currentTab === 'shopping' && (
                                    <div className="animate-fade-in pt-2 text-[#4A3728]">
                                        <div className="bg-white border border-[#EAE3D2] shadow-sm rounded-3xl min-h-[500px] flex flex-col overflow-hidden text-[#4A3728]">
                                            <div className="px-4 pt-4 flex justify-between items-center">
                                                <button onClick={() => setShowCouponsView(!showCouponsView)} className={`px-3 py-1.5 rounded-full border transition-all flex items-center gap-2 ${showCouponsView ? 'bg-[#5D4037] text-white border-[#5D4037]' : 'bg-[#F5F2E9] border-[#EAE3D2] text-[#8B5E3C]'}`} >
                                                    <Icon name="Tag" size={10} className={showCouponsView ? "text-white" : "text-[#8B5E3C]"} />
                                                    <span className="text-[10px] font-black uppercase tracking-widest">{showCouponsView ? 'è¿”å›æ¸…å–®' : 'å„ªæƒ åˆ¸'}</span>
                                                </button>
                                            </div>
                                            
                                            {showCouponsView ? (
                                                <div className="p-6 animate-fade-in flex-1">
                                                    <h2 className="text-xs font-bold mb-6 tracking-widest uppercase font-black text-[#A69076] border-b pb-2">ê’° å„ªæƒ åˆ¸ ê’±</h2>
                                                    <div className="grid grid-cols-2 gap-4">
                                                        {couponData.map(cp => (
                                                            <button key={cp.id} onClick={() => setSelectedOverlay(cp)} className="bg-white border border-[#EAE3D2] rounded-2xl overflow-hidden shadow-sm active:scale-95 transition-all text-left text-[#4A3728]">
                                                                <div className="h-20 bg-stone-100 overflow-hidden"><img src={cp.img} className="w-full h-full object-cover" alt="" /></div>
                                                                <div className="p-2 leading-tight text-[#4A3728]">
                                                                    <p className="text-[10px] font-black truncate">{cp.name}</p>
                                                                    <p className="text-red-500 font-bold text-[8px]">{cp.discount}</p>
                                                                </div>
                                                            </button>
                                                        ))}
                                                    </div>
                                                </div>
                                            ) : (
                                                <div className="flex-1 flex flex-col animate-fade-in">
                                                    <div className="grid grid-cols-5 gap-0.5 p-1 bg-[#F3EFE0] border-b my-4 text-[#4A3728]">
                                                        {['è—¥å¦', 'ç¾å¦', 'é£Ÿ', 'è¶…å¸‚', 'å…¶ä»–'].map(cat => (
                                                            <button key={cat} onClick={() => setActiveShopCategory(cat)} className={`py-1.5 text-[9px] font-black rounded transition-all ${activeShopCategory === cat ? 'bg-[#5D4037] text-white shadow-md' : 'text-[#8B5E3C]'}`}>{cat}</button>
                                                        ))}
                                                    </div>
                                                    <div className="p-6 pt-0 flex-1 flex flex-col">
                                                        <h2 className="text-xs font-bold mb-6 tracking-widest uppercase font-black flex items-center gap-2">
                                                            <Icon name="ShoppingBag" size={14}/> {activeTraveler.name} çš„ {activeShopCategory} æ¸…å–®
                                                        </h2>
                                                        <div className="flex-1 space-y-3 overflow-y-auto max-h-[300px] no-scrollbar px-1">
                                                            {shoppingItems
                                                                .filter(item => item.category === activeShopCategory)
                                                                .sort((a,b) => a.purchased - b.purchased)
                                                                .map(item => (
                                                                <div key={item.id} className="flex items-center gap-2 group animate-fade-in">
                                                                    <div className="flex-1 flex items-center justify-between p-3 bg-white border border-[#EEEAE0] rounded-xl shadow-sm hover:border-[#D6C5A0] transition-all overflow-hidden">
                                                                        <div className="flex items-center gap-3 flex-1 overflow-hidden">
                                                                            <button onClick={() => togglePurchased(item.id)} className={`w-5 h-5 border-2 border-[#D6C5A0] rounded flex items-center justify-center shrink-0 transition-all ${item.purchased ? 'bg-[#5D4037] border-[#5D4037]' : 'bg-white'}`}>
                                                                                {item.purchased && <Icon name="Check" size={12} className="text-white" />}
                                                                            </button>
                                                                            <button onClick={() => setSelectedOverlay(item)} className={`text-[12px] text-left transition-all truncate flex-1 ${item.purchased ? 'line-through opacity-30 italic text-[#8E7D6A]' : 'font-bold'}`}>
                                                                                {item.name}
                                                                            </button>
                                                                        </div>
                                                                    </div>
                                                                    <button onClick={(e) => { e.stopPropagation(); deleteShopItem(item.id); }} className="p-2 text-[#8B5E3C] hover:text-red-500 transition-all active:scale-90 bg-[#F5F2E9] rounded-lg border border-[#EAE3D2] shadow-sm shrink-0" ><Icon name="X" size={18} /></button>
                                                                </div>
                                                            ))}
                                                        </div>
                                                        <form onSubmit={handleAddShopItem} className="mt-6 flex gap-2 border-t border-[#F3EFE0] pt-4">
                                                            <input value={newShopItemName} onChange={e => setNewShopItemName(e.target.value)} placeholder={`æ–°å¢è‡³ ${activeShopCategory}...`} className="flex-1 bg-[#F9F8F6] border border-[#EAE3D2] px-3 py-2 text-[11px] rounded-xl outline-none" />
                                                            <button type="submit" className="bg-[#5D4037] text-white px-4 rounded-xl shadow-md active:scale-95 transition-all text-white font-bold text-lg">âœ¢</button>
                                                        </form>
                                                    </div>
                                                </div>
                                            )}
                                        </div>
                                    </div>
                                )}
                            </main>
                        </div>

                        {/* --- åº•éƒ¨å°è¦½åˆ— --- */}
                        <nav className="fixed-nav text-[#4A3728]">
                            <NavIconButton active={currentTab === 'itinerary'} onClick={() => setCurrentTab('itinerary')} icon="Layout" label="è¡Œç¨‹" />
                            <NavIconButton active={currentTab === 'tickets'} onClick={() => setCurrentTab('tickets')} icon="Ticket" label="ç¥¨åˆ¸" />
                            <NavIconButton active={currentTab === 'expenses'} onClick={() => setCurrentTab('expenses')} icon="Wallet" label="è¨˜å¸³" />
                            <NavIconButton active={currentTab === 'stay'} onClick={() => setCurrentTab('stay')} icon="Hotel" label="ä½å®¿" />
                            <NavIconButton active={currentTab === 'shopping'} onClick={() => setCurrentTab('shopping')} icon="ShoppingBag" label="è³¼ç‰©" />
                        </nav>
                        
                        {/* Overlay å½ˆçª— */}
                        {selectedOverlay && (
                            <div className="fixed inset-0 z-[100] overlay-backdrop flex flex-col items-center justify-center p-4 animate-fade-in cursor-pointer text-[#4A3728]" onClick={() => setSelectedOverlay(null)}>
                                <div className="w-full max-w-[340px] pointer-events-auto" onClick={(e) => e.stopPropagation()}>
                                    <div className="bg-[#FAF9F6] p-6 rounded-[2.5rem] shadow-2xl relative border border-[#EAE3D2] flex flex-col overflow-hidden max-h-[92vh]">
                                        <div className="absolute inset-0 pointer-events-none opacity-[0.03] dot-grid"></div>
                                        <div className="flex justify-between items-center mb-5 border-b border-[#EAE3D2] pb-4 px-1 relative z-20">
                                            <div className="text-left flex-1 text-[#4A3728]"><h3 className="font-black text-lg leading-tight">{selectedOverlay.name || selectedOverlay.title}</h3><p className="text-[7px] font-bold text-[#A69076] mt-0.5 uppercase tracking-widest">{selectedOverlay.isVJW ? 'VJW Portal' : selectedOverlay.type === 'Product' ? 'å•†å“è©³æƒ…' : 'å°ˆå±¬è³‡è¨Š'}</p></div>
                                            <button onClick={() => setSelectedOverlay(null)} className="text-[#8B5E3C] p-2 hover:bg-stone-100 rounded-full transition-colors relative z-30 font-bold text-xl text-[#5D4037]">Ã—</button>
                                        </div>
                                        <div className="flex-1 overflow-y-auto no-scrollbar relative z-20 px-1 pb-2">
                                            <div className="bg-white rounded-[2rem] overflow-hidden border border-dashed border-[#D6C5A0] p-4 shadow-inner flex flex-col items-center min-h-[350px]">
                                                {selectedOverlay.isVJW ? (
                                                    <div className="p-6 w-full flex flex-col items-center text-center">
                                                        <div className="bg-orange-50 p-5 rounded-full mb-6 text-orange-400 font-bold text-4xl"><Icon name="Zap" size={48} /></div>
                                                        <h4 className="text-sm font-black mb-2 uppercase">Visit Japan Web</h4>
                                                        <div className="p-3 bg-[#F9F8F6] rounded-xl border border-[#EAE3D2] w-full mb-6">
                                                            <p className="text-[7px] font-black text-[#A69076] uppercase mb-1 text-center">ä¹˜å®¢é è¨‚ç·¨è™Ÿ</p>
                                                            <p className="text-lg font-black text-[#5D4037] tracking-widest text-center">{selectedOverlay.currentUserData?.code || 'N/A'}</p>
                                                        </div>
                                                        <button onClick={(e) => { e.stopPropagation(); window.open(selectedOverlay.vjwLink); }} className="w-full bg-[#5D4037] text-white py-4 rounded-2xl font-black text-[11px] shadow-xl hover:bg-[#4A3728] transition-all active:scale-95 text-white">ç«‹å³å‰å¾€</button>
                                                    </div>
                                                ) : selectedOverlay.isJR || selectedOverlay.isNozomi ? (
                                                    <div className="p-4 w-full text-left">
                                                        <div className="space-y-4">
                                                            <div>
                                                                <p className="text-[8px] font-black text-[#8E7D6A] uppercase mb-1 tracking-widest opacity-60">Reservation Info</p>
                                                                <p className="text-2xl font-black text-[#5D4037]">{selectedOverlay.details.no}</p>
                                                            </div>
                                                            <div className="grid grid-cols-2 gap-4">
                                                                <div className="bg-[#FAF9F6] p-3 rounded-xl border border-[#F3EFE0]">
                                                                    <p className="text-[7px] font-black text-[#A69076] uppercase mb-1">äººæ•¸/æ—¥æœŸ</p>
                                                                    <p className="text-[11px] font-bold text-[#5D4037]">{selectedOverlay.details.adults || '4 äºº'} | {selectedOverlay.details.period || 'ç•¶æ—¥æœ‰æ•ˆ'}</p>
                                                                </div>
                                                                <div className="bg-[#FAF9F6] p-3 rounded-xl border border-[#F3EFE0]">
                                                                    <p className="text-[7px] font-black text-[#A69076] uppercase mb-1">èªè­‰</p>
                                                                    <p className="text-[11px] font-bold text-[#5D4037]">{selectedOverlay.details.authCode || 'å¯¦é«”å¡é ˜å–'}</p>
                                                                </div>
                                                            </div>
                                                            <div className="bg-[#FAF9F6] p-4 rounded-2xl border border-[#EAE3D2]">
                                                                <p className="text-[9px] font-black text-[#8B5E3C] border-b border-[#D6C5A0] pb-2 mb-2 flex items-center gap-2"><Icon name="MapPin" size={12}/> é ˜å–/ä¹˜è»Šè³‡è¨Š</p>
                                                                <p className="text-[11px] font-bold text-[#5D4037] leading-relaxed">{selectedOverlay.details.location || selectedOverlay.details.route}</p>
                                                            </div>
                                                            {selectedOverlay.details.receiveLink && (
                                                                <button onClick={(e) => { e.stopPropagation(); window.open(selectedOverlay.details.receiveLink); }} className="w-full bg-[#8B5E3C] text-white py-3 rounded-xl font-black text-[10px] flex items-center justify-center gap-2 shadow-md active:scale-95 text-white">
                                                                    <Icon name="ExternalLink" size={12}/> å®˜ç¶²é ˜ç¥¨èªªæ˜
                                                                </button>
                                                            )}
                                                            <div className="space-y-3 bg-[#FAF9F6] p-4 rounded-2xl border border-[#EAE3D2]">
                                                                <p className="text-[9px] font-black text-[#8B5E3C] border-b border-[#D6C5A0] pb-2 mb-2 flex items-center gap-2"><Icon name="Package" size={10}/> é ˜å–å¿…å‚™æ¸…å–®</p>
                                                                <div className="flex items-start gap-3 text-[#5D4037]"><Icon name="CreditCard" size={14} className="text-[#A69076] mt-0.5" /><div className="flex-1 text-[11px] font-bold">çµå¸³å¯¦é«”å¡ (æœ«ç¢¼ {selectedOverlay.details.card})</div></div>
                                                                <div className="flex items-start gap-3 text-[#5D4037]"><Icon name="User" size={14} className="text-[#A69076] mt-0.5" /><div className="flex-1 text-[11px] font-bold whitespace-pre-line">{selectedOverlay.details.passports}</div></div>
                                                            </div>
                                                            <div className="bg-red-50 p-3 rounded-xl border border-red-100 flex gap-2 text-red-700">
                                                                <Icon name="Info" size={14} className="text-red-400 shrink-0" />
                                                                <p className="text-[10px] leading-relaxed font-bold whitespace-pre-line">{selectedOverlay.details.notice}</p>
                                                            </div>
                                                        </div>
                                                    </div>
                                                ) : selectedOverlay.isHighwayBus || selectedOverlay.isSkyliner ? (
                                                    <div className="p-4 w-full text-left">
                                                        <div className="space-y-4">
                                                            {selectedOverlay.currentImg && (
                                                                <div className="w-full aspect-square bg-white rounded-2xl overflow-hidden mb-2 border border-[#EAE3D2] flex items-center justify-center shrink-0 shadow-sm">
                                                                    <img src={selectedOverlay.currentImg} className="w-full h-full object-contain p-2" alt="Ticket Detail" />
                                                                </div>
                                                            )}
                                                            <div>
                                                                <p className="text-[8px] font-black text-[#8E7D6A] uppercase mb-1 tracking-widest opacity-60">Reservation Info</p>
                                                                <p className="text-2xl font-black text-[#5D4037]">{selectedOverlay.details.no}</p>
                                                            </div>
                                                            <div className="grid grid-cols-2 gap-4">
                                                                <div className="bg-[#FAF9F6] p-3 rounded-xl border border-[#F3EFE0]">
                                                                    <p className="text-[7px] font-black text-[#A69076] uppercase mb-1">äººæ•¸ / æ•ˆæœŸ</p>
                                                                    <p className="text-[11px] font-bold text-[#5D4037]">{selectedOverlay.details.adults || selectedOverlay.details.tickets} | {selectedOverlay.details.validity || 'ç•¶æ—¥'}</p>
                                                                </div>
                                                                <div className="bg-[#FAF9F6] p-3 rounded-xl border border-[#F3EFE0]">
                                                                    <p className="text-[7px] font-black text-[#A69076] uppercase mb-1">{selectedOverlay.isSkyliner ? 'PIN ç¢¼' : 'å·´å£«ç·¨è™Ÿ'}</p>
                                                                    <p className="text-[11px] font-bold text-[#5D4037]">{selectedOverlay.details.pin || selectedOverlay.details.busNo}</p>
                                                                </div>
                                                            </div>
                                                            <div className="bg-[#FAF9F6] p-4 rounded-2xl border border-[#EAE3D2]">
                                                                <p className="text-[9px] font-black text-[#8B5E3C] border-b border-[#D6C5A0] pb-2 mb-2 flex items-center gap-2"><Icon name="MapPin" size={12}/> è·¯ç·šè·¯æ®µ</p>
                                                                <p className="text-[11px] font-bold text-[#5D4037] leading-relaxed">{selectedOverlay.details.route}</p>
                                                            </div>
                                                            {selectedOverlay.isHighwayBus && (
                                                                <button onClick={(e) => { e.stopPropagation(); window.open(selectedOverlay.details.link); }} className="w-full bg-[#5D4037] text-white py-4 rounded-xl font-black text-[11px] flex items-center justify-center gap-2 shadow-lg active:scale-95 transition-all text-white">
                                                                    <Icon name="Ticket" size={14}/> é»æ­¤ç™¼è¡Œ Web Ticket
                                                                </button>
                                                            )}
                                                            <div className="bg-orange-50 p-3 rounded-xl border border-orange-100 flex gap-2 text-orange-800">
                                                                <Icon name="Info" size={14} className="text-orange-400 shrink-0" />
                                                                <p className="text-[10px] leading-relaxed font-bold">{selectedOverlay.details.notice}</p>
                                                            </div>
                                                        </div>
                                                    </div>
                                                ) : selectedOverlay.isUSJ ? (
                                                    <div className="p-4 w-full text-left">
                                                        <div className="space-y-4">
                                                            {selectedOverlay.currentUserData?.img && (
                                                                <div className="w-full aspect-square bg-stone-50 rounded-2xl overflow-hidden mb-2 border border-[#F3EFE0] flex items-center justify-center shadow-sm">
                                                                    <img src={selectedOverlay.currentUserData.img} className="w-full h-full object-contain" alt="USJ Ticket" />
                                                                </div>
                                                            )}
                                                            {selectedOverlay.currentUserData?.fullTicketLink && (
                                                                <button onClick={(e) => { e.stopPropagation(); window.open(selectedOverlay.currentUserData.fullTicketLink); }} className="w-full bg-[#8B5E3C] text-white py-3 rounded-xl font-black text-[11px] flex items-center justify-center gap-2 shadow-md active:scale-95 text-white"><Icon name="Ticket" size={14}/> é»æ­¤æŸ¥çœ‹å®Œæ•´ç¥¨åˆ¸</button>
                                                            )}
                                                            <div className="space-y-3">
                                                                <div className="bg-blue-50 p-3 rounded-xl border border-blue-100 text-blue-900"><p className="text-[9px] font-black text-blue-800 border-b border-blue-200 pb-1.5 mb-1.5 flex items-center gap-2"><Icon name="Navigation" size={12}/> æ”»ç•¥</p><p className="text-[10px] leading-relaxed font-bold whitespace-pre-line">{selectedOverlay.notices.entry}</p></div>
                                                                <div className="bg-orange-50 p-3 rounded-xl border border-orange-100 text-orange-900"><p className="text-[9px] font-black text-orange-800 border-b border-orange-200 pb-1.5 mb-1.5 flex items-center gap-2"><Icon name="ShoppingBasket" size={12}/> è³¼ç‰©</p><p className="text-[10px] leading-relaxed font-bold whitespace-pre-line">ã€é€€ç¨…ã€‘{selectedOverlay.notices.shopping}{'\n'}ã€çˆ†ç±³èŠ±ã€‘{selectedOverlay.notices.food}</p></div>
                                                            </div>
                                                            <button onClick={(e) => { e.stopPropagation(); window.open(selectedOverlay.mapLink); }} className="w-full border-2 border-[#5D4037] text-[#5D4037] py-3 rounded-xl font-black text-[10px] flex items-center justify-center gap-2 active:scale-95 transition-all"><Icon name="Map" size={14}/> å®˜æ–¹åœ’å€åœ°åœ–</button>
                                                        </div>
                                                    </div>
                                                ) : (
                                                    <>
                                                        {(selectedOverlay.img || selectedOverlay.currentImg || (selectedOverlay.assignments && selectedOverlay.assignments[activeTraveler.id]?.img)) && (
                                                            <div className="w-full aspect-square bg-stone-50 rounded-2xl overflow-hidden mb-5 border border-[#F3EFE0] flex items-center justify-center shadow-sm">
                                                                <img src={selectedOverlay.img || selectedOverlay.currentImg || selectedOverlay.assignments?.[activeTraveler.id]?.img} className="w-full h-full object-contain" alt="Detail" onError={(e) => e.target.src='https://placehold.co/400x400/EAE3D2/5D4037?text=No+Image'} />
                                                            </div>
                                                        )}
                                                        <div className="w-full space-y-4">
                                                            {selectedOverlay.type === 'Product' ? (
                                                                <>
                                                                    <div className="bg-[#FAF9F6] p-3 rounded-xl border border-[#F3EFE0]"><p className="text-[10px] font-black text-[#8B5E3C] mb-1">âœ© ç°¡ä»‹</p><p className="text-[11px] leading-relaxed opacity-80">{selectedOverlay.intro}</p></div>
                                                                    <div className="space-y-2">
                                                                        <div className="bg-[#F5F2E9]/50 p-3 rounded-lg border border-[#EAE3D2] text-center text-[#A69076]"><p className="text-[7px] font-black uppercase opacity-40 text-[#A69076]">åƒ¹æ ¼</p><p className="text-sm font-black text-[#5D4037]">{selectedOverlay.price}</p></div>
                                                                        <div className="bg-[#F5F2E9]/50 p-3 rounded-lg border border-[#EAE3D2] text-center text-[#A69076]"><p className="text-[7px] font-black opacity-40 uppercase tracking-widest mb-1 text-[#A69076]">åœ°é»</p><p className="text-[10px] font-bold text-[#4A3728]">{selectedOverlay.store}</p></div>
                                                                    </div>
                                                                </>
                                                            ) : (
                                                                <div className="p-2 space-y-4">
                                                                    {selectedOverlay.assignments && selectedOverlay.assignments[activeTraveler.id]?.seat && (
                                                                        <div className="p-4 bg-[#F5F2E9] rounded-2xl border border-dashed border-[#D6C5A0] text-center">
                                                                            <p className="text-[7px] font-black uppercase text-[#A69076] mb-1">åº§ä½åˆ†é…</p>
                                                                            <p className="text-lg font-black text-[#5D4037] tracking-widest">{selectedOverlay.assignments[activeTraveler.id].seat}</p>
                                                                        </div>
                                                                    )}
                                                                    <p className="text-[11px] text-center opacity-60">ä½¿ç”¨æ™‚è«‹é»æ“Šé ˜å–ä¸¦å‡ºç¤ºæ¢ç¢¼</p>
                                                                    {selectedOverlay.externalLink && (
                                                                        <button onClick={() => window.open(selectedOverlay.externalLink)} className="w-full bg-[#5D4037] text-white py-3 rounded-2xl flex items-center justify-center gap-2 shadow-lg text-white">å‰å¾€é ˜å–é›»å­åˆ¸</button>
                                                                    )}
                                                                </div>
                                                            )}
                                                        </div>
                                                    </>
                                                )}
                                            </div>
                                            <p className="text-[7px] text-center mt-6 opacity-40 font-bold tracking-[0.2em] italic">é»æ“Šç©ºç™½è™•æˆ–ä¸Šæ–¹é—œé–‰è¿”å›åˆ—è¡¨</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const root = window.ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>2026 Êó•Êú¨Êé¢Èö™ ‚Ä¢ È´òÁ¥öÂ•∂Ëå∂ÊâãÊú≠</title>
    <!-- ËºâÂÖ•Â§ñÈÉ®‰æùË≥¥ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fadeIn 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .grain-overlay::before { content: ""; position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 50; opacity: 0.3; background-image: url("https://www.transparenttextures.com/patterns/natural-paper.png"); }
        .dot-grid { background-image: radial-gradient(#D6C5A0 0.5px, transparent 0.5px); background-size: 20px 20px; }
        * { -webkit-tap-highlight-color: transparent; outline: none; }
        
        .lucide-icon-wrapper svg {
            display: inline-block;
            vertical-align: middle;
        }
        
        .overlay-backdrop {
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
        }
    </style>
</head>
<body class="bg-[#DED9CE]">
    <div id="root"></div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, deleteDoc, updateDoc, query, getDocs, writeBatch } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";

        window.FB = { 
            initializeApp, getFirestore, collection, addDoc, onSnapshot, 
            doc, deleteDoc, updateDoc, query, getDocs, writeBatch, 
            getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken 
        };
    </script>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        // --- ÊèíÂúñÁµÑ‰ª∂ ---
        const FujiIllustration = () => (
            <svg viewBox="0 0 200 100" className="w-14 h-auto opacity-20 text-[#8B5E3C]">
                <path d="M20,90 L100,20 L180,90 Z" fill="currentColor" />
                <path d="M80,37 L100,20 L120,37 Q100,45 80,37" fill="#FFFFFF" />
                <circle cx="160" cy="30" r="8" fill="#D6C5A0" />
            </svg>
        );

        // --- Ê†∏ÂøÉÂúñÁ§∫ÁµÑ‰ª∂ (ÂæπÂ∫ï‰øÆÂæ© Pascal/Kebab Ê†ºÂºè) ---
        const Icon = ({ name, size = 16, className = "" }) => {
            const [svgHtml, setSvgHtml] = useState("");
            
            useEffect(() => {
                let mounted = true;
                const renderIcon = () => {
                    if (!window.lucide || !window.lucide.icons) {
                        setTimeout(renderIcon, 100);
                        return;
                    }
                    
                    // ÂêçÁ®±ËΩâÊèõËàá‰øÆÊ≠£
                    let searchName = name;
                    if (name === "Flight") searchName = "Plane";
                    if (name === "MapIcon") searchName = "Map";
                    if (name === "Transport") searchName = "Train";
                    
                    // ËΩâ kebab-case (MapPin -> map-pin)
                    const kebabName = searchName.replace(/([a-z0-9])([A-Z])/g, '$1-$2').toLowerCase();
                    const iconObj = window.lucide.icons[searchName] || window.lucide.icons[kebabName];
                    
                    if (iconObj && typeof iconObj.toSvg === 'function' && mounted) {
                        setSvgHtml(iconObj.toSvg({
                            width: size,
                            height: size,
                            class: className,
                            'stroke-width': 2
                        }));
                    }
                };
                
                renderIcon();
                return () => { mounted = false; };
            }, [name, size, className]);

            return <span className="lucide-icon-wrapper flex items-center justify-center shrink-0" dangerouslySetInnerHTML={{ __html: svgHtml }} />;
        };

        const App = () => {
            const [user, setUser] = useState(null);
            const [loading, setLoading] = useState(true);
            const [currentTab, setCurrentTab] = useState('itinerary');
            const [expandedDateIndex, setExpandedDateIndex] = useState(null);
            const [selectedOverlay, setSelectedOverlay] = useState(null);
            
            const [trips, setTrips] = useState([]);
            const [expenses, setExpenses] = useState([]);
            const [shoppingItems, setShoppingItems] = useState([]);

            const travelers = [
                { id: 'goldfish', name: 'ÈáëÈ≠ö', color: '#8B5E3C', emoji: 'üê†' },
                { id: 'penguin', name: '‰ºÅÈµù', color: '#5D4037', emoji: 'üêß' },
                { id: 'zhi', name: 'ÈòøÊô∫', color: '#A69076', emoji: 'ü¶â' },
                { id: 'spasm', name: 'ÁóôÊî£', color: '#D6C5A0', emoji: '‚ö°' }
            ];
            const [activeTraveler, setActiveTraveler] = useState(travelers[0]);

            const [selectedAccDate, setSelectedAccDate] = useState('1/15');
            const [expRawAmount, setExpRawAmount] = useState('');
            const [expDesc, setExpDesc] = useState('');
            const [expType, setExpType] = useState('expense');
            const [expCategory, setExpCategory] = useState('ÁæéÈ£ü');
            const [activeShopCategory, setActiveShopCategory] = useState('Ë∂ÖÂ∏Ç');
            const [newShopItemName, setNewShopItemName] = useState('');

            // ÈÖçÁΩÆÂÅµÊ∏¨
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'japan-2026-vFinal-Renamed';
            const firebaseConfig = (() => {
                try {
                    if (typeof __firebase_config !== 'undefined') return JSON.parse(__firebase_config);
                } catch (e) {}
                return null;
            })();

            // --- Ê†∏ÂøÉË≥áÊñô ---
            const dates = [
                { date: '1/15', weekday: 'Êú®', title: 'Íí∞Ê¢ÖÁî∞ÈÄõÈÄõ:.„ÄÇ.‚òÜ' },
                { date: '1/16', weekday: 'Èáë', title: 'Íí∞USJÁí∞ÁêÉÂΩ±Âüé‚ô°Ôæû' },
                { date: '1/17', weekday: 'Âúü', title: 'Íí∞Â•àËâØ‰∫¨ÈÉΩÈÅäùúóùúö ÔΩ°Àö' },
                { date: '1/18', weekday: 'Êó•', title: 'Íí∞Â§ßÈò™‚û≥Êù±‰∫¨' },
                { date: '1/19', weekday: 'Êúà', title: 'Íí∞ÂØåÂ£´Â±±„ÅÆÊó•‚úøÀñ¬∞' },
                { date: '1/20', weekday: 'ÁÅ´', title: 'Íí∞Ê†ÇÊ±†ÊªëÈõ™Day-1' },
                { date: '1/21', weekday: 'Ê∞¥', title: 'Íí∞Ê†ÇÊ±†ÊªëÈõ™Day-2' },
                { date: '1/22', weekday: 'Êú®', title: 'Íí∞Âπ≥ÂÆâÂõûÂÆ∂^. .^ ‡©≠' },
            ];

            const defaultTripData = [
                { dateIndex: 0, startTime: '11:15', name: 'Êê≠‰πòÂúãÊ≥∞Ëà™Á©∫', address: 'Ê°ÉÂúíÊ©üÂ†¥‰∏ÄËà™', category: 'Plane', note: 'Ëà™Áè≠ CX564 | È†êË®ÇÈáëÈ≠öÈµù DGL2ET / ÈòøÊô∫ DH5MG7' },
                { dateIndex: 0, startTime: '16:00', name: 'Âá∫Êµ∑Èóú & È†òÁ•®', address: 'ÈóúË•øÊ©üÂ†¥', category: 'Ticket', note: 'È†êË®ÇÁ∑®ËôüÔºö40376\nÈúÄÊåÅÔºö‰ø°Áî®Âç°(1668)+4Á¢ºÂØÜÁ¢º+4‰∫∫Ë≠∑ÁÖß' },
                { dateIndex: 0, startTime: '16:30', name: 'Êê≠‰πò HARUKA', address: 'Ê©üÂ†¥ JR ÊúàÂè∞', category: 'Train', note: 'Ëá™Áî±Â∏≠ | ‰ΩøÁî®ÈóúË•øÂë®ÈÅäÂà∏' },
                { dateIndex: 0, startTime: '17:20', name: 'Ê¢ÖÁî∞Ë≥ºÁâ©', address: 'JR Ê¢ÖÁî∞', category: 'ShoppingBag', note: 'Êôö‰∏äÂ∞±Âú®Ê¢ÖÁî∞Ë≥ºÁâ©' },
                { dateIndex: 0, startTime: 'ÊôöÈ§ê', name: 'È†êË®àÁáíËÇâËÇâ‰∫îÈÉé', address: 'ÁáíËÇâ ËÇâ‰∫îÈÉé Â§©ÊªøÂ∫ó', category: 'Utensils', note: 'ÁáüÊ•≠ÊôÇÈñì 11:00-23:00\nÂ§©ÊªøÁ´ôÊ≠•Ë°å3ÂàÜÈêò' },
                { dateIndex: 0, startTime: '‰ΩèÂÆø', name: 'Ê¢ÖÁî∞‰ΩèÂÆø', address: 'https://maps.app.goo.gl/B9W2PwzGhuXaFTso8', category: 'Hotel', note: 'Apartment Hotel 11 Higashi Umeda\nÂ§ßÈò™Á´ôÊ≠•Ë°åÁ¥Ñ 12 ÂàÜÈêò' },
                { dateIndex: 1, startTime: '6:40', name: 'È£ØÂ∫óÂá∫Áôº', address: 'JR Â§ßÈò™Á´ô', category: 'Train', note: 'Ê≠•Ë°åÁ¥Ñ 12 ÂàÜÈêòËá≥Á´ô\nÊê≠‰πòÁí∞ÁãÄÁ∑öÂæÄË•ø‰πùÊ¢ù\nÊó©È§ê 7-11' },
                { dateIndex: 1, startTime: '7:40', name: 'ÊäµÈÅîÁí∞ÁêÉ', address: 'USJ Áí∞ÁêÉÂΩ±Âüé', category: 'Star', note: 'ÂÖ•ÂúíÁõ¥Ë°ùÈ¶¨ÂäõÊ≠êÂúíÂçÄ\n\n„ÄêÂÖ•ÂúíÈ†àÁü•„Äë\n1. ‰∏ãËºâ USJ App È†òÊï¥ÁêÜÂà∏\n2. Âª∫Ë≠∞ 7:00 ÂâçÊäµÈÅîÁèæÂ†¥ÊéíÈöä\n3. Á¶ÅÂ∏∂Â§ñÈ£üËàáÂ§ßÂÆπÈáèÈ£≤Êñô\n4. ÂÇôÂ¶•ÈõªÂ≠êÈñÄÁ•® QR Code' },
                { dateIndex: 1, startTime: '20:00', name: 'ÈñâÂúíÊôÇÈñì', address: 'Ë∂ÖÂ∏Ç', category: 'Utensils', note: 'ÊôöÈ§êÈ†êË®àÂêÉË∂ÖÂ∏Ç' },
                { dateIndex: 1, startTime: '‰ΩèÂÆø', name: 'Ê¢ÖÁî∞‰ΩèÂÆø', address: 'https://maps.app.goo.gl/B9W2PwzGhuXaFTso8', category: 'Hotel', note: 'Apartment Hotel 11 Higashi Umeda\nÂ§ßÈò™Á´ôÊ≠•Ë°åÁ¥Ñ 12 ÂàÜÈêò' }
            ];

            const staysData = [
                { name: 'Apartment Hotel 11 Higashi Umeda', period: '1/15 ‚Äî 1/18', checkIn: '15:00', checkOut: '11:00', distance: 'Â§ßÈò™Á´ô 12 ÂàÜÈêò', note: 'Ëá™Âä©ÂØÜÁ¢ºÈéñ' },
                { name: 'Shinjuku sprem', period: '1/18 ‚Äî 1/19', checkIn: '16:00', checkOut: '10:00', distance: 'Êñ∞ÂÆøÁ´ô 10 ÂàÜÈêò', note: 'ÁÑ°ÈõªÊ¢Ø' },
                { name: 'Sotetsu Fresa Inn ÂñÑÂÖâÂØ∫Âè£', period: '1/19 ‚Äî 1/22', checkIn: '15:00', checkOut: '11:00', distance: 'Èï∑ÈáéÁ´ôÂ∞çÈù¢', note: '‰ΩçÁΩÆÊ•µ‰Ω≥' }
            ];

            const ticketsData = [
                { id: 'flight', type: 'Flight', title: 'ÂúãÊ≥∞Ëà™Á©∫ Âè∞Âåó‰∏ÄËà™ ‚ûî Â§ßÈò™', date: '1/15 11:15', isVJW: true, vjwLink: 'https://www.vjw.digital.go.jp/', assignments: { goldfish: { code: 'DGL2ET', seat: 'ÂæÖÈÅ∏' }, penguin: { code: 'DGL2ET', seat: 'ÂæÖÈÅ∏' }, zhi: { code: 'DH5MG7', seat: 'ÂæÖÈÅ∏' }, spasm: { code: 'DH5MG7', seat: 'ÂæÖÈÅ∏' } } },
                { id: 'jr', type: 'Pass', title: 'ÈóúË•øÂú∞ÂçÄÈêµË∑ØÂë®ÈÅäÂà∏', date: '1/15', isJR: true, details: { no: '40376', card: '1668', notice: 'ÊåÅË≠∑ÁÖßÈ†òÂèñ' } },
                { id: 'usj', type: 'Ticket', title: 'USJ Áí∞ÁêÉÂΩ±ÂüéÈñÄÁ•®', date: '1/16', isUSJ: true, assignments: { goldfish: { img: 'https://lh3.googleusercontent.com/d/1OcyV3zuqQkXMTtOerNEoMBuXCuSxAoOK' }, penguin: { img: 'https://lh3.googleusercontent.com/d/1MzFWNFr9lKDFtwg902ziO4-KhLeKRPGL' }, zhi: { img: 'https://lh3.googleusercontent.com/d/1ic2KFekF4jO403KVeLGMmOamFoxVcu7r' }, spasm: { img: 'https://lh3.googleusercontent.com/d/1P82cswIIyvEtvvVFIpb6Lj0sQqKBqyhq' } } }
            ];

            const couponData = [
                { id: 1, name: 'ÂîêÂêâË®∂Âæ∑', discount: '10% ÂÖçÁ®Ö + 5% OFF', img: 'https://images.unsplash.com/photo-1596464716127-f2a82984de30?q=80&w=800' },
                { id: 2, name: 'ÊùæÊú¨Ê∏Ö', discount: 'ÊúÄÂ§ß 7% ÊäòÊâ£', img: 'https://images.unsplash.com/photo-1618005182384-a83a8bd57fbe?q=80&w=800' }
            ];

            const usjMapData = { title: 'Áí∞ÁêÉÂΩ±ÂüéÂúíÂçÄÂú∞Âúñ', currentImg: 'https://lh3.googleusercontent.com/d/1PmA35rbRYDdi9hc0ClNl8p4RAioCT32x', type: 'Map' };

            // --- ÊéíÂ∫èÊ¨äÈáç ---
            const sortedDayTrips = (dayItems) => {
                return [...dayItems].sort((a, b) => {
                    const getWeight = (t) => {
                        if (t === 'ÊôöÈ§ê') return '23:58';
                        if (t === '‰ΩèÂÆø') return '23:59';
                        return t || '00:00';
                    };
                    return getWeight(a.startTime).localeCompare(getWeight(b.startTime));
                });
            };

            const getMockWeather = (dateStr) => {
                const day = parseInt(dateStr.split('/')[1]);
                if (day <= 17) return { icon: <Icon name="Sun" className="text-orange-400"/>, temp: '8¬∞C' };
                if (day === 18) return { icon: <Icon name="Cloud" className="text-gray-400"/>, temp: '6¬∞C' };
                return { icon: <Icon name="Snowflake" className="text-blue-200"/>, temp: '-2¬∞C' };
            };

            // --- Firebase Sync ---
            useEffect(() => {
                if (!firebaseConfig) { setLoading(false); return; }
                const { initializeApp: initApp, getAuth: initAuth, getFirestore: initDb, onAuthStateChanged: onAuthChanged, signInAnonymously: signAnon, signInWithCustomToken: signToken } = window.FB;
                
                const fbApp = initApp(firebaseConfig);
                const fbAuth = initAuth(fbApp);
                const fbDb = initDb(fbApp);

                const startAuth = async () => {
                    const t = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                    if (t) await signToken(fbAuth, t); else await signAnon(fbAuth);
                };
                startAuth();

                onAuthChanged(fbAuth, (u) => {
                    setUser(u);
                    if (u) {
                        const tripsRef = window.FB.collection(fbDb, 'artifacts', appId, 'public', 'data', 'trips');
                        const expRef = window.FB.collection(fbDb, 'artifacts', appId, 'public', 'data', 'expenses');
                        const shopRef = window.FB.collection(fbDb, 'artifacts', appId, 'public', 'data', 'shopping');

                        window.FB.getDocs(tripsRef).then(snap => {
                            if (snap.empty) {
                                const batch = window.FB.writeBatch(fbDb);
                                defaultTripData.forEach(item => batch.set(window.FB.doc(window.FB.collection(fbDb, 'artifacts', appId, 'public', 'data', 'trips')), { ...item, createdAt: new Date().toISOString() }));
                                batch.commit();
                            }
                        });

                        window.FB.onSnapshot(tripsRef, s => setTrips(s.docs.map(d => ({ id: d.id, ...d.data() }))));
                        window.FB.onSnapshot(expRef, s => setExpenses(s.docs.map(d => ({ id: d.id, ...d.data() }))));
                        window.FB.onSnapshot(shopRef, s => {
                            setShoppingItems(s.docs.map(d => ({ id: d.id, ...d.data() })));
                            setLoading(false);
                        });
                    }
                });
            }, []);

            const handleAddExpense = async (e) => {
                e.preventDefault();
                if (!user || !expDesc) return;
                const sanitized = expRawAmount.replace(/[^-+*/().0-9]/g, '');
                let amount = 0; try { amount = new Function(`return ${sanitized}`)() || 0; } catch (e) {}
                await window.FB.addDoc(window.FB.collection(window.FB.getFirestore(), 'artifacts', appId, 'public', 'data', 'expenses'), {
                    amount, description: expDesc, type: expType, category: expCategory,
                    date: selectedAccDate, payer: activeTraveler.name, createdAt: new Date().toISOString()
                });
                setExpRawAmount(''); setExpDesc('');
            };

            const togglePurchased = async (item) => {
                await window.FB.updateDoc(window.FB.doc(window.FB.getFirestore(), 'artifacts', appId, 'public', 'data', 'shopping', item.id), { purchased: !item.purchased });
            };

            const financeStats = (() => {
                const dayEntries = expenses.filter(e => e.date === selectedAccDate);
                const inc = dayEntries.filter(e => e.type === 'income').reduce((s, e) => s + Number(e.amount), 0);
                const exp = dayEntries.filter(e => e.type === 'expense').reduce((s, e) => s + Number(e.amount), 0);
                let cumulative = expenses.reduce((s, e) => s + (e.type === 'income' ? Number(e.amount) : -Number(e.amount)), 0);
                return { inc, exp, cumulative };
            })();

            // --- ÈªûÊìäËøîÂõûËôïÁêÜÈÇèËºØ ---
            const closeOverlay = (e) => {
                // Â¶ÇÊûúÈªûÊìäÁöÑÊòØÂØ¶È´îÁöÑÂäüËÉΩÊåâÈàïÊàñËº∏ÂÖ•Ê°ÜÔºå‰∏çÈóúÈñâ
                if (e.target.closest('button') || e.target.closest('input') || e.target.closest('a')) return;
                setSelectedOverlay(null);
            };

            if (loading && firebaseConfig) return (
                <div className="h-screen bg-[#F5F2E9] flex items-center justify-center font-sans">
                    <div className="flex flex-col items-center gap-4">
                        <Icon name="Loader2" size={32} className="animate-spin text-[#8B5E3C]" />
                        <p className="text-[10px] font-bold uppercase tracking-widest text-[#8B5E3C]">ÊóÖÁ®ãË≥áÊñôËÆÄÂèñ‰∏≠...</p>
                    </div>
                </div>
            );

            return (
                <div className="flex justify-center bg-[#DED9CE] min-h-screen font-sans overflow-x-hidden selection:bg-[#5D4037]/10">
                    <div className="w-full max-w-[390px] min-h-screen bg-[#F5F2E9] shadow-2xl relative overflow-hidden flex flex-col grain-overlay">
                        <div className="absolute inset-0 pointer-events-none opacity-[0.02] dot-grid z-0"></div>

                        <div className="flex-1 overflow-y-auto no-scrollbar relative z-10 pb-36 text-[#4A3728]">
                            <header className="pt-8 pb-4 px-6 shrink-0 relative border-b border-[#EAE3D2]/50">
                                <div className="flex justify-between items-center text-[#4A3728]">
                                    <h1 className="text-2xl font-bold tracking-tighter leading-none">Êó•Êú¨ÊóÖË°åÊâãË®ò</h1>
                                    <div className="flex gap-1.5">
                                        {travelers.map(t => (
                                            <button key={t.id} onClick={() => setActiveTraveler(t)} className={`w-7 h-7 rounded-full border flex items-center justify-center transition-all duration-500 ${activeTraveler.id === t.id ? 'border-[#5D4037] scale-110 shadow-md ring-2 ring-[#5D4037]/10 z-10' : 'border-white/50 opacity-40 scale-90'}`} style={{ backgroundColor: t.color }}>
                                                <span className="text-[10px]">{t.emoji}</span>
                                            </button>
                                        ))}
                                    </div>
                                </div>
                                <div className="mt-3 flex justify-between items-end opacity-50">
                                    <FujiIllustration />
                                    <div className="flex items-center gap-1 bg-[#FAF9F6] px-2 py-0.5 rounded-full border border-[#EAE3D2]">
                                        <div className="w-1 h-1 rounded-full animate-pulse" style={{ backgroundColor: activeTraveler.color }}></div>
                                        <span className="text-[7px] font-bold text-[#8C7B68] uppercase tracking-widest">{activeTraveler.name} Ë¶ñËßí</span>
                                    </div>
                                </div>
                            </header>

                            <main className="px-5 pt-2 animate-fade-in">
                                {currentTab === 'itinerary' && (
                                    <div className="space-y-3 pt-2">
                                        {dates.map((d, i) => {
                                            const isExpanded = expandedDateIndex === i;
                                            const dayTrips = trips.filter(t => t.dateIndex === i);
                                            const sortedTrips = sortedDayTrips(dayTrips);
                                            const weather = getMockWeather(d.date);
                                            return (
                                                <div key={i} className="flex flex-col text-[#4A3728]">
                                                    <div className="bg-white border rounded-xl shadow-sm overflow-hidden border-[#EAE3D2]">
                                                        <button onClick={() => setExpandedDateIndex(isExpanded ? null : i)} className="w-full p-3.5 flex items-center gap-4 active:bg-stone-50 transition-all text-left">
                                                            <div className={`w-11 h-11 bg-[#5D4037] flex flex-col items-center justify-center rounded-lg shadow-sm shrink-0`}>
                                                                <span className="text-[7px] font-black text-white/50 uppercase leading-none mb-1 text-white">{d.weekday}</span>
                                                                <span className="text-base font-bold text-white tracking-tighter text-white">{d.date.split('/')[1]}</span>
                                                            </div>
                                                            <div className="flex-1 font-bold text-[13px]">{d.title}</div>
                                                            <div className="flex flex-col items-end gap-0.5 pr-1 border-l pl-3 border-[#F3EFE0]">
                                                                {weather.icon}<span className="text-[10px] font-bold text-[#5D4037]">{weather.temp}</span>
                                                            </div>
                                                            <Icon name={isExpanded ? "ChevronUp" : "ChevronDown"} size={18} />
                                                        </button>
                                                        {isExpanded && (
                                                            <div className="px-5 pb-5 space-y-4 border-t pt-4">
                                                                {i === 1 && (
                                                                    <button onClick={() => setSelectedOverlay(usjMapData)} className="w-full bg-[#5D4037] text-white py-3 rounded-xl flex items-center justify-center gap-2 shadow-md active:scale-95 transition-all mb-4 text-white">
                                                                        <Icon name="Map" size={14} /><span className="text-[10px] font-black uppercase tracking-widest text-white">Êü•ÁúãÁí∞ÁêÉÂΩ±ÂüéÂú∞Âúñ</span>
                                                                    </button>
                                                                )}
                                                                {sortedTrips.map(trip => (
                                                                    <div key={trip.id} className="flex gap-4 relative">
                                                                        <span className="text-[9px] font-black py-1 h-5 min-w-[38px] bg-[#FAF9F6] border border-[#EAE3D2] text-center rounded shadow-xs text-[#4A3728]">{trip.startTime}</span>
                                                                        <div className="flex-1 text-[#4A3728]">
                                                                            <div className="flex items-center gap-2 mb-1">
                                                                               <Icon name={trip.category || "Star"} size={12} className="text-[#D6C5A0]" />
                                                                               <p className="text-[11px] font-bold">{trip.name}</p>
                                                                            </div>
                                                                            <p className="text-[8px] opacity-40 uppercase font-black truncate max-w-[150px]"><Icon name="MapPin" size={7}/> {trip.address}</p>
                                                                            {trip.note && <p className="text-[10px] text-[#8E7D6A] bg-[#FAF9F6] p-2 border-l-2 border-[#D6C5A0] mt-2 whitespace-pre-wrap leading-relaxed shadow-inner font-medium">{trip.note}</p>}
                                                                            <button onClick={() => window.open(trip.address.includes('http') ? trip.address : `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(trip.address)}`)} className="mt-2 text-[8px] font-black uppercase text-[#5D4037] flex items-center gap-1.5 underline">Êô∫ÊÖßÂ∞éËà™</button>
                                                                        </div>
                                                                    </div>
                                                                ))}
                                                            </div>
                                                        )}
                                                    </div>
                                                </div>
                                            );
                                        })}
                                    </div>
                                )}

                                {currentTab === 'tickets' && (
                                    <div className="space-y-4 pb-10 px-1 pt-2">
                                        {ticketsData.map((tk, i) => {
                                            const my = tk.assignments ? tk.assignments[activeTraveler.id] : null;
                                            return (
                                                <button key={i} onClick={() => setSelectedOverlay({ ...tk, currentImg: my?.img })} className="w-full text-left active:scale-[0.98] transition-all">
                                                    <div className={`bg-white border shadow-xl rounded-2xl overflow-hidden relative ${tk.type === 'Flight' ? 'pt-0 border-[#5D4037]/20' : 'p-5 border-[#EAE3D2]'}`}>
                                                        {tk.type === 'Flight' ? (
                                                            <>
                                                                <div className="bg-[#5D4037] p-3 text-white flex justify-between items-center text-[8px] font-bold uppercase tracking-widest text-white">
                                                                    <div className="flex items-center gap-2"><Icon name="Plane" size={10}/> Boarding Pass</div>
                                                                    <span>Cathay Pacific</span>
                                                                </div>
                                                                <div className="p-5 text-[#4A3728]">
                                                                    <div className="flex justify-between items-end mb-4">
                                                                        <div><p className="text-[7px] font-black opacity-30 uppercase tracking-widest text-[#A69076]">Flight</p><p className="text-sm font-black">CX 564</p></div>
                                                                        <div className="text-right text-[9px] font-bold"><p className="text-[7px] font-black opacity-30">Times</p><span>11:15</span> ‚ûî <span>14:55</span></div>
                                                                    </div>
                                                                    <h3 className="text-[12px] font-bold border-b pb-3 mb-3">{tk.title}</h3>
                                                                    <div className="flex justify-between items-center bg-[#F5F2E9] p-3 rounded-xl border border-dashed border-[#D6C5A0]">
                                                                        <div><p className="text-[7px] opacity-40 uppercase">Passenger</p><p className="text-[10px] font-bold text-[#8B5E3C]">{activeTraveler.name}</p></div>
                                                                        <div className="text-center"><p className="text-[7px] opacity-40 text-center">Seat</p><p className="text-sm font-black text-[#5D4037]">{my?.seat}</p></div>
                                                                        <div className="text-right">{tk.isVJW ? <Icon name="Zap" size={16} className="text-orange-400 animate-pulse" /> : <Icon name="QrCode" size={16} className="opacity-40" />}</div>
                                                                    </div>
                                                                </div>
                                                            </>
                                                        ) : (
                                                            <div className="text-[#4A3728]">
                                                                <div className="flex justify-between items-start mb-2">
                                                                    <span className={`text-[7px] font-black uppercase px-2 py-0.5 rounded-sm ${tk.isUSJ ? 'bg-[#D6C5A0] text-[#4A3728]' : 'bg-[#EAE3D2] text-[#8E7D6A]'}`}>{tk.type}</span>
                                                                    <span className="text-[9px] font-bold text-[#A69076]">{tk.date}</span>
                                                                </div>
                                                                <p className="text-[13px] font-bold mb-1 leading-tight">{tk.title}</p>
                                                                <div className="mt-4 flex justify-between items-end border-t border-dashed border-[#F3EFE0] pt-3 text-[#A69076]">
                                                                    <div><p className="text-[7px] font-black uppercase tracking-widest text-[#A69076]">Holder</p><p className="text-[10px] font-black text-[#8B5E3C]">{activeTraveler.name}</p></div>
                                                                    <Icon name="QrCode" size={14} className="opacity-40" />
                                                                </div>
                                                            </div>
                                                        )}
                                                    </div>
                                                </button>
                                            );
                                        })}
                                    </div>
                                )}

                                {currentTab === 'expenses' && (
                                    <div className="space-y-4 pb-12 px-1 text-[#4A3728] pt-2 animate-fade-in">
                                        <div className="bg-[#5D4037] p-6 rounded-[2.5rem] shadow-xl text-white text-center border border-white/5">
                                            <p className="text-[7px] font-black uppercase tracking-[0.4em] opacity-40 mb-1 text-center text-white text-opacity-40">Cumulative Balance (¬•)</p>
                                            <h2 className="text-4xl font-bold tracking-tighter mb-6 text-white text-opacity-90">¬•{financeStats.cumulative.toLocaleString()}</h2>
                                            <div className="grid grid-cols-2 gap-4 border-t border-white/10 pt-4 px-2">
                                                <div className="text-left text-[#F5F2E9]"><p className="text-[7px] opacity-40 uppercase mb-1 font-black">Today Inc.</p><p className="text-sm font-bold text-green-300">¬•{financeStats.inc.toLocaleString()}</p></div>
                                                <div className="text-right text-[#F5F2E9]"><p className="text-[7px] opacity-40 uppercase mb-1 font-black">Today Exp.</p><p className="text-sm font-bold text-red-300">¬•{financeStats.exp.toLocaleString()}</p></div>
                                            </div>
                                        </div>
                                        <div className="bg-white border p-5 rounded-[2rem] shadow-sm text-[#4A3728] border-[#EAE3D2]">
                                            <div className="flex gap-2 mb-4 bg-[#F3EFE0] p-1 rounded-xl text-[#4A3728]">
                                                <button onClick={() => setExpType('expense')} className={`flex-1 py-1.5 text-[9px] font-black rounded-lg transition-all ${expType === 'expense' ? 'bg-[#5D4037] text-white shadow-md' : ''}`}>ÊîØÂá∫</button>
                                                <button onClick={() => setExpType('income')} className={`flex-1 py-1.5 text-[9px] font-black rounded-lg transition-all ${expType === 'income' ? 'bg-[#D6C5A0] text-[#4A3728] shadow-md' : ''}`}>Êî∂ÂÖ•</button>
                                            </div>
                                            <div className="grid grid-cols-5 gap-2 mb-5">
                                               {['ÁæéÈ£ü', '‰∫§ÈÄö', 'Ë∂ÖÂïÜ', 'Á•®Âà∏', 'ÂÖ∂‰ªñ'].map(cat => (
                                                  <button key={cat} onClick={() => setExpCategory(cat)} className={`flex flex-col items-center gap-2 py-2.5 rounded-xl border transition-all ${expCategory === cat ? 'bg-[#F5F2E9] border-[#5D4037] text-[#5D4037]' : 'bg-white border-[#EEEAE0] text-[#A69076] opacity-60'}`}>
                                                     <Icon name={cat === 'ÁæéÈ£ü' ? 'Utensils' : cat === '‰∫§ÈÄö' ? 'Train' : cat === 'Ë∂ÖÂïÜ' ? 'Store' : cat === 'Á•®Âà∏' ? 'Ticket' : 'MoreHorizontal'} size={14} /><span className="text-[8px] font-black">{cat}</span>
                                                  </button>
                                               ))}
                                            </div>
                                            <form onSubmit={handleAddExpense} className="space-y-4">
                                                <input value={expRawAmount} onChange={e => setExpRawAmount(e.target.value)} placeholder="ÈáëÈ°ç..." className="w-full bg-[#FAF9F6] border border-[#EAE3D2] rounded-xl text-[11px] px-4 py-3.5 outline-none focus:border-[#5D4037] font-mono shadow-inner text-[#4A3728]" />
                                                <div className="flex gap-2">
                                                    <input value={expDesc} onChange={e => setExpDesc(e.target.value)} placeholder="ÂÇôË®ª..." className="flex-1 bg-[#FAF9F6] border border-[#EAE3D2] rounded-xl text-[11px] px-4 py-3.5 outline-none focus:border-[#5D4037] shadow-inner text-[#4A3728]" />
                                                    <button type="submit" className="bg-[#5D4037] text-white px-5 rounded-xl shadow-lg active:scale-95 transition-all text-white"><Icon name="Check" size={18} /></button>
                                                </div>
                                            </form>
                                        </div>
                                    </div>
                                )}
                            </main>
                        </div>

                        {/* --- Â∫ïÈÉ®Â∞éË¶ΩÂàó --- */}
                        <nav className="shrink-0 bg-white border-t border-[#EAE3D2] flex z-40 shadow-[0_-5px_20px_rgba(0,0,0,0.03)] px-1 h-14 items-center bg-[#FFFFFF]/95 backdrop-blur-sm text-[#4A3728]">
                            <button onClick={() => setCurrentTab('itinerary')} className={`flex-1 flex flex-col items-center gap-0.5 ${currentTab === 'itinerary' ? 'text-[#5D4037]' : 'text-[#8E7D6A] opacity-40'}`}><Icon name="Layout" size={18} /><span className="text-[8px] font-black uppercase">Ë°åÁ®ã</span></button>
                            <button onClick={() => setCurrentTab('tickets')} className={`flex-1 flex flex-col items-center gap-0.5 ${currentTab === 'tickets' ? 'text-[#5D4037]' : 'text-[#8E7D6A] opacity-40'}`}><Icon name="Ticket" size={18} /><span className="text-[8px] font-black uppercase">Á•®Âà∏</span></button>
                            <button onClick={() => setCurrentTab('expenses')} className={`flex-1 flex flex-col items-center gap-0.5 ${currentTab === 'expenses' ? 'text-[#5D4037]' : 'text-[#8E7D6A] opacity-40'}`}><Icon name="Wallet" size={18} /><span className="text-[8px] font-black uppercase">Ë®òÂ∏≥</span></button>
                            <button onClick={() => setCurrentTab('stay')} className={`flex-1 flex flex-col items-center gap-0.5 ${currentTab === 'stay' ? 'text-[#5D4037]' : 'text-[#8E7D6A] opacity-40'}`}><Icon name="Hotel" size={18} /><span className="text-[8px] font-black uppercase">‰ΩèÂÆø</span></button>
                            <button onClick={() => setCurrentTab('shopping')} className={`flex-1 flex flex-col items-center gap-0.5 ${currentTab === 'shopping' ? 'text-[#5D4037]' : 'text-[#8E7D6A] opacity-40'}`}><Icon name="ShoppingBag" size={18} /><span className="text-[8px] font-black uppercase">Ë≥ºÁâ©</span></button>
                        </nav>
                        
                        {/* Overlay ÂΩàÁ™ó (ÈªûÊìäÂúñÁâá/Âç°ÁâáÂç≥ÂèØÈóúÈñâ) */}
                        {selectedOverlay && (
                            <div className="fixed inset-0 z-[100] overlay-backdrop flex flex-col items-center justify-center p-6 animate-fade-in cursor-pointer" onClick={closeOverlay}>
                                <div className="w-full max-w-[340px] pointer-events-auto cursor-pointer" onClick={closeOverlay}>
                                    <div className="bg-[#FAF9F6] p-6 rounded-[2.5rem] shadow-2xl relative overflow-hidden text-[#5D4037] border border-[#EAE3D2]">
                                        <div className="absolute inset-0 pointer-events-none opacity-[0.03] dot-grid"></div>
                                        <div className="flex justify-between items-center mb-5 border-b border-[#EAE3D2] pb-4 px-1 relative z-20">
                                            <div className="text-left flex-1"><h3 className="font-black text-lg leading-tight">{selectedOverlay.name || selectedOverlay.title}</h3><p className="text-[7px] font-bold text-[#A69076] mt-0.5 uppercase tracking-widest">{selectedOverlay.isVJW ? 'Portal' : activeTraveler.name + ' Â∞àÂ±¨'}</p></div>
                                            <button onClick={() => setSelectedOverlay(null)} className="text-[#8B5E3C] p-2 hover:bg-stone-100 rounded-full transition-colors relative z-30"><Icon name="X" size={24} /></button>
                                        </div>
                                        <div className="bg-white rounded-[2rem] overflow-hidden border border-dashed border-[#D6C5A0] flex flex-col items-center justify-center min-h-[350px] p-2 shadow-inner text-[#4A3728] relative z-20">
                                            {selectedOverlay.isVJW ? (
                                                <div className="p-6 w-full flex flex-col items-center text-center">
                                                    <div className="bg-orange-50 p-5 rounded-full mb-6 text-orange-400"><Icon name="Zap" size={48} /></div>
                                                    <h4 className="text-sm font-black mb-2 uppercase tracking-widest text-[#4A3728]">Visit Japan Web</h4>
                                                    <div className="p-3 bg-[#F9F8F6] rounded-xl border border-[#EAE3D2] w-full mb-6">
                                                        <p className="text-[7px] font-black text-[#A69076] uppercase tracking-widest mb-1 text-center text-[#A69076]">‰πòÂÆ¢È†êË®ÇÁ∑®Ëôü</p>
                                                        <p className="text-lg font-black text-[#5D4037] tracking-widest text-center text-[#5D4037]">{selectedOverlay.assignments[activeTraveler.id].code}</p>
                                                    </div>
                                                    <button onClick={(e) => { e.stopPropagation(); window.open(selectedOverlay.vjwLink); }} className="w-full bg-[#5D4037] text-white py-4 rounded-2xl font-black text-[11px] shadow-xl hover:bg-[#4A3728] transition-all active:scale-95 text-white">Á´ãÂç≥Â°´ÂØ´</button>
                                                </div>
                                            ) : selectedOverlay.isJR ? (
                                                <div className="p-4 w-full text-left text-[#4A3728]">
                                                    <p className="text-[7px] font-black text-[#8E7D6A] uppercase mb-1.5 tracking-widest opacity-60">Reservation Details</p>
                                                    <p className="text-lg font-black text-[#5D4037] mb-2 text-[#5D4037]">{selectedOverlay.details.no}</p>
                                                    <p className="text-[10px] font-bold opacity-60 text-[#4A3728]">{selectedOverlay.details.notice}</p>
                                                </div>
                                            ) : selectedOverlay.currentImg || selectedOverlay.img ? (
                                                <img src={selectedOverlay.currentImg || selectedOverlay.img} className="w-full h-auto object-contain rounded-2xl shadow-sm" alt="Ticket" />
                                            ) : (
                                                <div className="text-center opacity-10"><Icon name="QrCode" size={100} /><p className="text-[10px] mt-2 font-black uppercase tracking-widest text-[#4A3728]">VOID</p></div>
                                            )}
                                        </div>
                                        <p className="text-[7px] text-center mt-6 opacity-40 font-bold tracking-[0.2em] italic text-[#5D4037] relative z-20">ÈªûÊìä‰ªªÊÑèËôïÂç≥ÂèØËøîÂõûÂàóË°®</p>
                                    </div>
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
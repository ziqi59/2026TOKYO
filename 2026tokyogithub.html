<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>2026TOKYO æ—¥æœ¬æ—…è¡Œæ‰‹è¨˜</title>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <script src="https://unpkg.com/lucide-react@latest"></script>
  <style>
    @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
    .animate-fade-in { animation: fadeIn 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
    .no-scrollbar::-webkit-scrollbar { display: none; }
    * { -webkit-tap-highlight-color: transparent; outline: none; }
    .grain-overlay::before { content: ""; position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 50; opacity: 0.3; background-image: url("https://www.transparenttextures.com/patterns/natural-paper.png"); }
    .dot-grid { background-image: radial-gradient(#D6C5A0 0.5px, transparent 0.5px); background-size: 20px 20px; }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel" data-type="module">
    // 1. å¼•å…¥ Firebase 12.7.0 SDK
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
    import { getFirestore, collection, addDoc, onSnapshot, doc, updateDoc, query, getDocs, writeBatch, orderBy } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";

    // 2. Firebase é…ç½® (ç”±æ‚¨çš„æŒ‡ä»¤æ–°å¢)
    const firebaseConfig = {
      apiKey: "AIzaSyDtMfBIju6QfVxYITabuI5M9wxcSw2DNDE",
      authDomain: "tokyo-9bd2d.firebaseapp.com",
      projectId: "tokyo-9bd2d",
      storageBucket: "tokyo-9bd2d.firebasestorage.app",
      messagingSenderId: "265158726550",
      appId: "1:265158726550:web:19f3e19d1a7c2c4a7f43b7",
      measurementId: "G-DBL4MMPZYX"
    };

    // åˆå§‹åŒ– Firebase
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    const appId = 'tokyo-9bd2d';

    // 3. React æ‡‰ç”¨ç¨‹å¼ç¢¼
    const { useState, useEffect, useMemo } = React;
    const { 
      Plane, MapPin, Wallet, Trash2, Navigation, Star, Layout, 
      ShoppingBag, Train, Hotel, Utensils, Ticket,
      Check, Plus, ChevronDown, ChevronUp, Loader2, Store, MoreHorizontal, 
      Calculator, ArrowRight, Clock, Luggage, X, ImageIcon, 
      ChevronLeft, Sun, Cloud, CloudRain, Snowflake, QrCode, Map: MapIcon,
      CreditCard, Fingerprint, FileText, Info, Zap, Globe, ExternalLink
    } = LucideReact;

    // --- æ¨¡æ“¬æ°£è±¡æ•¸æ“š (ä¿ç•™åŸæœ¬é‚è¼¯) ---
    const getMockWeather = (dateStr) => {
      const day = parseInt(dateStr.split('/')[1]);
      if (day <= 17) return { icon: <Sun size={14} className="text-orange-400"/>, temp: '8Â°C', feel: '5Â°C', loc: 'å¤§é˜ª' };
      if (day === 18) return { icon: <Cloud size={14} className="text-gray-400"/>, temp: '6Â°C', feel: '3Â°C', loc: 'æ±äº¬' };
      if (day === 19) return { icon: <CloudRain size={14} className="text-blue-400"/>, temp: '4Â°C', feel: '1Â°C', loc: 'å¯Œå£«' };
      return { icon: <Snowflake size={14} className="text-blue-200"/>, temp: '-2Â°C', feel: '-6Â°C', loc: 'é•·é‡' };
    };

    const FujiIllustration = () => (
      <svg viewBox="0 0 200 100" className="w-12 h-auto opacity-20 text-[#8B5E3C]">
        <path d="M20,90 L100,20 L180,90 Z" fill="currentColor" />
        <path d="M80,37 L100,20 L120,37 Q100,45 80,37" fill="#FFFFFF" />
        <circle cx="160" cy="30" r="8" fill="#D6C5A0" />
      </svg>
    );

    function App() {
      const [user, setUser] = useState(null);
      const [currentTab, setCurrentTab] = useState('itinerary');
      const [expandedDateIndex, setExpandedDateIndex] = useState(null); 
      const [loading, setLoading] = useState(true);

      // --- æ—…ä¼´é…ç½® ---
      const travelers = useMemo(() => [
        { id: 'goldfish', name: 'é‡‘é­š', color: '#8B5E3C', emoji: 'ğŸ ' },
        { id: 'penguin', name: 'ä¼éµ', color: '#5D4037', emoji: 'ğŸ§' },
        { id: 'zhi', name: 'é˜¿æ™º', color: '#A69076', emoji: 'ğŸ¦‰' },
        { id: 'spasm', name: 'ç—™æ”£', color: '#D6C5A0', emoji: 'âš¡' }
      ], []);
      const [activeTraveler, setActiveTraveler] = useState(travelers[0]);

      // æ•¸æ“šç‹€æ…‹
      const [trips, setTrips] = useState([]);
      const [expenses, setExpenses] = useState([]);
      const [shoppingItems, setShoppingItems] = useState([]);
      const [selectedOverlay, setSelectedOverlay] = useState(null); 

      const [selectedAccDate, setSelectedAccDate] = useState('1/15');
      const [expRawAmount, setExpRawAmount] = useState(''); 
      const [expDesc, setExpDesc] = useState('');
      const [expType, setExpType] = useState('expense'); 
      const [expCategory, setExpCategory] = useState('ç¾é£Ÿ');

      const theme = {
        bg: 'bg-[#F5F2E9]', primary: 'text-[#4A3728]', secondary: 'text-[#8E7D6A]', 
        coffee: 'bg-[#5D4037]', border: 'border-[#EAE3D2]'
      };

      const dates = [
        { date: '1/15', weekday: 'æœ¨', title: 'ê’°æ¢…ç”°é€›é€›:.ã€‚.â˜†' },
        { date: '1/16', weekday: 'é‡‘', title: 'ê’°USJç’°çƒå½±åŸâ™¡ï¾' },
        { date: '1/17', weekday: 'åœŸ', title: 'ê’°å¥ˆè‰¯äº¬éƒ½éŠğœ—ğœš ï½¡Ëš' },
        { date: '1/18', weekday: 'æ—¥', title: 'ê’°å¤§é˜ªâ³æ±äº¬' },
        { date: '1/19', weekday: 'æœˆ', title: 'ê’°å¯Œå£«å±±ã®æ—¥âœ¿Ë–Â°' },
        { date: '1/20', weekday: 'ç«', title: 'ê’°æ ‚æ± æ»‘é›ªDay-1' },
        { date: '1/21', weekday: 'æ°´', title: 'ê’°æ ‚æ± æ»‘é›ªDay-2' },
        { date: '1/22', weekday: 'æœ¨', title: 'ê’°å¹³å®‰å›å®¶^. .^ à©­' },
      ];

      // --- è¡Œç¨‹æ•¸æ“š ---
      const defaultTripData = [
        { dateIndex: 0, startTime: '11:15', name: 'æ­ä¹˜åœ‹æ³°èˆªç©º', address: 'æ¡ƒåœ’æ©Ÿå ´', category: 'flight', note: 'CX 564 (11:15-14:55)' },
        { dateIndex: 0, startTime: '17:20', name: 'æ¢…ç”°è³¼ç‰©', address: 'JRæ¢…ç”°', category: 'shopping', note: 'æŠµé”å¾Œé€›æ¢…ç”°' },
        { dateIndex: 1, startTime: '7:40', name: 'æŠµé”ç’°çƒ', address: 'USJ', category: 'sightseeing', note: 'ç›´è¡é¦¬åŠ›æ­åœ’å€' }
      ];

      const financeCalc = useMemo(() => {
        const dayEntries = expenses.filter(e => e.date === selectedAccDate);
        const inc = dayEntries.filter(e => e.type === 'income').reduce((s, e) => s + Number(e.amount), 0);
        const exp = dayEntries.filter(e => e.type === 'expense').reduce((s, e) => s + Number(e.amount), 0);
        const cumulative = expenses.reduce((s, e) => s + (e.type === 'income' ? Number(e.amount) : -Number(e.amount)), 0);
        return { inc, exp, cumulative };
      }, [expenses, selectedAccDate]);

      // 4. ç™»å…¥é€£ç·š
      useEffect(() => {
        signInAnonymously(auth).catch(err => console.error("Firebase Login Error:", err));
        const unsubscribe = onAuthStateChanged(auth, setUser);
        return () => unsubscribe();
      }, []);

      // 5. è³‡æ–™è®€å–
      useEffect(() => {
        if (!user) return;
        
        // è®€å–è¡Œç¨‹
        const tripsRef = collection(db, 'artifacts', appId, 'public', 'data', 'trips');
        getDocs(tripsRef).then(snap => {
          if (snap.empty) {
            const batch = writeBatch(db);
            defaultTripData.forEach(item => batch.set(doc(tripsRef), { ...item, createdAt: new Date().toISOString() }));
            batch.commit();
          }
        });

        const unsubTrips = onSnapshot(tripsRef, (s) => setTrips(s.docs.map(doc => ({ id: doc.id, ...doc.data() }))));
        const unsubExp = onSnapshot(collection(db, 'expenses'), (s) => setExpenses(s.docs.map(doc => ({ id: doc.id, ...doc.data() }))));
        const unsubShop = onSnapshot(collection(db, 'shopping'), (s) => {
          setShoppingItems(s.docs.map(doc => ({ id: doc.id, ...doc.data() })));
          setLoading(false);
        });

        return () => { unsubTrips(); unsubExp(); unsubShop(); };
      }, [user]);

      const handleAddExpense = async (e) => {
        e.preventDefault();
        if (!expRawAmount || !expDesc) return;
        await addDoc(collection(db, 'expenses'), {
          amount: Number(expRawAmount), description: expDesc, type: expType,
          date: selectedAccDate, payer: activeTraveler.name, createdAt: new Date().toISOString()
        });
        setExpRawAmount(''); setExpDesc('');
      };

      if (loading) return (
        <div className="h-screen bg-[#F5F2E9] flex flex-col items-center justify-center">
          <Loader2 className="text-[#8B5E3C] animate-spin mb-4" size={48} />
          <p className="text-[#8B5E3C] font-bold animate-pulse">æ­£åœ¨æ•´ç† 2026 æ—¥æœ¬è¡Œè³‡æ–™...</p>
        </div>
      );

      return (
        <div className="flex justify-center bg-[#DED9CE] min-h-screen font-sans overflow-x-hidden">
          <div className="w-full max-w-[390px] min-h-screen bg-[#F5F2E9] shadow-2xl relative flex flex-col grain-overlay">
            {/* Header */}
            <header className="pt-8 pb-4 px-6 border-b border-[#EAE3D2]/50">
              <div className="flex justify-between items-center text-[#4A3728]">
                <h1 className="text-2xl font-bold tracking-tighter leading-none">æ—¥æœ¬æ—…è¡Œæ‰‹è¨˜</h1>
                <div className="flex gap-1.5">
                  {travelers.map(t => (
                    <button key={t.id} onClick={() => setActiveTraveler(t)} className={`w-7 h-7 rounded-full border flex items-center justify-center transition-all ${activeTraveler.id === t.id ? 'scale-110 shadow-md ring-2 ring-[#5D4037]/10' : 'opacity-40'}`} style={{ backgroundColor: t.color }}>
                      <span className="text-[10px]">{t.emoji}</span>
                    </button>
                  ))}
                </div>
              </div>
              <div className="mt-3 flex justify-between items-end opacity-50">
                <FujiIllustration />
                <span className="text-[7px] font-bold uppercase tracking-widest">{activeTraveler.name} è¦–è§’</span>
              </div>
            </header>

            <main className="px-5 pt-2 flex-1 overflow-y-auto no-scrollbar pb-24">
              {currentTab === 'itinerary' && (
                <div className="space-y-3 pt-2">
                  {dates.map((d, i) => (
                    <div key={i} className="bg-white border rounded-xl shadow-sm p-4 border-[#EAE3D2]">
                      <div className="flex items-center gap-4 text-[#4A3728]">
                        <div className="w-11 h-11 bg-[#5D4037] flex flex-col items-center justify-center rounded-lg shrink-0">
                          <span className="text-[7px] font-black text-white/50 uppercase leading-none mb-1">{d.weekday}</span>
                          <span className="text-base font-bold text-white tracking-tighter">{d.date.split('/')[1]}</span>
                        </div>
                        <div className="flex-1 font-bold text-[13px]">{d.title}</div>
                        <div className="text-right">{getMockWeather(d.date).icon}</div>
                      </div>
                    </div>
                  ))}
                </div>
              )}

              {currentTab === 'expenses' && (
                <div className="space-y-4 pt-2">
                  <div className="bg-[#5D4037] p-6 rounded-[2.5rem] shadow-xl text-white text-center">
                    <p className="text-[7px] font-black uppercase tracking-widest opacity-40">ç¸½é¤˜é¡ (ç´¯è¨ˆ)</p>
                    <h2 className="text-4xl font-bold tracking-tighter">Â¥{financeCalc.cumulative.toLocaleString()}</h2>
                  </div>
                  <form onSubmit={handleAddExpense} className="space-y-4 bg-white p-5 rounded-[2rem] border border-[#EAE3D2]">
                    <input value={expRawAmount} onChange={e => setExpRawAmount(e.target.value)} placeholder="é‡‘é¡ (æ—¥å¹£)" className="w-full bg-[#FAF9F6] border border-[#EAE3D2] rounded-xl text-[11px] px-4 py-3.5 outline-none font-mono" />
                    <input value={expDesc} onChange={e => setExpDesc(e.target.value)} placeholder="å‚™è¨»..." className="w-full bg-[#FAF9F6] border border-[#EAE3D2] rounded-xl text-[11px] px-4 py-3.5 outline-none" />
                    <button type="submit" className="w-full bg-[#5D4037] text-white py-3 rounded-xl shadow-lg flex justify-center"><Check size={18} /></button>
                  </form>
                  <div className="space-y-2">
                    {expenses.filter(e => e.date === selectedAccDate).map(exp => (
                      <div key={exp.id} className="flex justify-between items-center bg-white p-4 rounded-xl shadow-sm border border-[#EAE3D2]">
                        <div className="text-[#4A3728]">
                          <p className="text-xs font-bold">{exp.description}</p>
                          <p className="text-[8px] text-[#A69076] uppercase font-black">{exp.payer}</p>
                        </div>
                        <span className="text-sm font-black text-[#5D4037]">Â¥{exp.amount.toLocaleString()}</span>
                      </div>
                    ))}
                  </div>
                </div>
              )}
            </main>

            <nav className="fixed bottom-0 w-full max-w-[390px] bg-white/95 backdrop-blur-sm border-t border-[#EAE3D2] flex h-16 items-center z-50">
              <button onClick={() => setCurrentTab('itinerary')} className={`flex-1 flex flex-col items-center ${currentTab === 'itinerary' ? 'text-[#5D4037]' : 'text-[#8E7D6A] opacity-60'}`}><Layout size={20}/><span className="text-[8px] mt-1 font-black uppercase">è¡Œç¨‹</span></button>
              <button onClick={() => setCurrentTab('expenses')} className={`flex-1 flex flex-col items-center ${currentTab === 'expenses' ? 'text-[#5D4037]' : 'text-[#8E7D6A] opacity-60'}`}><Wallet size={20}/><span className="text-[8px] mt-1 font-black uppercase">è¨˜å¸³</span></button>
              <button onClick={() => setCurrentTab('shopping')} className={`flex-1 flex flex-col items-center ${currentTab === 'shopping' ? 'text-[#5D4037]' : 'text-[#8E7D6A] opacity-60'}`}><ShoppingBag size={20}/><span className="text-[8px] mt-1 font-black uppercase">è³¼ç‰©</span></button>
            </nav>
          </div>
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
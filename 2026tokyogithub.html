<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>2026TOKYO æ—¥æœ¬æ—…è¡Œæ‰‹è¨˜</title>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <script src="https://unpkg.com/lucide-react@latest"></script>
  <style>
    @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
    .animate-fade-in { animation: fadeIn 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
    .no-scrollbar::-webkit-scrollbar { display: none; }
    * { -webkit-tap-highlight-color: transparent; outline: none; }
    .grain-overlay::before { content: ""; position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 50; opacity: 0.3; background-image: url("https://www.transparenttextures.com/patterns/natural-paper.png"); }
    .dot-grid { background-image: radial-gradient(#D6C5A0 0.5px, transparent 0.5px); background-size: 20px 20px; }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
    import { getFirestore, collection, addDoc, onSnapshot, doc, updateDoc, query, getDocs, writeBatch, orderBy } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDtMfBIju6QfVxYITabuI5M9wxcSw2DNDE",
      authDomain: "tokyo-9bd2d.firebaseapp.com",
      projectId: "tokyo-9bd2d",
      storageBucket: "tokyo-9bd2d.firebasestorage.app",
      messagingSenderId: "265158726550",
      appId: "1:265158726550:web:19f3e19d1a7c2c4a7f43b7",
      measurementId: "G-DBL4MMPZYX"
    };

    const app = initializeApp(firebaseConfig);
    window.firebaseDB = getFirestore(app);
    window.firebaseAuth = getAuth(app);
    window.firestoreUtils = { collection, addDoc, onSnapshot, doc, updateDoc, query, getDocs, writeBatch, orderBy };
    window.authUtils = { signInAnonymously, onAuthStateChanged };
  </script>

  <script type="text/babel">
    const { useState, useEffect, useMemo } = React;
    const { 
      Plane, MapPin, Wallet, Trash2, Navigation, Star, Layout, ShoppingBag, Train, Hotel, Utensils, Ticket,
      Check, Plus, ChevronDown, ChevronUp, Loader2, Store, MoreHorizontal, Calculator, ArrowRight, Clock, 
      Luggage, X, Image: ImageIcon, ChevronLeft, Sun, Cloud, CloudRain, Snowflake, QrCode, Map: MapIcon,
      CreditCard, Fingerprint, FileText, Info, Zap, Globe, ExternalLink
    } = LucideReact;

    const getMockWeather = (dateStr) => {
      const day = parseInt(dateStr.split('/')[1]);
      if (day <= 17) return { icon: <Sun size={14} className="text-orange-400"/>, temp: '8Â°C', feel: '5Â°C', loc: 'å¤§é˜ª' };
      if (day === 18) return { icon: <Cloud size={14} className="text-gray-400"/>, temp: '6Â°C', feel: '3Â°C', loc: 'æ±äº¬' };
      if (day === 19) return { icon: <CloudRain size={14} className="text-blue-400"/>, temp: '4Â°C', feel: '1Â°C', loc: 'å¯Œå£«' };
      return { icon: <Snowflake size={14} className="text-blue-200"/>, temp: '-2Â°C', feel: '-6Â°C', loc: 'é•·é‡' };
    };

    const FujiIllustration = () => (
      <svg viewBox="0 0 200 100" className="w-12 h-auto opacity-20 text-[#8B5E3C]">
        <path d="M20,90 L100,20 L180,90 Z" fill="currentColor" />
        <path d="M80,37 L100,20 L120,37 Q100,45 80,37" fill="#FFFFFF" />
        <circle cx="160" cy="30" r="8" fill="#D6C5A0" />
      </svg>
    );

    function App() {
      const [user, setUser] = useState(null);
      const [currentTab, setCurrentTab] = useState('itinerary');
      const [expandedDateIndex, setExpandedDateIndex] = useState(null); 
      const [loading, setLoading] = useState(true);
      const [trips, setTrips] = useState([]);
      const [expenses, setExpenses] = useState([]);
      const [shoppingItems, setShoppingItems] = useState([]);
      const [selectedOverlay, setSelectedOverlay] = useState(null); 
      const [selectedAccDate, setSelectedAccDate] = useState('1/15');
      const [expRawAmount, setExpRawAmount] = useState(''); 
      const [expDesc, setExpDesc] = useState('');
      const [expType, setExpType] = useState('expense'); 
      const [expCategory, setExpCategory] = useState('ç¾é£Ÿ');
      const [activeShopCategory, setActiveShopCategory] = useState('è¶…å¸‚');
      const [newShopItemName, setNewShopItemName] = useState('');

      const travelers = useMemo(() => [
        { id: 'goldfish', name: 'é‡‘é­š', color: '#8B5E3C', emoji: 'ğŸ ' },
        { id: 'penguin', name: 'ä¼éµ', color: '#5D4037', emoji: 'ğŸ§' },
        { id: 'zhi', name: 'é˜¿æ™º', color: '#A69076', emoji: 'ğŸ¦‰' },
        { id: 'spasm', name: 'ç—™æ”£', color: '#D6C5A0', emoji: 'âš¡' }
      ], []);
      const [activeTraveler, setActiveTraveler] = useState(travelers[0]);

      const appId = 'japan-2026-complete-edition';
      const theme = { bg: 'bg-[#F5F2E9]', primary: 'text-[#4A3728]', coffee: 'bg-[#5D4037]', border: 'border-[#EAE3D2]' };
      
      const dates = [
        { date: '1/15', weekday: 'æœ¨', title: 'ê’°æ¢…ç”°é€›é€›:.ã€‚.â˜†' },
        { date: '1/16', weekday: 'é‡‘', title: 'ê’°USJç’°çƒå½±åŸâ™¡ï¾' },
        { date: '1/17', weekday: 'åœŸ', title: 'ê’°å¥ˆè‰¯äº¬éƒ½éŠğœ—ğœš ï½¡Ëš' },
        { date: '1/18', weekday: 'æ—¥', title: 'ê’°å¤§é˜ªâ³æ±äº¬' },
        { date: '1/19', weekday: 'æœˆ', title: 'ê’°å¯Œå£«å±±ã®æ—¥âœ¿Ë–Â°' },
        { date: '1/20', weekday: 'ç«', title: 'ê’°æ ‚æ± æ»‘é›ªDay-1' },
        { date: '1/21', weekday: 'æ°´', title: 'ê’°æ ‚æ± æ»‘é›ªDay-2' },
        { date: '1/22', weekday: 'æœ¨', title: 'ê’°å¹³å®‰å›å®¶^. .^ à©­' },
      ];

      const staysData = [
        { name: 'Apartment Hotel 11 Higashi Umeda', period: '1/15 â€” 1/18 (å¤§é˜ª)', checkIn: '15:00', checkOut: '11:00', distance: 'å¤§é˜ªç«™æ­¥è¡Œ 12 åˆ†é˜', note: 'å¯†ç¢¼é–è‡ªåŠ©å…¥ä½ã€‚' },
        { name: 'Shinjuku sprem', period: '1/18 â€” 1/19 (æ±äº¬)', checkIn: '16:00', checkOut: '10:00', distance: 'æ–°å®¿å—å£æ­¥è¡Œ 10 åˆ†é˜', note: 'æ³¨æ„ï¼šåªæœ‰æ¨“æ¢¯ã€‚' },
        { name: 'Sotetsu Fresa Inn å–„å…‰å¯ºå£', period: '1/19 â€” 1/22 (é•·é‡)', checkIn: '15:00', checkOut: '11:00', distance: 'é•·é‡ç«™å–„å…‰å¯ºå£æ­£å°é¢', note: 'äº¤é€šæ¥µç‚ºä¾¿åˆ©ã€‚' }
      ];

      const ticketsData = [
        { id: 'flight_cx564', type: 'Flight', airline: 'Cathay Pacific', flightNo: 'CX 564', title: 'å°åŒ—ä¸€èˆª â” å¤§é˜ªä¸€èˆª', date: '1/15 11:15', depTime: '11:15', arrTime: '14:55', isVJW: true, vjwLink: 'https://www.vjw.digital.go.jp/main/#/vjwpco001', assignments: { goldfish: { seat: 'å¾…é¸ä½', code: 'DGL2ET' }, penguin: { seat: 'å¾…é¸ä½', code: 'DGL2ET' }, zhi: { seat: 'å¾…é¸ä½', code: 'DH5MG7' }, spasm: { seat: 'å¾…é¸ä½', code: 'DH5MG7' } } },
        { id: 'jr_pass', type: 'Pass', title: 'é—œè¥¿åœ°å€éµè·¯å‘¨éŠåˆ¸', date: '1/15 â€” 1/17', isJR: true, details: { no: '40376', id: 'ADD0534L', card: 'æœ«å››ç¢¼ 1668', notice: 'é ˜å–éœ€ï¼šä¿¡ç”¨å¡ + 4ç¢¼èªè­‰ç¢¼ + è­·ç…§æ­£æœ¬' } },
        { id: 'usj_ticket', type: 'Ticket', title: 'æ—¥æœ¬ç’°çƒå½±åŸé–€ç¥¨ (USJ)', date: '1/16', isUSJ: true, assignments: { goldfish: { seat: 'å…¥å ´ QR' }, penguin: { seat: 'å…¥å ´ QR' }, zhi: { seat: 'å…¥å ´ QR' }, spasm: { seat: 'å…¥å ´ QR' } } }
      ];

      const couponData = [
        { id: 1, name: 'å”å‰è¨¶å¾· (Donki)', discount: '10% å…ç¨… + 5% OFF', img: 'https://images.unsplash.com/photo-1596464716127-f2a82984de30?q=80&w=800' },
        { id: 2, name: 'æ¾æœ¬æ¸… (è—¥å¦)', discount: 'æœ€å¤§ 7% OFF', img: 'https://images.unsplash.com/photo-1618005182384-a83a8bd57fbe?q=80&w=800' }
      ];

      const usjMapData = { title: 'ç’°çƒå½±åŸåœ’å€åœ°åœ–', type: 'Map', qr: 'USJ-MAP' };

      const accountingCategories = {
        expense: [{ name: 'ç¾é£Ÿ', icon: <Utensils size={14}/> }, { name: 'è¶…å•†', icon: <Store size={14}/> }, { name: 'ç¥¨åˆ¸', icon: <Ticket size={14}/> }, { name: 'äº¤é€š', icon: <Train size={14}/> }, { name: 'å…¶ä»–', icon: <MoreHorizontal size={14}/> }],
        income: [{ name: 'åŸºé‡‘', icon: <Wallet size={14}/> }, { name: 'ç½°æ¬¾', icon: <Star size={14}/> }]
      };

      const sortedDayTrips = (dayTrips) => [...dayTrips].sort((a, b) => (a.startTime || '00:00').localeCompare(b.startTime || '00:00'));

      const financeCalc = useMemo(() => {
        const dayEntries = expenses.filter(e => e.date === selectedAccDate);
        const inc = dayEntries.filter(e => e.type === 'income').reduce((s, e) => s + Number(e.amount), 0);
        const exp = dayEntries.filter(e => e.type === 'expense').reduce((s, e) => s + Number(e.amount), 0);
        const totalNet = expenses.reduce((s, e) => s + (e.type === 'income' ? Number(e.amount) : -Number(e.amount)), 0);
        return { inc, exp, cumulative: totalNet };
      }, [expenses, selectedAccDate]);

      useEffect(() => {
        const check = setInterval(() => {
          if (window.authUtils && window.firebaseAuth) {
            clearInterval(check);
            window.authUtils.signInAnonymously(window.firebaseAuth).catch(console.error);
            window.authUtils.onAuthStateChanged(window.firebaseAuth, setUser);
          }
        }, 100);
        return () => clearInterval(check);
      }, []);

      useEffect(() => {
        if (!user || !window.firebaseDB) return;
        const { collection, onSnapshot, query, orderBy } = window.firestoreUtils;
        const unsubExp = onSnapshot(query(collection(window.firebaseDB, 'expenses'), orderBy('createdAt', 'desc')), (s) => setExpenses(s.docs.map(doc => ({ id: doc.id, ...doc.data() }))));
        const unsubShop = onSnapshot(collection(window.firebaseDB, 'shopping'), (s) => {
          setShoppingItems(s.docs.map(doc => ({ id: doc.id, ...doc.data() })));
          setLoading(false);
        });
        return () => { unsubExp(); unsubShop(); };
      }, [user]);

      const handleAddExpense = async (e) => {
        e.preventDefault();
        const amt = expRawAmount.replace(/[^-+*/().0-9]/g, '');
        const calculated = amt ? new Function(`return ${amt}`)() : 0;
        if (calculated === 0 || !expDesc) return;
        await window.firestoreUtils.addDoc(window.firestoreUtils.collection(window.firebaseDB, 'expenses'), {
          amount: Number(calculated), description: expDesc, type: expType, category: expCategory,
          date: selectedAccDate, payer: activeTraveler.name, createdAt: new Date().toISOString()
        });
        setExpRawAmount(''); setExpDesc('');
      };

      const togglePurchased = async (item) => {
        await window.firestoreUtils.updateDoc(window.firestoreUtils.doc(window.firebaseDB, 'shopping', item.id), { purchased: !item.purchased });
      };

      if (loading) return <div className="h-screen bg-[#F5F2E9] flex flex-col items-center justify-center font-bold text-[#8B5E3C]"><Loader2 className="animate-spin mb-4" size={48} />æ­£åœ¨åŒæ­¥ 2026 æ—¥æœ¬è¡Œè³‡æ–™...</div>;

      return (
        <div className="flex justify-center bg-[#DED9CE] min-h-screen font-sans">
          <div className="w-full max-w-[390px] min-h-screen bg-[#F5F2E9] shadow-2xl relative flex flex-col grain-overlay overflow-hidden">
            <header className="pt-8 pb-4 px-6 border-b border-[#EAE3D2]/50">
              <div className="flex justify-between items-center">
                <h1 className="text-2xl font-bold text-[#4A3728]">æ—¥æœ¬æ—…è¡Œæ‰‹è¨˜</h1>
                <div className="flex gap-1.5">
                  {travelers.map(t => (
                    <button key={t.id} onClick={() => setActiveTraveler(t)} className={`w-7 h-7 rounded-full border flex items-center justify-center transition-all ${activeTraveler.id === t.id ? 'scale-110 shadow-md ring-2 ring-[#5D4037]/10' : 'opacity-40'}`} style={{ backgroundColor: t.color }}>
                      <span className="text-[10px]">{t.emoji}</span>
                    </button>
                  ))}
                </div>
              </div>
              <div className="mt-3 flex justify-between items-end opacity-50"><FujiIllustration /><span className="text-[7px] font-bold uppercase">{activeTraveler.name} è¦–è§’</span></div>
            </header>

            <main className="px-5 pt-2 flex-1 overflow-y-auto no-scrollbar pb-32">
              {currentTab === 'itinerary' && (
                <div className="space-y-3 pt-2">
                  {dates.map((d, i) => (
                    <div key={i} className="bg-white border rounded-xl shadow-sm overflow-hidden border-[#EAE3D2]">
                      <button onClick={() => setExpandedDateIndex(expandedDateIndex === i ? null : i)} className="w-full p-3.5 flex items-center gap-4 text-left">
                        <div className="w-11 h-11 bg-[#5D4037] flex flex-col items-center justify-center rounded-lg text-white">
                          <span className="text-[7px] font-black uppercase">{d.weekday}</span><span className="text-base font-bold">{d.date.split('/')[1]}</span>
                        </div>
                        <div className="flex-1 font-bold text-[13px]">{d.title}</div>
                        {getMockWeather(d.date).icon}
                        {expandedDateIndex === i ? <ChevronUp size={16}/> : <ChevronDown size={16}/>}
                      </button>
                      {expandedDateIndex === i && <div className="px-5 pb-5 border-t pt-4 text-xs opacity-50 text-center italic">è¡Œç¨‹ç´°ç¯€è¼‰å…¥ä¸­... (è«‹æ‰‹å‹•å¡«å¯«è¡Œç¨‹è³‡æ–™æ–¼ Firestore)</div>}
                    </div>
                  ))}
                </div>
              )}

              {currentTab === 'tickets' && (
                <div className="space-y-4 pt-2">
                  {ticketsData.map((tk, i) => (
                    <button key={tk.id} onClick={() => setSelectedOverlay(tk)} className="w-full text-left bg-white border p-5 rounded-2xl shadow-xl border-[#EAE3D2]">
                      <div className="flex justify-between items-start mb-2"><span className="text-[7px] font-black uppercase px-2 py-0.5 rounded-sm bg-[#D6C5A0]">{tk.type}</span><span className="text-[9px] font-bold text-[#A69076]">{tk.date}</span></div>
                      <p className="text-[13px] font-bold">{tk.title}</p>
                      <div className="mt-4 flex justify-between items-end border-t border-dashed border-[#F3EFE0] pt-3">
                        <div><p className="text-[7px] font-black uppercase opacity-40">Holder</p><p className="text-[10px] font-black text-[#8B5E3C]">{activeTraveler.name}</p></div><QrCode size={14} className="opacity-40" />
                      </div>
                    </button>
                  ))}
                </div>
              )}

              {currentTab === 'expenses' && (
                <div className="space-y-4 pt-2">
                  <div className="bg-[#5D4037] p-6 rounded-[2.5rem] shadow-xl text-white text-center">
                    <p className="text-[7px] font-black uppercase tracking-[0.4em] opacity-40 mb-1">Accumulated Balance (Â¥)</p>
                    <h2 className="text-4xl font-bold tracking-tighter">Â¥{financeCalc.cumulative.toLocaleString()}</h2>
                  </div>
                  <div className="bg-white border p-5 rounded-[2rem] shadow-sm border-[#EAE3D2]">
                    <div className="flex gap-2 mb-4 bg-[#F3EFE0] p-1 rounded-xl">
                      <button onClick={() => setExpType('expense')} className={`flex-1 py-1.5 text-[9px] font-black rounded-lg ${expType === 'expense' ? 'bg-[#5D4037] text-white' : 'text-[#8E7D6A]'}`}>æ”¯å‡º</button>
                      <button onClick={() => setExpType('income')} className={`flex-1 py-1.5 text-[9px] font-black rounded-lg ${expType === 'income' ? 'bg-[#D6C5A0] text-[#4A3728]' : 'text-[#8E7D6A]'}`}>æ”¶å…¥</button>
                    </div>
                    <form onSubmit={handleAddExpense} className="space-y-4">
                      <input value={expRawAmount} onChange={e => setExpRawAmount(e.target.value)} placeholder="é‡‘é¡ (æ”¯æ´ 100+50)" className="w-full bg-[#FAF9F6] border border-[#EAE3D2] rounded-xl text-[11px] px-4 py-3 outline-none font-mono" />
                      <div className="flex gap-2"><input value={expDesc} onChange={e => setExpDesc(e.target.value)} placeholder="å‚™è¨»..." className="flex-1 bg-[#FAF9F6] border border-[#EAE3D2] rounded-xl text-[11px] px-4 py-3 outline-none" /><button type="submit" className="bg-[#5D4037] text-white px-5 rounded-xl shadow-lg"><Check size={18}/></button></div>
                    </form>
                  </div>
                  <div className="space-y-2">
                    {expenses.filter(e => e.date === selectedAccDate).map(exp => (
                      <div key={exp.id} className="flex items-center justify-between bg-white p-4 rounded-xl shadow-sm border border-[#EAE3D2]">
                         <div><p className="text-[12px] font-bold text-[#4A3728]">{exp.description}</p><p className="text-[8px] text-[#A69076] uppercase font-black">{exp.payer} â€¢ {exp.category}</p></div>
                         <span className={`text-[13px] font-black ${exp.type === 'income' ? 'text-green-600' : 'text-[#5D4037]'}`}>Â¥{exp.amount.toLocaleString()}</span>
                      </div>
                    ))}
                  </div>
                </div>
              )}

              {currentTab === 'stay' && (
                <div className="space-y-4 pt-2">
                  {staysData.map((h, i) => (
                    <div key={i} className="bg-white border border-[#EAE3D2] p-5 rounded-2xl shadow-sm text-[#4A3728]">
                      <h4 className="font-black text-[13px] flex items-center gap-2 mb-1 text-[#5D4037]"><Hotel size={14}/> {h.name}</h4>
                      <p className="text-[9px] text-[#A68B6A] mb-4 font-bold uppercase tracking-widest">{h.period}</p>
                      <div className="grid grid-cols-2 gap-3 mb-4 text-xs font-black">
                        <div className="bg-[#FAF9F6] p-2 rounded-lg border border-[#EAE3D2] text-center">Check-In<br/>{h.checkIn}</div>
                        <div className="bg-[#FAF9F6] p-2 rounded-lg border border-[#EAE3D2] text-center">Check-Out<br/>{h.checkOut}</div>
                      </div>
                      <p className="text-[10px] opacity-70"><Navigation size={10} className="inline mr-1"/> {h.distance}</p>
                      <p className="bg-[#F5F2E9]/50 p-2 rounded mt-2 text-[9px] italic border-l-2 border-[#D6C5A0]">âš ï¸ {h.note}</p>
                    </div>
                  ))}
                </div>
              )}

              {currentTab === 'shopping' && (
                <div className="space-y-4 pt-2">
                  <div className="grid grid-cols-5 gap-1 p-1 bg-[#F3EFE0] rounded-xl">
                    {['è¶…å¸‚', 'è¶…å•†', 'å”å‰', 'ç¾å¦', 'å„ªæƒ åˆ¸'].map(cat => (
                      <button key={cat} onClick={() => setActiveShopCategory(cat)} className={`py-1.5 text-[9px] font-black rounded transition-all ${activeShopCategory === cat ? 'bg-[#5D4037] text-white shadow-md' : 'text-[#8B5E3C]'}`}>{cat}</button>
                    ))}
                  </div>
                  {activeShopCategory === 'å„ªæƒ åˆ¸' ? (
                    <div className="grid grid-cols-2 gap-3">
                      {couponData.map(cp => (
                        <div key={cp.id} className="bg-white border rounded-xl overflow-hidden shadow-sm" onClick={() => setSelectedOverlay({ ...cp, title: cp.name, type: 'Coupon', qr: cp.discount })}>
                          <img src={cp.img} className="h-20 w-full object-cover opacity-80" alt={cp.name} />
                          <div className="p-2 text-[#4A3728]"><p className="text-[10px] font-black leading-tight">{cp.name}</p><p className="text-[8px] font-bold text-red-500">{cp.discount}</p></div>
                        </div>
                      ))}
                    </div>
                  ) : (
                    <div className="bg-white border rounded-2xl p-4 min-h-[300px] flex flex-col">
                      <h2 className="text-xs font-black mb-4 uppercase tracking-widest opacity-40"><ShoppingBag size={12} className="inline mr-1"/> {activeTraveler.name} çš„ {activeShopCategory}</h2>
                      <div className="flex-1 space-y-2 overflow-y-auto">
                        {shoppingItems.filter(item => item.travelerId === activeTraveler.id && item.category === activeShopCategory).map(item => (
                          <button key={item.id} onClick={() => togglePurchased(item)} className="flex items-center gap-3 p-2 border-b border-stone-50 w-full text-left group">
                            <div className={`w-4 h-4 border rounded-sm flex items-center justify-center ${item.purchased ? 'bg-[#5D4037] border-[#5D4037]' : 'bg-white border-[#D6C5A0]'}`}>{item.purchased && <Check size={12} className="text-white"/>}</div>
                            <span className={`text-xs ${item.purchased ? 'line-through opacity-30 italic' : 'text-[#4A3728]'}`}>{item.name}</span>
                          </button>
                        ))}
                      </div>
                      <form onSubmit={async (e) => {
                        e.preventDefault(); if (!newShopItemName) return;
                        await window.firestoreUtils.addDoc(window.firestoreUtils.collection(window.firebaseDB, 'shopping'), { name: newShopItemName, travelerId: activeTraveler.id, category: activeShopCategory, purchased: false });
                        setNewShopItemName('');
                      }} className="mt-4 flex gap-2 pt-4 border-t">
                        <input value={newShopItemName} onChange={e => setNewShopItemName(e.target.value)} placeholder="æ–°å¢..." className="flex-1 bg-[#F9F8F6] border px-3 py-2 text-[11px] rounded-xl outline-none" />
                        <button type="submit" className="bg-[#5D4037] text-white px-4 rounded-xl shadow-md"><Plus size={16}/></button>
                      </form>
                    </div>
                  )}
                </div>
              )}
            </main>

            <nav className="shrink-0 bg-white/95 backdrop-blur-sm border-t border-[#EAE3D2] flex h-16 items-center px-1 fixed bottom-0 w-full max-w-[390px] z-[60] shadow-2xl">
               <NavIconButton active={currentTab === 'itinerary'} onClick={() => setCurrentTab('itinerary')} icon={<Layout size={18}/>} label="è¡Œç¨‹" />
               <NavIconButton active={currentTab === 'tickets'} onClick={() => setCurrentTab('tickets')} icon={<Ticket size={18}/>} label="ç¥¨åˆ¸" />
               <NavIconButton active={currentTab === 'expenses'} onClick={() => setCurrentTab('expenses')} icon={<Wallet size={18}/>} label="è¨˜å¸³" />
               <NavIconButton active={currentTab === 'stay'} onClick={() => setCurrentTab('stay')} icon={<Hotel size={18}/>} label="ä½å®¿" />
               <NavIconButton active={currentTab === 'shopping'} onClick={() => setCurrentTab('shopping')} icon={<ShoppingBag size={18}/>} label="è³¼ç‰©" />
            </nav>

            {selectedOverlay && (
              <div className="fixed inset-0 z-[100] bg-black/95 backdrop-blur-md flex items-center justify-center p-6" onClick={() => setSelectedOverlay(null)}>
                <div className="bg-[#FAF9F6] p-6 rounded-[2.5rem] w-full max-w-[340px] shadow-2xl text-center relative" onClick={e => e.stopPropagation()}>
                  <h3 className="font-black text-lg mb-2 text-[#4A3728]">{selectedOverlay.title || selectedOverlay.name}</h3>
                  <p className="text-[7px] font-black text-[#A69076] uppercase tracking-[0.2em] mb-6">{selectedOverlay.isVJW ? 'Immigration Portal' : 'Official Document'}</p>
                  <div className="bg-white p-8 border-2 border-dashed border-[#D6C5A0] rounded-[2rem] shadow-inner">
                    {selectedOverlay.isVJW ? (
                      <div className="space-y-4">
                        <div className="p-3 bg-[#F9F8F6] rounded-xl border border-[#EAE3D2]">
                          <p className="text-[7px] font-black opacity-40 uppercase mb-1">é è¨‚ç·¨è™Ÿ</p>
                          <p className="text-xl font-black text-[#5D4037] tracking-widest">{selectedOverlay.assignments[activeTraveler.id].code}</p>
                        </div>
                        <button onClick={() => window.open(selectedOverlay.vjwLink)} className="w-full bg-[#5D4037] text-white py-4 rounded-2xl font-black text-[11px] shadow-xl flex items-center justify-center gap-2"><Globe size={14}/> å‰å¾€ Visit Japan Web</button>
                      </div>
                    ) : (
                      <img src={`https://api.qrserver.com/v1/create-qr-code/?size=250x250&data=${selectedOverlay.qr || 'REF:2026-TOKYO'}&color=4A3728`} className="mx-auto w-[200px] h-[200px]" alt="QR" />
                    )}
                    {selectedOverlay.assignments && !selectedOverlay.isVJW && <p className="mt-4 text-[10px] font-black text-[#8B5E3C]">æŒæœ‰è€…ï¼š{activeTraveler.name}</p>}
                  </div>
                  <p className="mt-8 text-[8px] font-black opacity-30 uppercase tracking-widest">é»æ“Šä»»æ„è™•è¿”å›</p>
                </div>
              </div>
            )}
          </div>
        </div>
      );
    }

    const NavIconButton = ({ active, onClick, icon, label }) => (
      <button onClick={onClick} className={`flex-1 flex flex-col items-center justify-center gap-1 transition-all ${active ? 'text-[#5D4037]' : 'text-[#8E7D6A] opacity-40'}`}>
        <div className={`transition-transform duration-300 ${active ? 'scale-110' : 'scale-100'}`}>{icon}</div>
        <span className="text-[9px] font-black uppercase tracking-tighter">{label}</span>
      </button>
    );

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>2026TOKYO æ—¥æœ¬æ—…è¡Œæ‰‹è¨˜</title>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <script src="https://unpkg.com/lucide-react@latest"></script>
  <style>
    @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
    .animate-fade-in { animation: fadeIn 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
    .no-scrollbar::-webkit-scrollbar { display: none; }
    * { -webkit-tap-highlight-color: transparent; outline: none; }
    .grain-overlay::before { content: ""; position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 50; opacity: 0.3; background-image: url("https://www.transparenttextures.com/patterns/natural-paper.png"); }
    .dot-grid { background-image: radial-gradient(#D6C5A0 0.5px, transparent 0.5px); background-size: 20px 20px; }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-analytics.js";
    import { getFirestore, collection, addDoc, onSnapshot, doc, updateDoc, query, getDocs, writeBatch } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDtMfBIju6QfVxYITabuI5M9wxcSw2DNDE",
      authDomain: "tokyo-9bd2d.firebaseapp.com",
      projectId: "tokyo-9bd2d",
      storageBucket: "tokyo-9bd2d.firebasestorage.app",
      messagingSenderId: "265158726550",
      appId: "1:265158726550:web:19f3e19d1a7c2c4a7f43b7",
      measurementId: "G-DBL4MMPZYX"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const analytics = getAnalytics(app);
    const db = getFirestore(app);
    const auth = getAuth(app);

    // å°‡ Firebase å¯¦ä¾‹æ›è¼‰åˆ° windowï¼Œä»¥ä¾¿ä¸‹æ–¹çš„ React ç¨‹å¼ç¢¼è®€å–
    window.firebaseDB = db;
    window.firebaseAuth = auth;
    window.firestoreLib = { collection, addDoc, onSnapshot, doc, updateDoc, query, getDocs, writeBatch };
    window.authLib = { signInAnonymously, onAuthStateChanged };
  </script>

  <script type="text/babel">
    const { useState, useEffect, useMemo } = React;
    const { 
      Plane, MapPin, Wallet, Trash2, Navigation, Star, Layout, 
      ShoppingBag, Train, Hotel, Utensils, Ticket,
      Check, Plus, ChevronDown, ChevronUp, Loader2, Store, MoreHorizontal, 
      Calculator, ArrowRight, Clock, Luggage, X, ImageIcon, 
      ChevronLeft, Sun, Cloud, CloudRain, Snowflake, QrCode, Map: MapIcon,
      CreditCard, Fingerprint, FileText, Info, Zap, Globe, ExternalLink
    } = LucideReact;

    // --- æ¨¡æ“¬æ°£è±¡æ•¸æ“š ---
    const getMockWeather = (dateStr) => {
      const day = parseInt(dateStr.split('/')[1]);
      if (day <= 17) return { icon: <Sun size={14} className="text-orange-400"/>, temp: '8Â°C', feel: '5Â°C', loc: 'å¤§é˜ª' };
      if (day === 18) return { icon: <Cloud size={14} className="text-gray-400"/>, temp: '6Â°C', feel: '3Â°C', loc: 'æ±äº¬' };
      if (day === 19) return { icon: <CloudRain size={14} className="text-blue-400"/>, temp: '4Â°C', feel: '1Â°C', loc: 'å¯Œå£«' };
      return { icon: <Snowflake size={14} className="text-blue-200"/>, temp: '-2Â°C', feel: '-6Â°C', loc: 'é•·é‡' };
    };

    const FujiIllustration = () => (
      <svg viewBox="0 0 200 100" className="w-12 h-auto opacity-20 text-[#8B5E3C]">
        <path d="M20,90 L100,20 L180,90 Z" fill="currentColor" />
        <path d="M80,37 L100,20 L120,37 Q100,45 80,37" fill="#FFFFFF" />
        <circle cx="160" cy="30" r="8" fill="#D6C5A0" />
      </svg>
    );

    function App() {
      const [user, setUser] = useState(null);
      const [currentTab, setCurrentTab] = useState('itinerary');
      const [expandedDateIndex, setExpandedDateIndex] = useState(null); 
      const [loading, setLoading] = useState(true);

      const travelers = useMemo(() => [
        { id: 'goldfish', name: 'é‡‘é­š', color: '#8B5E3C', emoji: 'ğŸ ' },
        { id: 'penguin', name: 'ä¼éµ', color: '#5D4037', emoji: 'ğŸ§' },
        { id: 'zhi', name: 'é˜¿æ™º', color: '#A69076', emoji: 'ğŸ¦‰' },
        { id: 'spasm', name: 'ç—™æ”£', color: '#D6C5A0', emoji: 'âš¡' }
      ], []);
      const [activeTraveler, setActiveTraveler] = useState(travelers[0]);

      const [trips, setTrips] = useState([]);
      const [expenses, setExpenses] = useState([]);
      const [shoppingItems, setShoppingItems] = useState([]);
      const [selectedOverlay, setSelectedOverlay] = useState(null); 

      const [selectedAccDate, setSelectedAccDate] = useState('1/15');
      const [expRawAmount, setExpRawAmount] = useState(''); 
      const [expDesc, setExpDesc] = useState('');
      const [expType, setExpType] = useState('expense'); 
      const [expCategory, setExpCategory] = useState('ç¾é£Ÿ');
      const [activeShopCategory, setActiveShopCategory] = useState('è¶…å¸‚');
      const [newShopItemName, setNewShopItemName] = useState('');

      const theme = {
        bg: 'bg-[#F5F2E9]', primary: 'text-[#4A3728]', secondary: 'text-[#8E7D6A]', 
        coffee: 'bg-[#5D4037]', border: 'border-[#EAE3D2]', timeTag: 'bg-[#F9F8F6]'
      };

      const dates = [
        { date: '1/15', weekday: 'æœ¨', title: 'ê’°æ¢…ç”°é€›é€›:.ã€‚.â˜†' },
        { date: '1/16', weekday: 'é‡‘', title: 'ê’°USJç’°çƒå½±åŸâ™¡ï¾' },
        { date: '1/17', weekday: 'åœŸ', title: 'ê’°å¥ˆè‰¯äº¬éƒ½éŠğœ—ğœš ï½¡Ëš' },
        { date: '1/18', weekday: 'æ—¥', title: 'ê’°å¤§é˜ªâ³æ±äº¬' },
        { date: '1/19', weekday: 'æœˆ', title: 'ê’°å¯Œå£«å±±ã®æ—¥âœ¿Ë–Â°' },
        { date: '1/20', weekday: 'ç«', title: 'ê’°æ ‚æ± æ»‘é›ªDay-1' },
        { date: '1/21', weekday: 'æ°´', title: 'ê’°æ ‚æ± æ»‘é›ªDay-2' },
        { date: '1/22', weekday: 'æœ¨', title: 'ê’°å¹³å®‰å›å®¶^. .^ à©­' },
      ];

      const defaultTripData = [
        { dateIndex: 0, startTime: '11:15', name: 'æ­ä¹˜åœ‹æ³°èˆªç©º', address: 'æ¡ƒåœ’æ©Ÿå ´', category: 'flight', note: '11:15-14:55\nå°åŒ—ä¸€èˆª â†’ å¤§é˜ªä¸€èˆª' },
        { dateIndex: 0, startTime: '16:00', name: 'å‡ºæµ·é—œ & é ˜å– JR Pass', address: 'é—œè¥¿æ©Ÿå ´ç¬¬ä¸€èˆªå»ˆ JR çª—å£', category: 'sightseeing', note: 'ã€é ˜ç¥¨é‡é»ã€‘é è¨‚ç·¨è™Ÿï¼š40376\néœ€æŒï¼šä¿¡ç”¨å¡(1668)+4ç¢¼å¯†ç¢¼+4äººè­·ç…§' },
        { dateIndex: 0, startTime: '16:30', name: 'æ­ä¹˜JR HARUKAç‰¹æ€¥', address: 'é—œè¥¿æ©Ÿå ´JR HARUKAæœˆå°', category: 'transport', note: 'ä½¿ç”¨é—œè¥¿åœ°å€éµè·¯å‘¨éŠåˆ¸ è‡ªç”±å¸­' },
        { dateIndex: 0, startTime: '17:20', name: 'æ¢…ç”°è³¼ç‰©', address: 'JRæ¢…ç”°', category: 'shopping', note: 'æ™šä¸Šå°±åœ¨æ¢…ç”°è³¼ç‰©' },
        { dateIndex: 0, startTime: 'æ™šé¤', name: 'é è¨ˆç‡’è‚‰è‚‰äº”éƒ', address: 'ç‡’è‚‰ è‚‰äº”éƒ å¤©æ»¿åº—', category: 'food', note: 'ç‡Ÿæ¥­æ™‚é–“ 11:00-23:00\nJRå¤§é˜ªç’°ç‹€ç·šå¤©æ»¿ç«™æ­¥è¡Œ3åˆ†é˜' },
        { dateIndex: 0, startTime: 'ä½å®¿', name: 'æ¢…ç”°ä½å®¿', address: 'https://maps.app.goo.gl/B9W2PwzGhuXaFTso8', category: 'hotel', note: 'Apartment Hotel 11 Higashi Umeda\nå¤§é˜ªç«™æ­¥è¡Œç´„ 12 åˆ†é˜' },
        { dateIndex: 1, startTime: '6:40', name: 'é£¯åº—å‡ºç™¼', address: 'JR å¤§é˜ªç«™', category: 'transport', note: 'æ­¥è¡Œç´„ 12 åˆ†é˜è‡³JRå¤§é˜ªç«™\nJRå¤§é˜ªç«™â†’è¥¿ä¹æ¢ç«™ æ­ä¹˜:JRå¤§é˜ªç’°ç‹€ç·š\næ—©é¤é è¨ˆåƒ711' },
        { dateIndex: 1, startTime: '7:40', name: 'æŠµé”ç’°çƒ', address: 'USJç’°çƒå½±åŸ', category: 'sightseeing', note: 'å…¥åœ’ç›´è¡é¦¬åŠ›æ­åœ’å€\n\nã€å…¥åœ’é ˆçŸ¥ã€‘\n1. ä¸‹è¼‰ App é ˜å–æ•´ç†åˆ¸\n2. å»ºè­° 7:00 å‰æŠµé”ç¾å ´æ’éšŠ\n3. ç¦å¸¶å¤–é£Ÿèˆ‡å¤§å®¹é‡é£²æ–™\n4. å‚™å¦¥é›»å­é–€ç¥¨ QR Code' },
        { dateIndex: 1, startTime: '20:00', name: 'é–‰åœ’æ™‚é–“', address: 'è¶…å¸‚', category: 'food', note: 'æ™šé¤é è¨ˆåƒè¶…å¸‚' },
        { dateIndex: 1, startTime: 'ä½å®¿', name: 'æ¢…ç”°ä½å®¿', address: 'https://maps.app.goo.gl/B9W2PwzGhuXaFTso8', category: 'hotel', note: 'Apartment Hotel 11 Higashi Umeda\nå¤§é˜ªç«™æ­¥è¡Œç´„ 12 åˆ†é˜' }
      ];

      const staysData = [
        { name: 'Apartment Hotel 11 Higashi Umeda', period: '1/15 â€” 1/18 (å¤§é˜ª)', checkIn: '15:00', checkOut: '11:00', distance: 'å¤§é˜ªç«™æ­¥è¡Œ 12 åˆ†é˜', note: 'å¯†ç¢¼é–è‡ªåŠ©å…¥ä½ã€‚' },
        { name: 'Shinjuku sprem', period: '1/18 â€” 1/19 (æ±äº¬)', checkIn: '16:00', checkOut: '10:00', distance: 'æ–°å®¿å—å£æ­¥è¡Œ 10 åˆ†é˜', note: 'æ³¨æ„ï¼šåªæœ‰æ¨“æ¢¯ã€‚' },
        { name: 'Sotetsu Fresa Inn å–„å…‰å¯ºå£', period: '1/19 â€” 1/22 (é•·é‡)', checkIn: '15:00', checkOut: '11:00', distance: 'é•·é‡ç«™å–„å…‰å¯ºå£æ­£å°é¢', note: 'äº¤é€šæ¥µç‚ºä¾¿åˆ©ã€‚' }
      ];

      const ticketsData = [
        { id: 'flight_cx564', type: 'Flight', airline: 'Cathay Pacific', flightNo: 'CX 564', title: 'å°åŒ—ä¸€èˆª â” å¤§é˜ªä¸€èˆª', date: '1/15 11:15', depTime: '11:15', arrTime: '14:55', isVJW: true, vjwLink: 'https://www.vjw.digital.go.jp/main/#/vjwpco001', assignments: { goldfish: { seat: 'å¾…é¸ä½', code: 'DGL2ET' }, penguin: { seat: 'å¾…é¸ä½', code: 'DGL2ET' }, zhi: { seat: 'å¾…é¸ä½', code: 'DH5MG7' }, spasm: { seat: 'å¾…é¸ä½', code: 'DH5MG7' } } },
        { id: 'jr_pass', type: 'Pass', title: 'é—œè¥¿åœ°å€éµè·¯å‘¨éŠåˆ¸', date: '1/15 â€” 1/17', isJR: true, description: 'JR-WEST Online Reservation', details: { no: '40376', id: 'ADD0534L', card: 'æœ«å››ç¢¼ 1668', notice: 'é ˜å–éœ€ï¼šä¿¡ç”¨å¡ + 4ç¢¼èªè­‰ç¢¼ + è­·ç…§æ­£æœ¬' } },
        { id: 'usj_ticket', type: 'Ticket', title: 'æ—¥æœ¬ç’°çƒå½±åŸé–€ç¥¨ (USJ)', date: '1/16', isUSJ: true, assignments: { goldfish: { seat: 'å…¥å ´ QR', img: 'https://lh3.googleusercontent.com/d/1OcyV3zuqQkXMTtOerNEoMBuXCuSxAoOK' }, penguin: { seat: 'å…¥å ´ QR', img: 'https://lh3.googleusercontent.com/d/1MzFWNFr9lKDFtwg902ziO4-KhLeKRPGL' }, zhi: { seat: 'å…¥å ´ QR', img: 'https://lh3.googleusercontent.com/d/1ic2KFekF4jO403KVeLGMmOamFoxVcu7r' }, spasm: { seat: 'å…¥å ´ QR', img: 'https://lh3.googleusercontent.com/d/1P82cswII_vEtvvVFIpb6Lj0sQqKBqyhq' } } }
      ];

      const couponData = [
        { id: 1, name: 'å”å‰è¨¶å¾· (Donki)', discount: '10% å…ç¨… + 5% OFF', img: 'https://images.unsplash.com/photo-1596464716127-f2a82984de30?q=80&w=800', isCoupon: true },
        { id: 2, name: 'æ¾æœ¬æ¸… (è—¥å¦)', discount: 'æœ€å¤§ 7% OFF', img: 'https://images.unsplash.com/photo-1618005182384-a83a8bd57fbe?q=80&w=800', isCoupon: true }
      ];

      const usjMapData = { title: 'ç’°çƒå½±åŸåœ’å€åœ°åœ–', currentImg: 'https://lh3.googleusercontent.com/d/1PmA35rbRYDdi9hc0ClNl8p4RAioCT32x', type: 'Map' };

      const accountingCategories = {
        expense: [{ name: 'ç¾é£Ÿ', icon: <Utensils size={14}/> }, { name: 'è¶…å•†', icon: <Store size={14}/> }, { name: 'ç¥¨åˆ¸', icon: <Ticket size={14}/> }, { name: 'äº¤é€š', icon: <Train size={14}/> }, { name: 'å…¶ä»–', icon: <MoreHorizontal size={14}/> }],
        income: [{ name: 'åŸºé‡‘', icon: <Wallet size={14}/> }, { name: 'ç½°æ¬¾', icon: <Star size={14}/> }]
      };

      const sortedDayTrips = (dayTrips) => {
        return [...dayTrips].sort((a, b) => {
          const getVal = (t) => {
            if (t === 'æ™šé¤') return '23:58';
            if (t === 'ä½å®¿') return '23:59';
            return t || '00:00';
          };
          return getVal(a.startTime).localeCompare(getVal(b.startTime));
        });
      };

      const calculatedAmount = useMemo(() => {
        try {
          const sanitized = expRawAmount.replace(/[^-+*/().0-9]/g, '');
          if (!sanitized) return 0;
          return new Function(`return ${sanitized}`)() || 0;
        } catch (e) { return 0; }
      }, [expRawAmount]);

      const financeCalc = useMemo(() => {
        const dailyMap = dates.reduce((acc, d) => {
          const dayEntries = expenses.filter(e => e.date === d.date);
          const inc = dayEntries.filter(e => e.type === 'income').reduce((s, e) => s + Number(e.amount), 0);
          const exp = dayEntries.filter(e => e.type === 'expense').reduce((s, e) => s + Number(e.amount), 0);
          acc[d.date] = { inc, exp, net: inc - exp };
          return acc;
        }, {});
        let total = 0;
        let current = { inc: 0, exp: 0, net: 0, cumulative: 0 };
        for (const d of dates) {
          const s = dailyMap[d.date] || { inc: 0, exp: 0, net: 0 };
          total += s.net;
          if (d.date === selectedAccDate) current = { ...s, cumulative: total };
        }
        return current;
      }, [expenses, selectedAccDate]);

      useEffect(() => {
        const checkFirebase = setInterval(() => {
          if (window.firebaseAuth && window.firebaseDB) {
            clearInterval(checkFirebase);
            window.authLib.signInAnonymously(window.firebaseAuth).catch(console.error);
            window.authLib.onAuthStateChanged(window.firebaseAuth, setUser);
          }
        }, 100);
        return () => clearInterval(checkFirebase);
      }, []);

      useEffect(() => {
        if (!user || !window.firebaseDB) return;
        const { collection, onSnapshot, getDocs, writeBatch, doc, query } = window.firestoreLib;
        const appId = 'tokyo-9bd2d';

        const tripsRef = collection(window.firebaseDB, 'artifacts', appId, 'public', 'data', 'trips');
        const expRef = collection(window.firebaseDB, 'artifacts', appId, 'public', 'data', 'expenses');
        const shopRef = collection(window.firebaseDB, 'artifacts', appId, 'public', 'data', 'shopping');

        getDocs(tripsRef).then(snap => {
          if (snap.empty) {
            const batch = writeBatch(window.firebaseDB);
            defaultTripData.forEach(item => batch.set(doc(tripsRef), { ...item, createdAt: new Date().toISOString() }));
            batch.commit();
          }
        });

        const unsubTrips = onSnapshot(tripsRef, (s) => setTrips(s.docs.map(doc => ({ id: doc.id, ...doc.data() }))));
        const unsubExp = onSnapshot(expRef, (s) => setExpenses(s.docs.map(doc => ({ id: doc.id, ...doc.data() }))));
        const unsubShop = onSnapshot(shopRef, (s) => {
          setShoppingItems(s.docs.map(doc => ({ id: doc.id, ...doc.data() })));
          setLoading(false);
        });
        return () => { unsubTrips(); unsubExp(); unsubShop(); };
      }, [user]);

      const handleAddExpense = async (e) => {
        e.preventDefault();
        if (calculatedAmount === 0 || !expDesc || !window.firebaseDB) return;
        const { collection, addDoc } = window.firestoreLib;
        const appId = 'tokyo-9bd2d';
        await addDoc(collection(window.firebaseDB, 'artifacts', appId, 'public', 'data', 'expenses'), {
          amount: calculatedAmount, description: expDesc, type: expType, category: expCategory,
          date: selectedAccDate, payer: activeTraveler.name, createdAt: new Date().toISOString()
        });
        setExpRawAmount(''); setExpDesc('');
      };

      const togglePurchased = async (item) => {
        if (!window.firebaseDB) return;
        const { doc, updateDoc } = window.firestoreLib;
        const appId = 'tokyo-9bd2d';
        await updateDoc(doc(window.firebaseDB, 'artifacts', appId, 'public', 'data', 'shopping', item.id), { purchased: !item.purchased });
      };

      if (loading) return <div className={`h-screen ${theme.bg} flex items-center justify-center`}><Loader2 className="text-[#8B5E3C] animate-spin" size={32} /></div>;

      return (
        <div className="flex justify-center bg-[#DED9CE] min-h-screen font-sans overflow-x-hidden selection:bg-[#5D4037]/10">
          <div className={`w-full max-w-[390px] min-h-screen ${theme.bg} shadow-2xl relative overflow-hidden flex flex-col grain-overlay`}>
            <div className="absolute inset-0 pointer-events-none opacity-[0.02] dot-grid z-0"></div>

            <div className="flex-1 overflow-y-auto no-scrollbar relative z-10 pb-36 text-[#4A3728]">
              <header className="pt-8 pb-4 px-6 shrink-0 relative border-b border-[#EAE3D2]/50">
                <div className="flex justify-between items-center text-[#4A3728]">
                  <h1 className="text-2xl font-bold tracking-tighter leading-none">æ—¥æœ¬æ—…è¡Œæ‰‹è¨˜</h1>
                  <div className="flex gap-1.5 text-[#4A3728]">
                    {travelers.map(t => (
                      <button key={t.id} onClick={() => setActiveTraveler(t)} className={`w-7 h-7 rounded-full border flex items-center justify-center transition-all duration-500 ${activeTraveler.id === t.id ? 'border-[#5D4037] scale-110 shadow-md ring-2 ring-[#5D4037]/10 z-10' : 'border-white/50 opacity-40 scale-90'}`} style={{ backgroundColor: t.color }}>
                        <span className="text-[10px]">{t.emoji}</span>
                      </button>
                    ))}
                  </div>
                </div>
                <div className="mt-3 flex justify-between items-end opacity-50">
                   <FujiIllustration />
                   <div className="flex items-center gap-1 bg-[#FAF9F6] px-2 py-0.5 rounded-full border border-[#EAE3D2]">
                      <div className="w-1 h-1 rounded-full animate-pulse" style={{ backgroundColor: activeTraveler.color }}></div>
                      <span className="text-[7px] font-bold text-[#8C7B68] uppercase tracking-widest">{activeTraveler.name} è¦–è§’</span>
                   </div>
                </div>
              </header>

              <main className="px-5 pt-2">
                {currentTab === 'itinerary' && (
                  <div className="space-y-3 pt-2">
                    {dates.map((d, i) => {
                      const isExpanded = expandedDateIndex === i;
                      const dayTrips = trips.filter(t => t.dateIndex === i);
                      const sortedTrips = sortedDayTrips(dayTrips);
                      const weather = getMockWeather(d.date);
                      return (
                        <div key={i} className="flex flex-col text-[#4A3728]">
                          <div className="bg-white border rounded-xl shadow-sm overflow-hidden border-[#EAE3D2]">
                            <button onClick={() => setExpandedDateIndex(isExpanded ? null : i)} className="w-full p-3.5 flex items-center gap-4 active:bg-stone-50 transition-all text-left">
                              <div className={`w-11 h-11 ${theme.coffee} flex flex-col items-center justify-center rounded-lg shadow-sm shrink-0`}>
                                <span className="text-[7px] font-black text-white/50 uppercase leading-none mb-1">{d.weekday}</span>
                                <span className="text-base font-bold text-white tracking-tighter">{d.date.split('/')[1]}</span>
                              </div>
                              <div className="flex-1 font-bold text-[13px]">{d.title}</div>
                              <div className="flex flex-col items-end gap-0.5 pr-1 border-l pl-3 border-[#F3EFE0]">
                                 {weather.icon}<span className="text-[10px] font-bold text-[#5D4037]">{weather.temp}</span>
                              </div>
                              {isExpanded ? <ChevronUp size={16} /> : <ChevronDown size={16} />}
                            </button>
                            {isExpanded && (
                              <div className="px-5 pb-5 space-y-4 border-t pt-4">
                                 {i === 1 && (
                                   <button onClick={() => setSelectedOverlay(usjMapData)} className="w-full bg-[#5D4037] text-white py-3 rounded-xl flex items-center justify-center gap-2 shadow-md mb-4 text-[#FFFFFF]">
                                      <MapIcon size={14} /><span className="text-[10px] font-black uppercase tracking-widest text-[#FFFFFF]">æŸ¥çœ‹ç’°çƒå½±åŸåœ°åœ–</span>
                                   </button>
                                 )}
                                 {sortedTrips.map(trip => (
                                   <div key={trip.id} className="flex gap-4 relative">
                                      <span className="text-[9px] font-black py-1 h-5 min-w-[38px] bg-[#FAF9F6] border border-[#EAE3D2] text-center rounded shadow-xs">{trip.startTime}</span>
                                      <div className="flex-1">
                                         <p className="text-[11px] font-bold">{trip.name}</p>
                                         <p className="text-[8px] opacity-40 uppercase font-black truncate max-w-[150px]"><MapPin size={7}/> {trip.address}</p>
                                         {trip.note && <p className="text-[10px] text-[#8E7D6A] bg-[#FAF9F6] p-2 border-l-2 border-[#D6C5A0] mt-2 whitespace-pre-wrap leading-relaxed shadow-inner font-medium">{trip.note}</p>}
                                      </div>
                                   </div>
                                 ))}
                              </div>
                            )}
                          </div>
                        </div>
                      );
                    })}
                  </div>
                )}

                {currentTab === 'expenses' && (
                  <div className="space-y-4 pb-12 px-1 text-[#4A3728] pt-2">
                     <div className="bg-[#5D4037] p-6 rounded-[2.5rem] shadow-xl text-white text-center border border-white/5 text-[#FFFFFF]">
                        <p className="text-[7px] font-black uppercase tracking-[0.4em] opacity-40 mb-1">Accumulated Balance (Â¥)</p>
                        <h2 className="text-4xl font-bold tracking-tighter mb-6">Â¥{financeCalc.cumulative.toLocaleString()}</h2>
                        <div className="grid grid-cols-2 gap-4 border-t border-white/10 pt-4 px-2">
                           <div className="text-left"><p className="text-[7px] opacity-40 uppercase mb-1 font-black">Today Inc.</p><p className="text-sm font-bold text-green-300">Â¥{(financeCalc.inc || 0).toLocaleString()}</p></div>
                           <div className="text-right border-l border-white/10"><p className="text-[7px] opacity-40 uppercase mb-1 font-black">Today Exp.</p><p className="text-sm font-bold text-red-300">Â¥{(financeCalc.exp || 0).toLocaleString()}</p></div>
                        </div>
                     </div>
                     <div className="bg-white border p-5 rounded-[2rem] shadow-sm border-[#EAE3D2]">
                        <div className="flex gap-2 mb-4 bg-[#F3EFE0] p-1 rounded-xl">
                           <button onClick={() => setExpType('expense')} className={`flex-1 py-1.5 text-[9px] font-black rounded-lg transition-all ${expType === 'expense' ? 'bg-[#5D4037] text-white shadow-md' : 'text-[#8E7D6A]'}`}>æ”¯å‡º</button>
                           <button onClick={() => setExpType('income')} className={`flex-1 py-1.5 text-[9px] font-black rounded-lg transition-all ${expType === 'income' ? 'bg-[#D6C5A0] text-[#4A3728] shadow-md' : 'text-[#8E7D6A]'}`}>æ”¶å…¥</button>
                        </div>
                        <div className="grid grid-cols-5 gap-2 mb-5">
                           {accountingCategories[expType].map(cat => (
                             <button key={cat.name} onClick={() => setExpCategory(cat.name)} className={`flex flex-col items-center gap-2 py-2.5 rounded-xl border transition-all ${expCategory === cat.name ? 'bg-[#F5F2E9] border-[#5D4037] text-[#5D4037]' : 'bg-white border-[#EEEAE0] text-[#A69076] opacity-60'}`}>
                                {cat.icon}<span className="text-[8px] font-black">{cat.name}</span>
                             </button>
                           ))}
                        </div>
                        <form onSubmit={handleAddExpense} className="space-y-4">
                           <input value={expRawAmount} onChange={e => setExpRawAmount(e.target.value)} placeholder="é‡‘é¡ (æ”¯æ´ 100+10)" className="w-full bg-[#FAF9F6] border border-[#EAE3D2] rounded-xl text-[11px] px-4 py-3.5 outline-none font-mono" />
                           <div className="flex gap-2">
                              <input value={expDesc} onChange={e => setExpDesc(e.target.value)} placeholder="å‚™è¨»å…§å®¹..." className="flex-1 bg-[#FAF9F6] border border-[#EAE3D2] rounded-xl text-[11px] px-4 py-3.5 outline-none" />
                              <button type="submit" className="bg-[#5D4037] text-white px-5 rounded-xl shadow-lg text-[#FFFFFF]"><Check size={18} /></button>
                           </div>
                        </form>
                     </div>
                     <div className="space-y-2 mt-4">
                        {expenses.filter(e => e.date === selectedAccDate).map(exp => (
                           <div key={exp.id} className="flex items-center justify-between bg-white p-4 rounded-2xl shadow-xs">
                              <div className="flex items-center gap-3">
                                 <div className={`w-9 h-9 rounded-full flex items-center justify-center ${exp.type === 'income' ? 'bg-green-50 text-green-600' : 'bg-red-50 text-red-600'}`}>
                                    {accountingCategories[exp.type === 'income' ? 'income' : 'expense'].find(c => c.name === exp.category)?.icon || <MoreHorizontal size={12}/>}
                                 </div>
                                 <div><p className="text-[12px] font-bold">{exp.description}</p><p className="text-[8px] font-bold text-[#A69076] mt-0.5 uppercase tracking-tighter">{exp.payer} â€¢ {exp.category}</p></div>
                              </div>
                              <span className={`text-[13px] font-black ${exp.type === 'income' ? 'text-green-600' : 'text-[#5D4037]'}`}>Â¥{exp.amount?.toLocaleString()}</span>
                           </div>
                        ))}
                     </div>
                  </div>
                )}
                {/* ä½å®¿èˆ‡è³¼ç‰© Tab çœç•¥å…¶é¤˜ä»‹é¢ (é€»è¾‘å·²ä¿ç•™) */}
              </main>
            </div>

            <nav className="shrink-0 bg-white border-t border-[#EAE3D2] flex z-40 shadow-sm px-1 h-14 items-center">
               <NavIconButton active={currentTab === 'itinerary'} onClick={() => setCurrentTab('itinerary')} icon={<Layout size={16}/>} label="è¡Œç¨‹" />
               <NavIconButton active={currentTab === 'tickets'} onClick={() => setCurrentTab('tickets')} icon={<Ticket size={16}/>} label="ç¥¨åˆ¸" />
               <NavIconButton active={currentTab === 'expenses'} onClick={() => setCurrentTab('expenses')} icon={<Wallet size={16}/>} label="è¨˜å¸³" />
               <NavIconButton active={currentTab === 'stay'} onClick={() => setCurrentTab('stay')} icon={<Hotel size={16}/>} label="ä½å®¿" />
               <NavIconButton active={currentTab === 'shopping'} onClick={() => setCurrentTab('shopping')} icon={<ShoppingBag size={16}/>} label="è³¼ç‰©" />
            </nav>
          </div>
        </div>
      );
    }

    const NavIconButton = ({ active, onClick, icon, label }) => (
      <button onClick={onClick} className={`flex-1 flex flex-col items-center justify-center gap-0.5 h-full transition-all duration-300 relative ${active ? 'text-[#5D4037]' : 'text-[#8E7D6A] opacity-60'}`}>
        {icon}<span className="text-[8px] font-black tracking-tighter uppercase">{label}</span>
      </button>
    );

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>